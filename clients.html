<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGENCY CN | NEON TRACKER</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: #0a0a0f;
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-green: #00ff9d;
            --neon-purple: #bc13fe;
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
            --border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 243, 255, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(188, 19, 254, 0.03) 0%, transparent 20%);
        }

        /* --- HEADER & CONTROLS --- */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-bottom: 20px;
        }

        .logo {
            font-family: 'Rajdhani', sans-serif;
            font-size: 2rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }
        .logo span { color: var(--neon-blue); }

        .filters-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            background: var(--bg-panel);
            padding: 15px;
            border-radius: 12px;
            border: var(--border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        select, input[type="date"] {
            background: #13131a;
            color: white;
            border: 1px solid #2d2d3a;
            padding: 10px 15px;
            border-radius: 6px;
            font-family: 'Outfit', sans-serif;
            outline: none;
            transition: all 0.3s;
        }

        select:focus, input:focus {
            border-color: var(--neon-blue);
            box-shadow: 0 0 8px rgba(0, 243, 255, 0.2);
        }

        /* --- LOADING BAR --- */
        #progress-container {
            width: 100%;
            height: 4px;
            background: #1a1a1a;
            margin-top: 10px;
            display: none;
            position: relative;
            overflow: hidden;
        }
        #progress-bar {
            height: 100%;
            background: var(--neon-blue);
            width: 0%;
            transition: width 0.3s;
            box-shadow: 0 0 10px var(--neon-blue);
        }

        /* --- KPI GRID --- */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: rgba(16, 16, 22, 0.6);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 20px;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s;
        }

        .kpi-card:hover { transform: translateY(-3px); }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; width: 4px; height: 100%;
            background: var(--card-color, #fff);
            box-shadow: 0 0 10px var(--card-color);
        }

        .kpi-title { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; display: flex; align-items: center; gap: 8px; }
        .kpi-value { font-size: 1.8rem; font-weight: 700; color: #fff; font-family: 'Rajdhani', sans-serif; }
        .kpi-sub { font-size: 0.8rem; color: var(--text-muted); margin-top: 5px; }

        /* --- CHARTS & TABLES --- */
        .dashboard-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 900px) { .dashboard-row { grid-template-columns: 1fr; } }

        .panel {
            background: var(--bg-panel);
            border: var(--border);
            border-radius: 12px;
            padding: 20px;
        }

        .panel-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .panel-title { font-weight: 600; color: var(--neon-blue); text-transform: uppercase; letter-spacing: 1px; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #050505; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--neon-blue); }

        /* KPI COLORS */
        .glow-blue { --card-color: var(--neon-blue); }
        .glow-pink { --card-color: var(--neon-pink); }
        .glow-green { --card-color: var(--neon-green); }
        .glow-purple { --card-color: var(--neon-purple); }

    </style>
</head>
<body>

    <div class="header">
        <div class="logo">AGENCY <span>CN</span></div>
        <div id="status-badge" style="font-size: 0.9rem; color: var(--neon-green);">● Sistema Listo</div>
    </div>

    <div class="filters-bar">
        
        <div class="filter-group">
            <label><i class="ph ph-calendar"></i> Rango de Fecha</label>
            <select id="dateRange" onchange="toggleCustomDate()">
                <option value="today">Hoy</option>
                <option value="yesterday">Ayer</option>
                <option value="last7">Últimos 7 días</option>
                <option value="last30">Últimos 30 días</option>
                <option value="thisMonth" selected>Este Mes</option>
                <option value="all">Histórico Completo</option>
                <option value="custom">Personalizado</option>
            </select>
        </div>

        <div class="filter-group" id="customDateGroup" style="display:none; flex-direction: row; gap: 5px;">
            <input type="date" id="startDate">
            <input type="date" id="endDate">
        </div>

        <div class="filter-group">
            <label><i class="ph ph-users"></i> Trafficker</label>
            <select id="traffickerSelect">
                <option value="all">Todos</option>
                <option value="Wilson">Wilson</option>
                <option value="Eduardo">Eduardo</option>
            </select>
        </div>

        <div class="filter-group">
            <label><i class="ph ph-user-circle"></i> Cliente</label>
            <select id="clientSelect">
                <option value="all">Todos los Clientes</option>
                </select>
        </div>

        <div class="filter-group" style="justify-content: flex-end;">
            <button onclick="applyFilters()" style="background: var(--neon-blue); color: black; border: none; padding: 10px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; text-transform: uppercase;">
                Aplicar Filtros
            </button>
        </div>
    </div>

    <div id="progress-container">
        <div id="progress-bar"></div>
    </div>

    <br>

    <div class="kpi-grid">
        <div class="kpi-card glow-blue">
            <div class="kpi-title"><i class="ph ph-currency-dollar"></i> REVENUE (Ingresos)</div>
            <div class="kpi-value" id="kpi-revenue">$0.00</div>
        </div>
        <div class="kpi-card glow-pink">
            <div class="kpi-title"><i class="ph ph-wallet"></i> SPEND (Inversión)</div>
            <div class="kpi-value" id="kpi-spend">$0.00</div>
        </div>
        <div class="kpi-card glow-green">
            <div class="kpi-title"><i class="ph ph-chart-line-up"></i> ROAS</div>
            <div class="kpi-value" id="kpi-roas">0.00x</div>
        </div>
        <div class="kpi-card glow-purple">
            <div class="kpi-title"><i class="ph ph-shopping-cart"></i> VENTAS</div>
            <div class="kpi-value" id="kpi-sales">0</div>
        </div>
        
        <div class="kpi-card" style="--card-color: #555;">
            <div class="kpi-title">Clics (Enlace)</div>
            <div class="kpi-value" id="kpi-clicks">0</div>
            <div class="kpi-sub" id="kpi-ctr">CTR: 0.00%</div>
        </div>
        <div class="kpi-card" style="--card-color: #555;">
            <div class="kpi-title">Landing Views</div>
            <div class="kpi-value" id="kpi-views">0</div>
        </div>
        <div class="kpi-card" style="--card-color: #555;">
            <div class="kpi-title">Checkouts</div>
            <div class="kpi-value" id="kpi-checkouts">0</div>
        </div>
    </div>

    <div class="dashboard-row">
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Tendencia de Ingresos vs Gasto</div>
            </div>
            <div style="height: 300px; width: 100%;">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-header">
                <div class="panel-title">Top Performance</div>
            </div>
            <div style="height: 300px; width: 100%;">
                <canvas id="doughnutChart"></canvas>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // 1. CONFIGURACIÓN (TUS LINKS ACTUALIZADOS)
    // ==========================================
    const MASTERS = [
        { name: "Wilson", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ7Bu502uunh1jNrhwtlnTydouE42S1Y_6AbvVP5zjb4M263P5B3XiTNDqKOMdegB3MKsQ80C2d9w9r/pub?gid=0&single=true&output=csv" },
        { name: "Eduardo", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSHssz65lYXBPdRoDP3JX6Cpx0NtYAXmL8ihteILfIN_knTx3hNe2CbK14F84gGy2WKjeRakEIzKl-l/pub?gid=0&single=true&output=csv" }
    ];

    // COLUMNAS ESTÁNDAR (Protocolo de Unificación)
    const MAP = {
        date: "Day", 
        revenue: "Purchases conversion value",
        spend: "Amount spent",
        sales: "Purchases",
        checkouts: "Checkouts Initiated",
        views: "Landing page views",
        clicks: "Link clicks",
        ctr: "CTR (link click-through rate)",
        cpm: "CPM (cost per 1,000 impressions)",
        reach: "Reach"
    };

    // ==========================================
    // 2. LÓGICA DEL SISTEMA
    // ==========================================
    let RAW_DATA = [];
    let FILTERED_DATA = [];
    let mainChartInstance = null;
    let pieChartInstance = null;

    // Inicializar
    window.onload = async () => {
        setDefaults();
        await loadSystem();
    };

    function setDefaults() {
        // Establecer fechas por defecto para input custom
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
        document.getElementById('startDate').value = today;
    }

    async function loadSystem() {
        const statusEl = document.getElementById('status-badge');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        
        statusEl.innerText = "⏳ Conectando Nodos...";
        statusEl.style.color = "var(--neon-blue)";
        progressContainer.style.display = "block";

        try {
            // 1. Obtener lista de clientes de los Maestros
            let clients = [];
            for (let m of MASTERS) {
                const data = await fetchCSV(m.url);
                const valid = data
                    .filter(r => r['Link_CSV_Data'] && r['Link_CSV_Data'].includes('http'))
                    .map(r => ({ ...r, _owner: m.name }));
                clients = clients.concat(valid);
            }

            // Llenar el dropdown de clientes
            populateClientDropdown(clients);

            // 2. Descargar data de cada cliente
            let totalProcessed = 0;
            const promises = clients.map(async (client) => {
                try {
                    const raw = await fetchCSV(client['Link_CSV_Data']);
                    
                    // Actualizar barra de carga visualmente
                    totalProcessed++;
                    const percent = (totalProcessed / clients.length) * 100;
                    progressBar.style.width = percent + "%";

                    return raw.map(r => ({
                        trafficker: client._owner,
                        client: client['Cliente'],
                        // Parseo de Datos
                        date: parseDate(r[MAP.date]),
                        revenue: cleanNum(r[MAP.revenue]),
                        spend: cleanNum(r[MAP.spend]),
                        sales: cleanNum(r[MAP.sales]),
                        clicks: cleanNum(r[MAP.clicks]),
                        ctr: cleanNum(r[MAP.ctr]),
                        views: cleanNum(r[MAP.views]),
                        checkouts: cleanNum(r[MAP.checkouts])
                    })).filter(d => d.date); // Eliminar fechas invalidas
                } catch (e) {
                    console.warn(`Error leyendo ${client['Cliente']}`);
                    return [];
                }
            });

            const results = await Promise.all(promises);
            RAW_DATA = results.flat();

            statusEl.innerText = "● ONLINE";
            statusEl.style.color = "var(--neon-green)";
            setTimeout(() => progressContainer.style.display = 'none', 500);

            applyFilters(); // Renderizar primera vista

        } catch (err) {
            statusEl.innerText = "❌ ERROR DE CONEXIÓN";
            statusEl.style.color = "red";
            console.error(err);
            alert("Error: Revisa la consola (F12). Asegúrate que las hojas de los clientes estén publicadas.");
        }
    }

    // ==========================================
    // 3. FILTRADO INTELIGENTE
    // ==========================================
    function applyFilters() {
        const trafficker = document.getElementById('traffickerSelect').value;
        const client = document.getElementById('clientSelect').value;
        const range = document.getElementById('dateRange').value;

        // 1. Filtro de Entidades
        let data = RAW_DATA.filter(row => {
            const matchTraf = (trafficker === 'all') || (row.trafficker === trafficker);
            const matchClient = (client === 'all') || (row.client === client);
            return matchTraf && matchClient;
        });

        // 2. Filtro de Fechas
        const { start, end } = getDateRangeDates(range);
        data = data.filter(row => {
            const d = new Date(row.date);
            return d >= start && d <= end;
        });

        FILTERED_DATA = data;
        updateDashboard();
    }

    // ==========================================
    // 4. RENDERIZADO (KPIs y Gráficas)
    // ==========================================
    function updateDashboard() {
        // Calcular Totales
        const kpis = FILTERED_DATA.reduce((acc, r) => {
            acc.rev += r.revenue;
            acc.spend += r.spend;
            acc.sales += r.sales;
            acc.clicks += r.clicks;
            acc.views += r.views;
            acc.checkouts += r.checkouts;
            return acc;
        }, { rev:0, spend:0, sales:0, clicks:0, views:0, checkouts:0 });

        // Calcular Derivados
        const roas = kpis.spend > 0 ? (kpis.rev / kpis.spend) : 0;
        const ctr = kpis.clicks > 0 ? (FILTERED_DATA.reduce((acc, r) => acc + r.ctr, 0) / FILTERED_DATA.length) : 0; // Promedio simple para demo

        // Pintar HTML
        document.getElementById('kpi-revenue').innerText = formatMoney(kpis.rev);
        document.getElementById('kpi-spend').innerText = formatMoney(kpis.spend);
        document.getElementById('kpi-sales').innerText = kpis.sales;
        document.getElementById('kpi-roas').innerText = roas.toFixed(2) + "x";
        
        // Color Dinámico del ROAS
        const roasEl = document.getElementById('kpi-roas');
        roasEl.style.color = roas >= 2 ? 'var(--neon-green)' : (roas < 1 ? '#ff4444' : 'white');

        document.getElementById('kpi-clicks').innerText = kpis.clicks.toLocaleString();
        document.getElementById('kpi-ctr').innerText = "CTR: " + ctr.toFixed(2) + "%";
        document.getElementById('kpi-views').innerText = kpis.views.toLocaleString();
        document.getElementById('kpi-checkouts').innerText = kpis.checkouts.toLocaleString();

        renderCharts();
    }

    function renderCharts() {
        const ctxMain = document.getElementById('mainChart').getContext('2d');
        const ctxPie = document.getElementById('doughnutChart').getContext('2d');

        // Destruir anteriores si existen
        if (mainChartInstance) mainChartInstance.destroy();
        if (pieChartInstance) pieChartInstance.destroy();

        // Agrupar datos por fecha para el gráfico lineal
        const timeline = {};
        FILTERED_DATA.forEach(r => {
            if (!timeline[r.date]) timeline[r.date] = { rev: 0, spend: 0 };
            timeline[r.date].rev += r.revenue;
            timeline[r.date].spend += r.spend;
        });
        
        // Ordenar fechas
        const sortedDates = Object.keys(timeline).sort();

        // 1. Gráfico Principal (Lineas Neon)
        mainChartInstance = new Chart(ctxMain, {
            type: 'line',
            data: {
                labels: sortedDates,
                datasets: [
                    {
                        label: 'Ingresos',
                        data: sortedDates.map(d => timeline[d].rev),
                        borderColor: '#00f3ff',
                        backgroundColor: 'rgba(0, 243, 255, 0.1)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    },
                    {
                        label: 'Gasto',
                        data: sortedDates.map(d => timeline[d].spend),
                        borderColor: '#ff00ff',
                        backgroundColor: 'rgba(255, 0, 255, 0.05)',
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { labels: { color: 'white' } } },
                scales: {
                    y: { grid: { color: '#222' }, ticks: { color: '#888' } },
                    x: { grid: { display: false }, ticks: { color: '#888' } }
                }
            }
        });

        // 2. Gráfico Dona (Por Trafficker o Cliente)
        // Si hay mas de un trafficker seleccionado, comparamos traffickers. Si no, clientes top.
        const groupKey = document.getElementById('traffickerSelect').value === 'all' ? 'trafficker' : 'client';
        const pieData = {};
        FILTERED_DATA.forEach(r => {
            const key = r[groupKey];
            if (!pieData[key]) pieData[key] = 0;
            pieData[key] += r.revenue;
        });

        pieChartInstance = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: Object.keys(pieData),
                datasets: [{
                    data: Object.values(pieData),
                    backgroundColor: ['#00f3ff', '#ff00ff', '#00ff9d', '#bc13fe', '#ffe600'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { position: 'right', labels: { color: 'white' } } }
            }
        });
    }

    // ==========================================
    // 5. UTILS (Limpieza y Fechas)
    // ==========================================
    
    function toggleCustomDate() {
        const val = document.getElementById('dateRange').value;
        document.getElementById('customDateGroup').style.display = val === 'custom' ? 'flex' : 'none';
    }

    function populateClientDropdown(clients) {
        const sel = document.getElementById('clientSelect');
        // Ordenar alfabéticamente y únicos
        const unique = [...new Set(clients.map(c => c['Cliente']))].sort();
        unique.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.innerText = c;
            sel.appendChild(opt);
        });
    }

    function getDateRangeDates(rangeType) {
        const end = new Date();
        const start = new Date();
        
        // Ajuste de Zona Horaria (Simple)
        end.setHours(23,59,59,999);
        start.setHours(0,0,0,0);

        if (rangeType === 'today') {
            // Start is already today 00:00
        } else if (rangeType === 'yesterday') {
            start.setDate(start.getDate() - 1);
            end.setDate(end.getDate() - 1);
        } else if (rangeType === 'last7') {
            start.setDate(start.getDate() - 7);
        } else if (rangeType === 'last30') {
            start.setDate(start.getDate() - 30);
        } else if (rangeType === 'thisMonth') {
            start.setDate(1);
        } else if (rangeType === 'all') {
            start.setFullYear(2020);
        } else if (rangeType === 'custom') {
            const sVal = document.getElementById('startDate').value;
            const eVal = document.getElementById('endDate').value;
            return { 
                start: sVal ? new Date(sVal + "T00:00:00") : new Date(2020,0,1), 
                end: eVal ? new Date(eVal + "T23:59:59") : new Date() 
            };
        }
        return { start, end };
    }

    function parseDate(dateStr) {
        if (!dateStr) return null;
        // Intentar formato estándar YYYY-MM-DD
        let d = new Date(dateStr);
        if (!isNaN(d)) return d.toISOString().split('T')[0];
        
        // Intentar formato SyncWith M/D/YYYY
        const parts = dateStr.split('/');
        if (parts.length === 3) {
            // Asumiendo MDY
            return new Date(parts[2], parts[0]-1, parts[1]).toISOString().split('T')[0];
        }
        return null;
    }

    function cleanNum(val) {
        if (!val) return 0;
        let str = val.toString();
        // Eliminar símbolos de moneda y porcentaje
        str = str.replace(/[$,%]/g, '');
        return parseFloat(str) || 0;
    }

    function formatMoney(amount) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    }

    function fetchCSV(url) {
        return new Promise((resolve, reject) => {
            Papa.parse(url, {
                download: true,
                header: true,
                skipEmptyLines: true,
                complete: (res) => resolve(res.data),
                error: (err) => reject(err)
            });
        });
    }

</script>
</body>
</html>
