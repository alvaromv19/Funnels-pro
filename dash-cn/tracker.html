<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AGENCY CN | NEON TRACKER V2</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: #0a0a0f;
            --neon-blue: #00f3ff;
            --neon-pink: #ff00ff;
            --neon-green: #00ff9d;
            --neon-purple: #bc13fe;
            --neon-orange: #ff7300;
            --text-main: #ffffff;
            --text-muted: #8b9bb4;
            --border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(0, 243, 255, 0.03) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(188, 19, 254, 0.03) 0%, transparent 20%);
        }

        /* --- HEADER & CONTROLS --- */
        .header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px;
        }

        .logo {
            font-family: 'Rajdhani', sans-serif; font-size: 2rem; font-weight: 700;
            letter-spacing: 2px; text-shadow: 0 0 10px rgba(0, 243, 255, 0.5);
        }
        .logo span { color: var(--neon-blue); }

        .filters-bar {
            display: flex; gap: 15px; flex-wrap: wrap; background: var(--bg-panel);
            padding: 15px; border-radius: 12px; border: var(--border); margin-bottom: 25px;
        }

        .filter-group { display: flex; flex-direction: column; gap: 5px; flex: 1; min-width: 150px; }
        .filter-group label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        
        select, input[type="date"] {
            background: #13131a; color: white; border: 1px solid #2d2d3a;
            padding: 10px; border-radius: 6px; font-family: 'Outfit', sans-serif; outline: none;
            color-scheme: dark;
        }
        select:focus, input:focus { border-color: var(--neon-blue); box-shadow: 0 0 8px rgba(0, 243, 255, 0.2); }

        /* --- KPI GRID --- */
        .kpi-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;
        }

        .kpi-card {
            background: rgba(16, 16, 22, 0.6); border: 1px solid rgba(255, 255, 255, 0.05);
            padding: 20px; border-radius: 12px; position: relative; overflow: hidden;
        }
        .kpi-card::before {
            content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%;
            background: var(--card-color, #fff); box-shadow: 0 0 10px var(--card-color);
        }

        .kpi-title { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 5px; }
        .kpi-value { font-size: 1.8rem; font-weight: 700; color: #fff; font-family: 'Rajdhani', sans-serif; }
        .kpi-sub { font-size: 0.8rem; margin-top: 5px; color: var(--text-muted); }
        .text-green { color: var(--neon-green); }
        .text-red { color: var(--alert-red, #ff4444); }

        /* KPI COLORS */
        .glow-blue { --card-color: var(--neon-blue); }
        .glow-pink { --card-color: var(--neon-pink); }
        .glow-green { --card-color: var(--neon-green); }
        .glow-purple { --card-color: var(--neon-purple); }
        .glow-orange { --card-color: var(--neon-orange); }

        /* --- LAYOUT PANELS --- */
        .dashboard-row { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 1000px) { .dashboard-row { grid-template-columns: 1fr; } }

        .panel { background: var(--bg-panel); border: var(--border); border-radius: 12px; padding: 20px; }
        .panel-title { font-weight: 600; color: var(--neon-blue); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 15px; }

        /* --- FUNNEL UI --- */
        .funnel-container { display: flex; flex-direction: column; gap: 10px; }
        .funnel-step { 
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05);
            padding: 12px 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center;
        }
        .funnel-step-name { font-size: 0.9rem; color: var(--text-muted); }
        .funnel-step-value { font-size: 1.2rem; font-weight: bold; font-family: 'Rajdhani'; }
        .funnel-drop { font-size: 0.8rem; color: var(--neon-pink); text-align: right; margin-top: -5px; margin-bottom: 5px; padding-right: 15px;}

        /* --- DATA TABLE --- */
        .data-table-wrapper { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; text-align: left; font-size: 0.9rem; }
        th { color: var(--text-muted); padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 400; text-transform: uppercase; font-size: 0.8rem;}
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        tr:hover td { background: rgba(255,255,255,0.02); }

    </style>
</head>
<body>

    <div class="header">
        <div class="logo">AGENCY <span>CN</span></div>
        <div id="status-badge" style="font-size: 0.9rem; color: var(--neon-green);">● Sistema En Línea</div>
    </div>

    <div class="filters-bar">
        <div class="filter-group">
            <label><i class="ph ph-calendar"></i> Fecha</label>
            <select id="dateRange" onchange="toggleCustomDate()">
                <option value="today">Hoy</option>
                <option value="yesterday">Ayer</option>
                <option value="last7">Últimos 7 días</option>
                <option value="thisMonth" selected>Este Mes</option>
                <option value="lastMonth">Mes Pasado</option>
                <option value="all">Histórico Completo</option>
                <option value="custom">Personalizado</option>
            </select>
        </div>

        <div class="filter-group" id="customDateGroup" style="display:none; flex-direction: row; gap: 5px; flex: 2;">
            <input type="date" id="startDate" style="width: 50%;">
            <input type="date" id="endDate" style="width: 50%;">
        </div>

        <div class="filter-group">
            <label><i class="ph ph-users"></i> Trafficker</label>
            <select id="traffickerSelect">
                <option value="all">Todos los Traffickers</option>
            </select>
        </div>

        <div class="filter-group">
            <label><i class="ph ph-user-circle"></i> Cliente</label>
            <select id="clientSelect">
                <option value="all">Todos los Clientes</option>
            </select>
        </div>

        <div class="filter-group" style="flex: 0.5;">
            <label>&nbsp;</label>
            <button onclick="applyFilters()" style="background: var(--neon-blue); color: black; border: none; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%;">
                FILTRAR
            </button>
        </div>
    </div>

    <div class="kpi-grid">
        <div class="kpi-card glow-blue">
            <div class="kpi-title">REVENUE (Ingresos)</div>
            <div class="kpi-value" id="kpi-revenue">$0.00</div>
            <div class="kpi-sub" id="kpi-roas">ROAS: 0.00x</div>
        </div>
        <div class="kpi-card glow-pink">
            <div class="kpi-title">SPEND (Inversión)</div>
            <div class="kpi-value" id="kpi-spend">$0.00</div>
        </div>
        <div class="kpi-card glow-green">
            <div class="kpi-title">CPA (Costo x Compra)</div>
            <div class="kpi-value" id="kpi-cpa">$0.00</div>
            <div class="kpi-sub" id="kpi-sales">0 Compras</div>
        </div>
        <div class="kpi-card glow-orange">
            <div class="kpi-title">Costo x Checkout</div>
            <div class="kpi-value" id="kpi-cpc">$0.00</div>
            <div class="kpi-sub" id="kpi-checkouts">0 Checkouts</div>
        </div>
        <div class="kpi-card glow-purple">
            <div class="kpi-title">Costo x Visita</div>
            <div class="kpi-value" id="kpi-cpv">$0.00</div>
            <div class="kpi-sub" id="kpi-views">0 Visitas</div>
        </div>
    </div>

    <div class="dashboard-row">
        <div class="panel">
            <div class="panel-title">Ingresos vs Inversión en el Tiempo</div>
            <div style="height: 320px; width: 100%;">
                <canvas id="mainChart"></canvas>
            </div>
        </div>
        
        <div class="panel">
            <div class="panel-title">Embudo de Conversión</div>
            <div class="funnel-container">
                <div class="funnel-step" style="border-left: 4px solid #8b9bb4;">
                    <div class="funnel-step-name">1. Clics (Enlace)</div>
                    <div class="funnel-step-value" id="funnel-clicks">0</div>
                </div>
                <div class="funnel-drop" id="drop-1">↳ 0% llegaron a la web</div>

                <div class="funnel-step" style="border-left: 4px solid var(--neon-purple);">
                    <div class="funnel-step-name">2. Visitas (Landing)</div>
                    <div class="funnel-step-value" id="funnel-views">0</div>
                </div>
                <div class="funnel-drop" id="drop-2">↳ 0% iniciaron pago</div>

                <div class="funnel-step" style="border-left: 4px solid var(--neon-orange);">
                    <div class="funnel-step-name">3. Pagos Iniciados</div>
                    <div class="funnel-step-value" id="funnel-checkouts">0</div>
                </div>
                <div class="funnel-drop" id="drop-3">↳ 0% finalizaron compra</div>

                <div class="funnel-step" style="border-left: 4px solid var(--neon-green);">
                    <div class="funnel-step-name">4. Compras (Sales)</div>
                    <div class="funnel-step-value" id="funnel-sales">0</div>
                </div>
            </div>
            
            <div style="margin-top: 20px; text-align: center; font-size: 0.85rem; color: var(--text-muted);">
                CTR Promedio: <span id="kpi-ctr" style="color: white; font-weight: bold;">0.00%</span>
            </div>
        </div>
    </div>

    <div class="panel">
        <div class="panel-title">Desglose de Rendimiento por Cliente</div>
        <div class="data-table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Cliente</th>
                        <th>Trafficker</th>
                        <th>Inversión</th>
                        <th>Ingresos</th>
                        <th>ROAS</th>
                        <th>CPA</th>
                        <th>Compras</th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    </tbody>
            </table>
        </div>
    </div>

<script>
    // ==========================================
    // 1. EL "CEREBRO": URL DE TU DATA CENTRAL
    // ==========================================
    // ¡REEMPLAZA ESTE LINK POR EL CSV PUBLICADO DE TU PESTAÑA 'Data_Central'!
    const DATA_WAREHOUSE_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTF1NFtvYNl22q6ZYfPcdkR1upw4NEbo1Rv5KLUgKl7n6Pyuj8CU-rQTAXhI6gu_LhdfK-47gpvE43N/pub?gid=0&single=true&output=csv";

    let RAW_DATA = [];
    let FILTERED_DATA = [];
    let mainChartInstance = null;

    // Inicializar
    window.onload = () => {
        setDefaults();
        loadWarehouse();
    };

    function setDefaults() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('endDate').value = today;
        document.getElementById('startDate').value = new Date(new Date().setDate(1)).toISOString().split('T')[0]; // Primero del mes
    }

    function toggleCustomDate() {
        const val = document.getElementById('dateRange').value;
        document.getElementById('customDateGroup').style.display = val === 'custom' ? 'flex' : 'none';
    }

    // ==========================================
    // 2. EXTRACCIÓN Y LIMPIEZA
    // ==========================================
    function loadWarehouse() {
        if(DATA_WAREHOUSE_URL === "AQUI_PEGA_TU_LINK_DEL_CSV_DATA_CENTRAL"){
            document.getElementById('status-badge').innerText = "⚠️ Falta URL del Data Central";
            document.getElementById('status-badge').style.color = "yellow";
            return;
        }

        document.getElementById('status-badge').innerText = "⏳ Descargando Data...";
        
        Papa.parse(DATA_WAREHOUSE_URL, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                // Parsear matemáticamente la base de datos central
                RAW_DATA = results.data.map(row => ({
                    trafficker: row["Trafficker"],
                    client: row["Cliente"],
                    date: parseDate(row["Fecha"]),
                    spend: parseFloat(row["Inversion"]) || 0,
                    revenue: parseFloat(row["Ingresos"]) || 0,
                    sales: parseFloat(row["Compras"]) || 0,
                    checkouts: parseFloat(row["Checkouts"]) || 0,
                    views: parseFloat(row["Visitas"]) || 0,
                    clicks: parseFloat(row["Clics"]) || 0,
                    reach: parseFloat(row["Alcance"]) || 0
                })).filter(r => r.date !== null); // Ignorar filas sin fecha

                populateDropdowns();
                applyFilters();

                document.getElementById('status-badge').innerText = "● Sistema En Línea";
            },
            error: function() {
                document.getElementById('status-badge').innerText = "❌ Error al leer CSV";
                document.getElementById('status-badge').style.color = "red";
            }
        });
    }

    function populateDropdowns() {
        // Traffickers
        const tSelect = document.getElementById('traffickerSelect');
        const traffickers = [...new Set(RAW_DATA.map(r => r.trafficker))].sort();
        traffickers.forEach(t => { if(t) tSelect.innerHTML += `<option value="${t}">${t}</option>`; });

        // Clientes
        const cSelect = document.getElementById('clientSelect');
        const clients = [...new Set(RAW_DATA.map(r => r.client))].sort();
        clients.forEach(c => { if(c) cSelect.innerHTML += `<option value="${c}">${c}</option>`; });
    }

    // ==========================================
    // 3. MOTOR DE FILTROS
    // ==========================================
    function applyFilters() {
        const t = document.getElementById('traffickerSelect').value;
        const c = document.getElementById('clientSelect').value;
        const { start, end } = getDateRange();

        FILTERED_DATA = RAW_DATA.filter(row => {
            const matchT = (t === 'all') || (row.trafficker === t);
            const matchC = (c === 'all') || (row.client === c);
            const rowD = new Date(row.date);
            const matchDate = rowD >= start && rowD <= end;
            
            return matchT && matchC && matchDate;
        });

        updateDashboard();
    }

    function getDateRange() {
        const rangeType = document.getElementById('dateRange').value;
        const end = new Date(); end.setHours(23,59,59,999);
        const start = new Date(); start.setHours(0,0,0,0);

        if (rangeType === 'yesterday') {
            start.setDate(start.getDate() - 1); end.setDate(end.getDate() - 1);
        } else if (rangeType === 'last7') {
            start.setDate(start.getDate() - 7);
        } else if (rangeType === 'thisMonth') {
            start.setDate(1);
        } else if (rangeType === 'lastMonth') {
            start.setMonth(start.getMonth() - 1); start.setDate(1);
            end.setDate(0); // Último día del mes pasado
        } else if (rangeType === 'all') {
            start.setFullYear(2020);
        } else if (rangeType === 'custom') {
            const sVal = document.getElementById('startDate').value;
            const eVal = document.getElementById('endDate').value;
            return { 
                start: sVal ? new Date(sVal + "T00:00:00") : new Date(2020,0,1), 
                end: eVal ? new Date(eVal + "T23:59:59") : new Date() 
            };
        }
        return { start, end };
    }

    // ==========================================
    // 4. MATEMÁTICAS Y RENDERIZADO (KPIs Estratégicos)
    // ==========================================
    function updateDashboard() {
        // Sumatoria global del periodo filtrado
        const kpis = FILTERED_DATA.reduce((acc, r) => {
            acc.rev += r.revenue; acc.spend += r.spend; acc.sales += r.sales;
            acc.checkouts += r.checkouts; acc.views += r.views; 
            acc.clicks += r.clicks; acc.reach += r.reach;
            return acc;
        }, { rev:0, spend:0, sales:0, checkouts:0, views:0, clicks:0, reach:0 });

        // Cálculos de Inteligencia de Negocio (Protegidos contra divisiones por cero)
        const roas = kpis.spend > 0 ? (kpis.rev / kpis.spend) : 0;
        const cpa = kpis.sales > 0 ? (kpis.spend / kpis.sales) : 0;
        const cp_checkout = kpis.checkouts > 0 ? (kpis.spend / kpis.checkouts) : 0;
        const cp_view = kpis.views > 0 ? (kpis.spend / kpis.views) : 0;
        const ctr = kpis.reach > 0 ? ((kpis.clicks / kpis.reach) * 100) : 0;

        // Tasas de Caída (Drop-off rates)
        const rate_click_view = kpis.clicks > 0 ? ((kpis.views / kpis.clicks) * 100) : 0;
        const rate_view_chk = kpis.views > 0 ? ((kpis.checkouts / kpis.views) * 100) : 0;
        const rate_chk_sale = kpis.checkouts > 0 ? ((kpis.sales / kpis.checkouts) * 100) : 0;

        // DOM - Tarjetas Superiores
        document.getElementById('kpi-revenue').innerText = formatMoney(kpis.rev);
        document.getElementById('kpi-spend').innerText = formatMoney(kpis.spend);
        document.getElementById('kpi-cpa').innerText = formatMoney(cpa);
        document.getElementById('kpi-cpc').innerText = formatMoney(cp_checkout);
        document.getElementById('kpi-cpv').innerText = formatMoney(cp_view);
        
        document.getElementById('kpi-sales').innerText = kpis.sales + " Compras";
        document.getElementById('kpi-checkouts').innerText = kpis.checkouts + " Checkouts";
        document.getElementById('kpi-views').innerText = kpis.views + " Visitas";

        // Estilos Condicionales ROAS
        const elRoas = document.getElementById('kpi-roas');
        elRoas.innerText = `ROAS: ${roas.toFixed(2)}x`;
        elRoas.className = roas >= 2.5 ? "kpi-sub text-green" : (roas < 1.5 ? "kpi-sub text-red" : "kpi-sub");

        // DOM - Embudo
        document.getElementById('funnel-clicks').innerText = kpis.clicks.toLocaleString();
        document.getElementById('funnel-views').innerText = kpis.views.toLocaleString();
        document.getElementById('funnel-checkouts').innerText = kpis.checkouts.toLocaleString();
        document.getElementById('funnel-sales').innerText = kpis.sales.toLocaleString();
        
        document.getElementById('drop-1').innerText = `↳ ${rate_click_view.toFixed(1)}% llegaron a la web`;
        document.getElementById('drop-2').innerText = `↳ ${rate_view_chk.toFixed(1)}% iniciaron pago`;
        document.getElementById('drop-3').innerText = `↳ ${rate_chk_sale.toFixed(1)}% finalizaron compra`;
        document.getElementById('kpi-ctr').innerText = ctr.toFixed(2) + "%";

        renderChart();
        renderTable();
    }

    // ==========================================
    // 5. GRÁFICOS Y TABLAS
    // ==========================================
    function renderChart() {
        const ctx = document.getElementById('mainChart').getContext('2d');
        if (mainChartInstance) mainChartInstance.destroy();

        // Agrupar por día
        const timeline = {};
        FILTERED_DATA.forEach(r => {
            if (!timeline[r.date]) timeline[r.date] = { rev: 0, spend: 0 };
            timeline[r.date].rev += r.revenue; timeline[r.date].spend += r.spend;
        });
        
        const sortedDates = Object.keys(timeline).sort();

        mainChartInstance = new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedDates,
                datasets: [
                    {
                        label: 'Ingresos', data: sortedDates.map(d => timeline[d].rev),
                        borderColor: '#00f3ff', backgroundColor: 'rgba(0, 243, 255, 0.1)',
                        borderWidth: 2, tension: 0.4, fill: true
                    },
                    {
                        label: 'Inversión', data: sortedDates.map(d => timeline[d].spend),
                        borderColor: '#ff00ff', backgroundColor: 'rgba(255, 0, 255, 0.05)',
                        borderWidth: 2, tension: 0.4, fill: true
                    }
                ]
            },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { labels: { color: 'white' } } },
                scales: {
                    y: { grid: { color: '#222' }, ticks: { color: '#888' } },
                    x: { grid: { display: false }, ticks: { color: '#888' } }
                }
            }
        });
    }

    function renderTable() {
        const tbody = document.getElementById('table-body');
        tbody.innerHTML = '';

        // Agrupar datos por cliente para el análisis granular
        const clientData = {};
        FILTERED_DATA.forEach(r => {
            if(!clientData[r.client]) {
                clientData[r.client] = { trafficker: r.trafficker, spend: 0, rev: 0, sales: 0 };
            }
            clientData[r.client].spend += r.spend;
            clientData[r.client].rev += r.revenue;
            clientData[r.client].sales += r.sales;
        });

        // Convertir a Array y ordenar por Inversión (Los que más gastan primero)
        const sortedClients = Object.entries(clientData)
            .map(([name, data]) => ({ name, ...data }))
            .sort((a, b) => b.spend - a.spend);

        if(sortedClients.length === 0) {
            tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; color:#888;">No hay datos en este periodo</td></tr>`;
            return;
        }

        sortedClients.forEach(c => {
            const roas = c.spend > 0 ? (c.rev / c.spend) : 0;
            const cpa = c.sales > 0 ? (c.spend / c.sales) : 0;
            
            let roasColor = roas >= 2.5 ? 'var(--neon-green)' : (roas < 1.5 ? 'var(--alert-red, #ff4444)' : 'white');

            tbody.innerHTML += `
                <tr>
                    <td style="font-weight: bold; color: var(--neon-blue);">${c.name}</td>
                    <td style="color: var(--text-muted);">${c.trafficker}</td>
                    <td>${formatMoney(c.spend)}</td>
                    <td>${formatMoney(c.rev)}</td>
                    <td style="color: ${roasColor}; font-weight: bold;">${roas.toFixed(2)}x</td>
                    <td>${formatMoney(cpa)}</td>
                    <td>${c.sales}</td>
                </tr>
            `;
        });
    }

    // Funciones Auxiliares
    function formatMoney(amount) {
        return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    }
    
    function parseDate(dateStr) {
        if (!dateStr) return null;
        let d = new Date(dateStr);
        if (!isNaN(d)) return d.toISOString().split('T')[0];
        
        const parts = dateStr.split(/[\/\-]/);
        if (parts.length === 3) {
            // Intento genérico, SyncWith suele exportar M/D/YYYY o YYYY-MM-DD
            if(parts[0].length === 4) return `${parts[0]}-${parts[1].padStart(2,'0')}-${parts[2].padStart(2,'0')}`;
            return new Date(parts[2], parts[0]-1, parts[1]).toISOString().split('T')[0];
        }
        return null;
    }
</script>
</body>
</html>
