<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ads & Sales Dashboard | Pro Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { background-color: #0f172a; color: #f8fafc; font-family: 'Inter', sans-serif; }
        .card { background-color: #1e293b; border: 1px solid #334155; }
        .table-header { background-color: #334155; color: #94a3b8; cursor: pointer; transition: background 0.2s;}
        .table-header:hover { background-color: #475569; color: #fff;}
        .table-row:hover { background-color: #334155; transition: background-color 0.2s; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        
        /* Modal Styles */
        .modal-bg { background: rgba(15, 23, 42, 0.85); backdrop-filter: blur(4px); }
        .clickable-metric { cursor: pointer; border-bottom: 1px dashed currentcolor; transition: opacity 0.2s; }
        .clickable-metric:hover { opacity: 0.7; }
        
        /* Column Visibility */
        .col-hidden { display: none; }
    </style>
</head>
<body class="p-6 relative">

    <div class="max-w-screen-2xl mx-auto">
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tight">Ads & Sales Analytics</h1>
                <p class="text-slate-400 mt-1">Monitoreo Avanzado, Drill-down y CRM Insights.</p>
            </div>
            <div class="flex flex-wrap items-center gap-3">
                <button onclick="openLeadSearch()" class="bg-purple-600 hover:bg-purple-500 text-white px-4 py-2 rounded shadow font-medium flex items-center gap-2">
                    üîç Buscador de Leads
                </button>
                <button onclick="loadData()" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded shadow font-medium flex items-center gap-2">
                    ‚Üª Actualizar Datos
                </button>
            </div>
        </header>

        <div class="card p-4 rounded-lg mb-6 flex flex-wrap gap-4 items-end justify-between">
            <div class="flex flex-wrap gap-4 items-end">
                <div>
                    <label class="block text-xs text-slate-400 mb-1">Rango de Fechas</label>
                    <select id="dateRange" onchange="handleDateRangeChange()" class="bg-[#0f172a] border border-slate-600 text-white rounded px-3 py-2 focus:outline-none focus:border-blue-500 text-sm">
                        <option value="all">Todo el tiempo</option>
                        <option value="today">Hoy</option>
                        <option value="yesterday">Ayer</option>
                        <option value="7days">√öltimos 7 d√≠as</option>
                        <option value="thisMonth">Este Mes</option>
                        <option value="lastMonth">Mes Pasado</option>
                        <option value="custom">Personalizado...</option>
                    </select>
                </div>
                <div id="customDateContainer" class="hidden flex gap-2 items-end">
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Desde</label>
                        <input type="date" id="dateStart" onchange="processData()" class="bg-[#0f172a] border border-slate-600 text-white rounded px-2 py-1.5 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs text-slate-400 mb-1">Hasta</label>
                        <input type="date" id="dateEnd" onchange="processData()" class="bg-[#0f172a] border border-slate-600 text-white rounded px-2 py-1.5 text-sm">
                    </div>
                </div>

                <div>
                    <label class="block text-xs text-slate-400 mb-1">Buscar Campa√±a/Anuncio</label>
                    <input type="text" id="searchInput" placeholder="Escribe aqu√≠..." class="bg-[#0f172a] border border-slate-600 text-white rounded px-3 py-2 text-sm focus:outline-none focus:border-blue-500" onkeyup="renderCampaignTable()">
                </div>
            </div>

            <div class="relative group">
                <button class="bg-[#0f172a] border border-slate-600 text-slate-300 px-3 py-2 rounded text-sm hover:text-white">
                    ‚öôÔ∏è Configurar Columnas
                </button>
                <div class="absolute right-0 mt-2 w-48 bg-[#1e293b] border border-slate-600 rounded shadow-xl hidden group-hover:block z-10 p-2">
                    <label class="flex items-center gap-2 text-sm text-slate-300 p-1 hover:bg-slate-700 cursor-pointer"><input type="checkbox" checked onchange="toggleCol(2)"> Leads</label>
                    <label class="flex items-center gap-2 text-sm text-slate-300 p-1 hover:bg-slate-700 cursor-pointer"><input type="checkbox" checked onchange="toggleCol(3)"> Calificados</label>
                    <label class="flex items-center gap-2 text-sm text-slate-300 p-1 hover:bg-slate-700 cursor-pointer"><input type="checkbox" checked onchange="toggleCol(4)"> Agendas</label>
                    <label class="flex items-center gap-2 text-sm text-slate-300 p-1 hover:bg-slate-700 cursor-pointer"><input type="checkbox" checked onchange="toggleCol(5)"> Asistieron</label>
                    <label class="flex items-center gap-2 text-sm text-slate-300 p-1 hover:bg-slate-700 cursor-pointer"><input type="checkbox" checked onchange="toggleCol(6)"> Ventas</label>
                    <label class="flex items-center gap-2 text-sm text-slate-300 p-1 hover:bg-slate-700 cursor-pointer"><input type="checkbox" checked onchange="toggleCol(7)"> Ingresos</label>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-5 gap-4 mb-8">
            <div class="card p-5 rounded-lg shadow border-l-4 border-l-slate-400">
                <p class="text-sm text-slate-400 font-semibold mb-1">Total Leads</p><h3 class="text-3xl font-bold text-white" id="kpi-leads">0</h3>
            </div>
            <div class="card p-5 rounded-lg shadow border-l-4 border-l-blue-400">
                <p class="text-sm text-slate-400 font-semibold mb-1">Leads Calificados</p><h3 class="text-3xl font-bold text-blue-400" id="kpi-calificados">0</h3>
            </div>
            <div class="card p-5 rounded-lg shadow border-l-4 border-l-yellow-400">
                <p class="text-sm text-slate-400 font-semibold mb-1">Agendas Asistidas</p><h3 class="text-3xl font-bold text-yellow-400" id="kpi-agendas">0</h3>
            </div>
            <div class="card p-5 rounded-lg shadow border-l-4 border-l-green-400">
                <p class="text-sm text-slate-400 font-semibold mb-1">Ventas Cerradas</p><h3 class="text-3xl font-bold text-green-400" id="kpi-ventas">0</h3>
            </div>
            <div class="card p-5 rounded-lg shadow border-l-4 border-l-emerald-400">
                <p class="text-sm text-slate-400 font-semibold mb-1">Ingresos Generados</p><h3 class="text-3xl font-bold text-emerald-400" id="kpi-ingresos">$0</h3>
            </div>
        </div>

        <div class="mb-8 card rounded-lg overflow-hidden shadow-xl border border-slate-700">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse whitespace-nowrap" id="mainTable">
                    <thead>
                        <tr class="table-header text-xs uppercase tracking-wider select-none">
                            <th class="px-6 py-4 font-semibold" onclick="sortTable('campana')">Campa√±a ‚Üï</th>
                            <th class="px-6 py-4 font-semibold" onclick="sortTable('anuncio')">Anuncio ‚Üï</th>
                            <th class="px-6 py-4 font-semibold text-right col-metric col-2" onclick="sortTable('leads')">Leads ‚Üï</th>
                            <th class="px-6 py-4 font-semibold text-right col-metric col-3" onclick="sortTable('calificados')">Calificados ‚Üï</th>
                            <th class="px-6 py-4 font-semibold text-right col-metric col-4" onclick="sortTable('agendas_total')">Agendas ‚Üï</th>
                            <th class="px-6 py-4 font-semibold text-right col-metric col-5" onclick="sortTable('asistieron')">Asistieron ‚Üï</th>
                            <th class="px-6 py-4 font-semibold text-right col-metric col-6" onclick="sortTable('ventas')">Ventas ‚Üï</th>
                            <th class="px-6 py-4 font-semibold text-right col-metric col-7" onclick="sortTable('ingresos')">Ingresos ‚Üï</th>
                        </tr>
                    </thead>
                    <tbody id="table-campaigns" class="text-sm divide-y divide-slate-700">
                        <tr><td colspan="8" class="text-center py-8 text-slate-400">Cargando datos...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-drilldown" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-50 p-4">
        <div class="bg-[#1e293b] border border-slate-600 rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <div class="flex justify-between items-center p-4 border-b border-slate-700">
                <h3 class="text-xl font-bold text-white" id="modal-title">Detalle de Registros</h3>
                <button onclick="closeModal('modal-drilldown')" class="text-slate-400 hover:text-white text-2xl font-bold">&times;</button>
            </div>
            <div class="p-4 overflow-auto flex-1">
                <table class="w-full text-left border-collapse whitespace-nowrap text-sm">
                    <thead>
                        <tr class="bg-slate-700 text-slate-300">
                            <th class="px-4 py-2">Fecha</th>
                            <th class="px-4 py-2">Nombre</th>
                            <th class="px-4 py-2">Email</th>
                            <th class="px-4 py-2">Tel√©fono</th>
                            <th class="px-4 py-2 text-right">Info Extra</th>
                        </tr>
                    </thead>
                    <tbody id="modal-tbody" class="divide-y divide-slate-700 text-slate-300"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="modal-crm" class="fixed inset-0 modal-bg hidden flex items-center justify-center z-50 p-4">
        <div class="bg-[#0f172a] border border-purple-600 rounded-lg shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col">
            <div class="flex justify-between items-center p-5 border-b border-slate-700 bg-[#1e293b] rounded-t-lg">
                <div class="w-full mr-4 relative">
                    <span class="absolute left-3 top-2.5 text-slate-400">üîç</span>
                    <input type="text" id="crmSearch" placeholder="Busca por Nombre o Email (Ej. juan@gmail.com)..." 
                           class="w-full bg-[#0f172a] border border-purple-500 text-white rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:ring-2 focus:ring-purple-500"
                           onkeyup="searchCRM()">
                </div>
                <button onclick="closeModal('modal-crm')" class="text-slate-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="p-6 overflow-auto flex-1" id="crm-results">
                <div class="text-center text-slate-500 mt-10">
                    <p class="text-lg">Ingresa un correo o nombre arriba.</p>
                    <p class="text-sm mt-2">El sistema buscar√° en Leads, Calificados, Agendas y Ventas para trazar su recorrido.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const URL_LEADS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTjCMjoi7DXiCeBRQdzAQZlx_L6SfpmbLlqmeRgZDHmCEdmN5_grVD_Yqa-5tzNprDS02o98ms80j1x/pub?gid=0&single=true&output=csv';
        const URL_CALIFICADOS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTjCMjoi7DXiCeBRQdzAQZlx_L6SfpmbLlqmeRgZDHmCEdmN5_grVD_Yqa-5tzNprDS02o98ms80j1x/pub?gid=1272057128&single=true&output=csv';
        const URL_AGENDAS = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQuXaPCen61slzpr1TElxXoCROIxAgmgWT7pyWvel1dxq_Z_U1yZPrVrTbJfx9MwaL8_cluY3v2ywoB/pub?gid=0&single=true&output=csv';

        // Almacenamiento Global
        let rawLeads = [], rawCalificados = [], rawAgendas = [];
        let consolidatedCampaigns = [];
        let currentSort = { column: 'ingresos', desc: true };

        function parseCSV(url) {
            return new Promise((resolve, reject) => {
                Papa.parse(url, { download: true, header: true, skipEmptyLines: true,
                    complete: function(results) { resolve(results.data); },
                    error: function(err) { reject(err); }
                });
            });
        }

        // --- MANEJO DE FECHAS ---
        function parseDate(dateStr) {
            if(!dateStr) return null;
            // Soporte para DD/MM/YYYY o DD/MM/YY
            let parts = dateStr.split('/');
            if(parts.length === 3) {
                let d = parseInt(parts[0], 10), m = parseInt(parts[1], 10) - 1, y = parseInt(parts[2], 10);
                if(y < 100) y += 2000;
                return new Date(y, m, d).getTime();
            }
            return new Date(dateStr).getTime();
        }

        function isDateInRange(dateValue, start, end) {
            if(!dateValue) return true; // Si no hay fecha, lo contamos igual
            let t = parseDate(dateValue);
            if(!t) return true;
            if(start && t < start) return false;
            if(end && t > end) return false;
            return true;
        }

        function handleDateRangeChange() {
            const val = document.getElementById('dateRange').value;
            const customCont = document.getElementById('customDateContainer');
            if(val === 'custom') {
                customCont.classList.remove('hidden');
            } else {
                customCont.classList.add('hidden');
                processData(); // Reprocesar de inmediato
            }
        }

        function getTimestampsFromFilter() {
            const val = document.getElementById('dateRange').value;
            let start = null, end = null;
            const now = new Date();
            now.setHours(0,0,0,0);

            if(val === 'today') { start = now.getTime(); end = now.getTime() + 86400000; }
            else if(val === 'yesterday') { start = now.getTime() - 86400000; end = now.getTime(); }
            else if(val === '7days') { start = now.getTime() - (7 * 86400000); }
            else if(val === 'thisMonth') { start = new Date(now.getFullYear(), now.getMonth(), 1).getTime(); }
            else if(val === 'lastMonth') { 
                start = new Date(now.getFullYear(), now.getMonth() - 1, 1).getTime();
                end = new Date(now.getFullYear(), now.getMonth(), 0).getTime() + 86400000;
            }
            else if(val === 'custom') {
                let s = document.getElementById('dateStart').value;
                let e = document.getElementById('dateEnd').value;
                if(s) { let sd = new Date(s); sd.setMinutes(sd.getMinutes() + sd.getTimezoneOffset()); start = sd.getTime(); }
                if(e) { let ed = new Date(e); ed.setMinutes(ed.getMinutes() + ed.getTimezoneOffset()); end = ed.getTime() + 86400000; }
            }
            return {start, end};
        }

        // --- CARGA Y PROCESAMIENTO ---
        async function loadData() {
            document.getElementById('table-campaigns').innerHTML = '<tr><td colspan="8" class="text-center py-8 text-slate-400">Leyendo bases de datos...</td></tr>';
            try {
                const [l, c, a] = await Promise.all([ parseCSV(URL_LEADS), parseCSV(URL_CALIFICADOS), parseCSV(URL_AGENDAS) ]);
                rawLeads = l; rawCalificados = c; rawAgendas = a;
                processData();
            } catch (error) {
                console.error("Error:", error);
                document.getElementById('table-campaigns').innerHTML = '<tr><td colspan="8" class="text-center py-8 text-red-400">Error cargando datos.</td></tr>';
            }
        }

        function processData() {
            let stats = {};
            const {start, end} = getTimestampsFromFilter();

            // Funci√≥n Helper para crear llave
            const getRowDetails = (r) => {
                let camp = (r['Campa√±a (UTM)'] || r['Campa√±a'] || r['Origen Campa√±a'] || 'Desconocida').trim();
                let ad = (r['Ad Content'] || r['Anuncio'] || r['Nombre del Ad'] || 'Desconocido').trim();
                let fecha = r['Fecha Creaci√≥n'] || r['Fecha'] || r['Created'] || '';
                return { key: `${camp}___${ad}`, camp, ad, fecha };
            };

            const initRow = (key, camp, ad) => {
                if(!stats[key]) stats[key] = { campana: camp, anuncio: ad, leads: 0, calificados: 0, agendas_total: 0, asistieron: 0, ventas: 0, ingresos: 0, arr_leads: [], arr_calif: [], arr_agendas: [], arr_ventas: [] };
            };

            // 1. Leads
            rawLeads.forEach(r => {
                let {key, camp, ad, fecha} = getRowDetails(r);
                if(!isDateInRange(fecha, start, end) || (!camp && !ad)) return;
                initRow(key, camp, ad);
                stats[key].leads++;
                stats[key].arr_leads.push(r);
            });

            // 2. Calificados
            rawCalificados.forEach(r => {
                let {key, camp, ad, fecha} = getRowDetails(r);
                if(!isDateInRange(fecha, start, end) || (!camp && !ad)) return;
                initRow(key, camp, ad);
                stats[key].calificados++;
                stats[key].arr_calif.push(r);
            });

            // 3. Agendas / Ventas
            rawAgendas.forEach(r => {
                let {key, camp, ad, fecha} = getRowDetails(r);
                let resultado = (r['Resultado'] || '').trim();
                let monto = parseFloat(r['Monto ($)'] || 0);

                if(!isDateInRange(fecha, start, end) || (!camp && !ad)) return;
                initRow(key, camp, ad);

                stats[key].agendas_total++;
                stats[key].arr_agendas.push(r);

                if(resultado.includes('‚úÖ Venta Cerrada')) {
                    stats[key].ventas++;
                    stats[key].asistieron++;
                    stats[key].ingresos += monto;
                    stats[key].arr_ventas.push(r);
                } else if (!resultado.includes('‚ùå No Show')) {
                    stats[key].asistieron++;
                }
            });

            consolidatedCampaigns = Object.values(stats);
            applySort(); // Ordena y renderiza
        }

        // --- SORTING ---
        function sortTable(column) {
            if(currentSort.column === column) currentSort.desc = !currentSort.desc;
            else { currentSort.column = column; currentSort.desc = true; }
            applySort();
        }

        function applySort() {
            let col = currentSort.column;
            let mult = currentSort.desc ? -1 : 1;
            consolidatedCampaigns.sort((a, b) => {
                let valA = a[col], valB = b[col];
                if(typeof valA === 'string') return valA.localeCompare(valB) * mult;
                return (valA - valB) * mult;
            });
            updateKPIs();
            renderCampaignTable();
        }

        // --- RENDERIZADO ---
        function updateKPIs() {
            let tLeads = 0, tCalif = 0, tAsist = 0, tVentas = 0, tIngresos = 0;
            consolidatedCampaigns.forEach(r => {
                tLeads += r.leads; tCalif += r.calificados; tAsist += r.asistieron; tVentas += r.ventas; tIngresos += r.ingresos;
            });
            document.getElementById('kpi-leads').innerText = tLeads.toLocaleString();
            document.getElementById('kpi-calificados').innerText = tCalif.toLocaleString();
            document.getElementById('kpi-agendas').innerText = tAsist.toLocaleString();
            document.getElementById('kpi-ventas').innerText = tVentas.toLocaleString();
            document.getElementById('kpi-ingresos').innerText = `$${tIngresos.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
        }

        function renderCampaignTable() {
            const tbody = document.getElementById('table-campaigns');
            tbody.innerHTML = '';
            const filterText = document.getElementById('searchInput').value.toLowerCase();

            consolidatedCampaigns.forEach((row, i) => {
                if(filterText && !row.campana.toLowerCase().includes(filterText) && !row.anuncio.toLowerCase().includes(filterText)) return;

                const tr = document.createElement('tr');
                tr.className = 'table-row border-b border-slate-700/50 text-slate-300';
                tr.innerHTML = `
                    <td class="px-6 py-4 font-medium text-white max-w-xs truncate" title="${row.campana}">${row.campana}</td>
                    <td class="px-6 py-4 text-slate-400 max-w-xs truncate" title="${row.anuncio}">${row.anuncio}</td>
                    <td class="px-6 py-4 text-right col-metric col-2"><span class="clickable-metric" onclick="openDrilldown(${i}, 'leads')">${row.leads}</span></td>
                    <td class="px-6 py-4 text-right text-blue-400 font-semibold col-metric col-3"><span class="clickable-metric" onclick="openDrilldown(${i}, 'calificados')">${row.calificados}</span></td>
                    <td class="px-6 py-4 text-right col-metric col-4"><span class="clickable-metric" onclick="openDrilldown(${i}, 'agendas')">${row.agendas_total}</span></td>
                    <td class="px-6 py-4 text-right text-yellow-400 col-metric col-5">${row.asistieron}</td>
                    <td class="px-6 py-4 text-right text-green-400 font-bold col-metric col-6"><span class="clickable-metric" onclick="openDrilldown(${i}, 'ventas')">${row.ventas}</span></td>
                    <td class="px-6 py-4 text-right text-emerald-400 font-bold col-metric col-7">$${row.ingresos.toLocaleString(undefined, {minimumFractionDigits: 2})}</td>
                `;
                tbody.appendChild(tr);
            });
            if(tbody.innerHTML === '') tbody.innerHTML = '<tr><td colspan="8" class="text-center py-8 text-slate-400">Sin resultados.</td></tr>';
        }

        // --- TOGGLE COLUMNS ---
        function toggleCol(colIndex) {
            const cols = document.querySelectorAll(`.col-${colIndex}`);
            cols.forEach(el => el.classList.toggle('col-hidden'));
        }

        // --- DRILL DOWN (Popups al clickear n√∫mero) ---
        function openDrilldown(index, type) {
            let data = consolidatedCampaigns[index];
            let arr = [];
            let title = "";

            if(type === 'leads') { arr = data.arr_leads; title = "Leads Entrantes"; }
            else if(type === 'calificados') { arr = data.arr_calif; title = "Leads Calificados"; }
            else if(type === 'agendas') { arr = data.arr_agendas; title = "Agendas Totales"; }
            else if(type === 'ventas') { arr = data.arr_ventas; title = "Ventas Cerradas"; }

            document.getElementById('modal-title').innerText = `${title} - ${data.campana}`;
            let tbody = document.getElementById('modal-tbody');
            tbody.innerHTML = '';

            arr.forEach(r => {
                let fecha = r['Fecha Creaci√≥n'] || r['Fecha'] || '-';
                let nombre = r['Nombre'] || r['Lead Name'] || '-';
                let email = r['Email'] || r['Email '] || '-';
                let tel = r['Tel√©fono'] || r['Phone'] || '-';
                let extra = type === 'ventas' ? `$${r['Monto ($)'] || 0}` : (r['Resultado'] || '');
                
                tbody.innerHTML += `
                    <tr>
                        <td class="px-4 py-3">${fecha}</td>
                        <td class="px-4 py-3 font-semibold text-white">${nombre}</td>
                        <td class="px-4 py-3 text-blue-400">${email}</td>
                        <td class="px-4 py-3">${tel}</td>
                        <td class="px-4 py-3 text-right font-bold text-green-400">${extra}</td>
                    </tr>
                `;
            });

            if(arr.length === 0) tbody.innerHTML = '<tr><td colspan="5" class="text-center py-4">No hay detalles disponibles</td></tr>';
            
            document.getElementById('modal-drilldown').classList.remove('hidden');
        }

        // --- CRM SEARCHER ---
        function openLeadSearch() {
            document.getElementById('modal-crm').classList.remove('hidden');
            document.getElementById('crmSearch').focus();
        }

        function closeModal(id) {
            document.getElementById(id).classList.add('hidden');
        }

        function searchCRM() {
            let term = document.getElementById('crmSearch').value.toLowerCase().trim();
            let container = document.getElementById('crm-results');
            
            if(term.length < 3) {
                container.innerHTML = `<div class="text-center text-slate-500 mt-10">Escribe al menos 3 letras para buscar...</div>`;
                return;
            }

            // Filtrar en las 3 bases
            const matchLead = (r) => (r['Nombre']||r['Lead Name']||'').toLowerCase().includes(term) || (r['Email']||r['Email ']||'').toLowerCase().includes(term);
            
            let foundLeads = rawLeads.filter(matchLead);
            let foundCalif = rawCalificados.filter(matchLead);
            let foundAgendas = rawAgendas.filter(matchLead);

            // Consolidar resultados por Email
            let perfiles = {};

            const addDataToProfile = (row, phase) => {
                let email = (row['Email'] || row['Email '] || '').toLowerCase();
                let nombre = row['Nombre'] || row['Lead Name'] || 'Sin Nombre';
                if(!email) return;

                if(!perfiles[email]) perfiles[email] = { nombre, email, journey: [] };
                
                let fecha = row['Fecha Creaci√≥n'] || row['Fecha'] || '-';
                let camp = row['Campa√±a (UTM)'] || row['Origen Campa√±a'] || '-';
                let ad = row['Ad Content'] || row['Nombre del Ad'] || '-';

                let badge = "";
                if(phase === 'Lead') badge = '<span class="px-2 py-1 bg-slate-600 text-xs rounded text-white">1. Lead Fr√≠o</span>';
                if(phase === 'Calif') badge = '<span class="px-2 py-1 bg-blue-600 text-xs rounded text-white">2. Calific√≥</span>';
                if(phase === 'Agenda') {
                    let res = row['Resultado'] || '';
                    if(res.includes('‚úÖ')) badge = '<span class="px-2 py-1 bg-green-600 text-xs rounded text-white">4. ¬°Compr√≥! üí∞</span>';
                    else if(res.includes('‚ùå')) badge = '<span class="px-2 py-1 bg-red-600 text-xs rounded text-white">3. No Show</span>';
                    else badge = '<span class="px-2 py-1 bg-yellow-600 text-xs rounded text-white">3. Asisti√≥ / En Proceso</span>';
                }

                perfiles[email].journey.push(`
                    <div class="border-l-2 border-slate-600 pl-4 py-2 mb-2">
                        <div class="flex items-center gap-2 mb-1">${badge} <span class="text-xs text-slate-400">üìÖ ${fecha}</span></div>
                        <p class="text-sm">Vino de: <b class="text-blue-300">${camp}</b> > <span class="text-slate-400">${ad}</span></p>
                        ${row['Resultado'] ? `<p class="text-sm mt-1 text-slate-300">Resultado: ${row['Resultado']}</p>` : ''}
                    </div>
                `);
            };

            foundLeads.forEach(r => addDataToProfile(r, 'Lead'));
            foundCalif.forEach(r => addDataToProfile(r, 'Calif'));
            foundAgendas.forEach(r => addDataToProfile(r, 'Agenda'));

            // Renderizar
            if(Object.keys(perfiles).length === 0) {
                container.innerHTML = `<div class="text-center text-red-400 mt-10">No se encontr√≥ a nadie con ese nombre o email.</div>`;
                return;
            }

            container.innerHTML = Object.values(perfiles).map(p => `
                <div class="bg-[#1e293b] p-4 rounded-lg mb-4 border border-slate-700">
                    <div class="flex items-center gap-4 border-b border-slate-700 pb-3 mb-3">
                        <div class="w-10 h-10 rounded-full bg-purple-600 flex justify-center items-center text-white font-bold">${p.nombre.substring(0,1).toUpperCase()}</div>
                        <div>
                            <h4 class="text-lg font-bold text-white">${p.nombre}</h4>
                            <p class="text-sm text-blue-400">${p.email}</p>
                        </div>
                    </div>
                    <div>
                        <h5 class="text-xs uppercase text-slate-400 font-bold mb-3 tracking-wider">Historial del Cliente:</h5>
                        ${p.journey.join('')}
                    </div>
                </div>
            `).join('');
        }

        window.onload = loadData;
    </script>
</body>
</html>
