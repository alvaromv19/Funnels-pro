<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agency Command Center v3 üöÄ</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            /* --- PALETA DE COLORES (Estilo Cyberpunk/Moderno) --- */
            --bg-body: #020617;
            --bg-panel: rgba(15, 23, 42, 0.6); /* M√°s oscuro y azulado */
            --bg-sidebar: #0f172a;
            --glass-border: rgba(255, 255, 255, 0.08);

            --neon-blue: #06b6d4;   /* Cyan */
            --neon-purple: #8b5cf6; /* Violet */
            --neon-green: #00ff9d;  /* Spring Green */
            --neon-red: #ff2a6d;    /* Radical Red */
            --neon-orange: #fbbf24; /* Amber */

            --text-main: #f8fafc;
            --text-muted: #94a3b8;

            --sidebar-width: 260px;
            --sidebar-width-collapsed: 80px;
            --transition-speed: 0.3s;
        }

        body {
            background-color: var(--bg-body);
            /* Patr√≥n de fondo sutil */
            background-image: radial-gradient(circle at 15% 50%, rgba(6, 182, 212, 0.08), transparent 25%), 
                              radial-gradient(circle at 85% 30%, rgba(139, 92, 246, 0.08), transparent 25%);
            color: var(--text-main);
            font-family: 'Outfit', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        /* --- LAYOUT --- */
        .wrapper { display: flex; width: 100%; transition: all var(--transition-speed) ease; }

        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--glass-border);
            position: fixed;
            top: 0; left: 0;
            z-index: 1000;
            padding: 24px;
            display: flex; flex-direction: column;
            transition: width var(--transition-speed);
        }

        .main-content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            padding: 40px;
            transition: margin-left var(--transition-speed), width var(--transition-speed);
        }

        /* Colapso */
        body.collapsed .sidebar { width: var(--sidebar-width-collapsed); padding: 24px 10px; }
        body.collapsed .sidebar .hide-on-collapse { display: none !important; }
        body.collapsed .sidebar .sidebar-header { justify-content: center; }
        body.collapsed .main-content { margin-left: var(--sidebar-width-collapsed); width: calc(100% - var(--sidebar-width-collapsed)); }

        /* --- GLASS PANELS --- */
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease, border-color 0.3s;
        }
        
        .glass-panel:hover {
            border-color: rgba(255,255,255,0.15);
            transform: translateY(-2px);
        }

        /* --- TEXTOS --- */
        h1, h2, h3, h4, h5 { color: white; font-weight: 700; letter-spacing: -0.01em; }
        .metric-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-muted); font-weight: 600; margin-bottom: 6px; display: block; }
        .metric-value { font-size: 2.2rem; font-weight: 800; color: white; line-height: 1.1; }

        /* --- CONTROLES --- */
        select, input {
            background: rgba(0, 0, 0, 0.3) !important;
            border: 1px solid var(--glass-border) !important;
            color: white !important;
            border-radius: 8px !important;
            padding: 10px 12px !important;
            font-size: 0.85rem;
        }
        select:focus, input:focus { border-color: var(--neon-blue) !important; outline: none; box-shadow: 0 0 10px rgba(6, 182, 212, 0.2) !important; }

        .btn-glow {
            background: linear-gradient(135deg, var(--neon-blue), #2563eb);
            border: none; color: white; padding: 12px; border-radius: 8px; font-weight: 600; width: 100%;
            box-shadow: 0 4px 15px rgba(6, 182, 212, 0.3); transition: 0.3s;
        }
        .btn-glow:hover { box-shadow: 0 6px 20px rgba(6, 182, 212, 0.5); transform: translateY(-1px); }

        .btn-outline {
            background: transparent; border: 1px solid var(--glass-border); color: var(--text-muted); width: 100%; padding: 8px; border-radius: 8px; transition: 0.2s;
        }
        .btn-outline:hover { border-color: var(--text-main); color: white; background: rgba(255,255,255,0.03); }

        /* --- TABLA CUSTOM --- */
        .table-custom { width: 100%; border-collapse: separate; border-spacing: 0 4px; }
        .table-custom th { text-align: left; padding: 12px 16px; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: 600; border-bottom: 1px solid var(--glass-border); }
        .table-custom td { background: rgba(255, 255, 255, 0.015); padding: 16px; font-size: 0.9rem; border-top: 1px solid transparent; border-bottom: 1px solid transparent; }
        .table-custom tr td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; }
        .table-custom tr td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        .table-custom tr:hover td { background: rgba(255, 255, 255, 0.05); }

        /* Badge Status */
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 6px; }

        /* Loader */
        #loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-body); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .loader-spin { width: 50px; height: 50px; border: 3px solid rgba(6, 182, 212, 0.2); border-top: 3px solid var(--neon-blue); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
    </style>

    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</head>

<body>

    <div id="loader">
        <div class="loader-spin"></div>
        <h5 style="letter-spacing: 2px; font-weight: 300; color: var(--neon-blue);">CARGANDO DATA...</h5>
    </div>

    <div class="wrapper d-none" id="main-app">

        <nav class="sidebar">
            <div class="d-flex justify-content-between align-items-center mb-5 sidebar-header">
                <div class="d-flex align-items-center hide-on-collapse">
                    <div style="width: 32px; height: 32px; background: var(--neon-blue); border-radius: 8px; display:flex; align-items:center; justify-content:center; margin-right: 12px; box-shadow: 0 0 15px rgba(6,182,212,0.4);">
                        <i class="fas fa-bolt text-white" style="font-size: 14px;"></i>
                    </div>
                    <span style="font-weight: 800; font-size: 1.2rem; letter-spacing: 0.5px;">AGENCY<span style="color:var(--neon-blue);">.</span></span>
                </div>
                <button class="btn btn-sm text-white" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            </div>

            <div class="hide-on-collapse">
                <label class="metric-label">Panel de Control</label>
                <button class="btn-outline mb-4" onclick="location.reload()">
                    <i class="fas fa-sync-alt me-2"></i> Actualizar
                </button>

                <label class="metric-label">Filtros</label>
                <select id="filtroTiempo" class="form-select mb-3">
                    <option value="mes_actual">üìÖ Este Mes</option>
                    <option value="mes_anterior">‚èÆÔ∏è Mes Anterior</option>
                    <option value="hoy">üî• Hoy</option>
                    <option value="ayer">‚è™ Ayer</option>
                    <option value="semana">üìÜ Esta Semana</option>
                    <option value="30dias">üóìÔ∏è √öltimos 30 d√≠as</option>
                    <option value="historico">üíæ Todo el Hist√≥rico</option>
                </select>

                <select id="filtroCloser" class="form-select mb-4">
                    <option value="Todos">üë§ Todos los Closers</option>
                </select>

                <hr style="border-color: var(--glass-border); margin: 20px 0;">

                <label class="metric-label">Objetivos ($)</label>
                <input type="number" id="metaFact" class="form-control mb-2" value="30000" placeholder="Meta Facturaci√≥n">
                <input type="number" id="metaAds" class="form-control mb-4" value="3500" placeholder="Budget Ads">
                
                <button class="btn-glow" onclick="updateDashboard()">APLICAR METAS</button>

                <div class="mt-auto pt-5 text-center text-muted" style="font-size: 0.7rem;">
                    v3.0.1 PRO <br> Powered by Alvaro MV
                </div>
            </div>
        </nav>

        <main class="main-content">
            
            <div class="d-flex justify-content-between align-items-end mb-5">
                <div>
                    <h1 class="mb-1">Agency Command Center</h1>
                    <p class="text-muted mb-0 font-monospace" id="rangoFechasTexto" style="font-size: 0.9rem;">Cargando...</p>
                </div>
                <div>
                    <span class="badge" style="background: rgba(0, 255, 157, 0.1); color: var(--neon-green); border: 1px solid rgba(0, 255, 157, 0.2); padding: 8px 16px; border-radius: 20px;">
                        <i class="fas fa-circle me-2 fa-beat-fade" style="font-size: 8px;"></i> SISTEMA ONLINE
                    </span>
                </div>
            </div>

            <div id="proyeccionesContainer" class="row mb-4"></div>

            <div class="glass-panel">
                <h5 class="mb-4 text-muted"><i class="fas fa-chart-pie me-2"></i>Performance General</h5>
                <div class="row g-4 text-center">
                    <div class="col">
                        <span class="metric-label">Facturaci√≥n</span>
                        <div class="metric-value text-white" id="kpi-facturacion">$0</div>
                    </div>
                    <div class="col">
                        <span class="metric-label">Inversi√≥n (Ads)</span>
                        <div class="metric-value" style="color: var(--neon-red);" id="kpi-ads">$0</div>
                    </div>
                    <div class="col">
                        <span class="metric-label">Profit Neto</span>
                        <div class="metric-value" style="color: var(--neon-green);" id="kpi-profit">$0</div>
                    </div>
                    <div class="col">
                        <span class="metric-label">ROAS</span>
                        <div class="metric-value" style="color: var(--neon-orange);" id="kpi-roas">0.00x</div>
                    </div>
                    <div class="col">
                        <span class="metric-label">Ventas</span>
                        <div class="metric-value text-white" id="kpi-ventas">0</div>
                    </div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-12 mb-4">
                    <div class="glass-panel h-100">
                        <div class="d-flex justify-content-between mb-2">
                            <h5 class="mb-0">üí∏ Tendencia Financiera (Cashflow)</h5>
                            <span class="text-muted small"><i class="fas fa-info-circle me-1"></i>Ingreso vs Gasto vs Profit</span>
                        </div>
                        <div id="chart-finance" style="height: 400px;"></div>
                    </div>
                </div>

                <div class="col-12 mb-4">
                    <div class="glass-panel h-100">
                        <div class="d-flex justify-content-between mb-2">
                            <h5 class="mb-0">üìä Flujo de Leads y Conversi√≥n Diaria</h5>
                            <span class="text-muted small">Volumen diario por estado</span>
                        </div>
                        <div id="chart-daily-status" style="height: 400px;"></div>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-7 mb-4">
                    <div class="glass-panel h-100">
                        <h5 class="mb-4">üìÖ Desglose Diario de M√©tricas</h5>
                        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                            <table class="table-custom" id="tabla-diaria">
                                <thead>
                                    <tr>
                                        <th>Fecha</th>
                                        <th class="text-center">Leads</th>
                                        <th class="text-center">Asistencias</th>
                                        <th class="text-center">No Shows</th>
                                        <th class="text-center">Ventas</th>
                                        <th class="text-end">Cierre %</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="col-lg-5 mb-4">
                    <div class="glass-panel h-100">
                        <h5 class="mb-4">üèÜ Top Performers</h5>
                        <div class="table-responsive">
                            <table class="table-custom" id="tabla-ranking">
                                <thead>
                                    <tr>
                                        <th>Closer</th>
                                        <th class="text-end">Revenue</th>
                                        <th class="text-center">Ventas</th>
                                        <th class="text-end">CR %</th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <footer class="text-center text-muted mt-5 opacity-50 small">
                Agency Command Center ‚Ä¢ 2026
            </footer>

        </main>
    </div>

    <script>
        // --- 1. CONFIGURACI√ìN ---
        const URL_VENTAS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQuXaPCen61slzpr1TElxXoCROIxAgmgWT7pyWvel1dxq_Z_U1yZPrVrTbJfx9MwaL8_cluY3v2ywoB/pub?gid=0&single=true&output=csv";
        const URL_GASTOS_DIC = "https://docs.google.com/spreadsheets/d/e/2PACX-1vGOLgPTDLie5gEbkViCbpebWfN9S_eb2h2GGlpWLjmfVgzfnwR_ncVTs4IqmKgmAFfxZTQHJlMBrIi/pub?gid=0&single=true&output=csv";
        const URL_GASTOS_ANUAL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQKTt_taqoH2qNwWbs3t4doLsi0SuGavgdUNvpCKrqtlp5U9GaTqkTt9q-c1eWBnvPN88Qg5t0vXzK/pub?gid=692917105&single=true&output=csv";

        let rawDataVentas = [], rawDataGastos = [], filteredVentas = [], filteredGastos = [];

        // --- 2. FUNCIONES UI ---
        function toggleSidebar() {
            document.body.classList.toggle('collapsed');
            setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 350);
        }

        const fmtMoney = (val) => "$" + val.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        
        function animateValue(obj, start, end, duration, isMoney = false) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                let currentVal = Math.floor(progress * (end - start) + start);
                obj.innerHTML = isMoney ? fmtMoney(currentVal) : currentVal.toLocaleString();
                if (progress < 1) window.requestAnimationFrame(step);
                else obj.innerHTML = isMoney ? fmtMoney(end) : end.toLocaleString();
            };
            window.requestAnimationFrame(step);
        }

        // --- 3. INIT & DATA ---
        async function init() {
            try {
                const ts = Date.now();
                const [resVentas, resG1, resG2] = await Promise.all([
                    fetch(URL_VENTAS + "&t=" + ts).then(r => r.text()),
                    fetch(URL_GASTOS_DIC + "&t=" + ts).then(r => r.text()),
                    fetch(URL_GASTOS_ANUAL + "&t=" + ts).then(r => r.text())
                ]);

                processVentas(resVentas);
                processGastos(resG1, resG2);
                populateClosers();
                updateDashboard();

                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').classList.add('d-none');
                    document.getElementById('main-app').classList.remove('d-none');
                }, 500);
            } catch (error) {
                console.error(error);
                alert("Error cargando datos. Revisa la consola.");
            }
        }

        function processVentas(csvText) {
            const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });
            // Fix para filas desplazadas (GHL Bug)
            let data = results.data.map(row => {
                const keys = Object.keys(row);
                if (!row[keys[0]] || row[keys[0]].trim() === "") {
                    let vals = Object.values(row);
                    let newRow = {};
                    keys.forEach((k, i) => newRow[k] = vals[i+8] || ""); // Ajuste heur√≠stico
                    return newRow;
                }
                return row;
            });

            rawDataVentas = data.map(row => {
                let fecha = moment(row['Fecha'], "DD/MM/YYYY");
                if (!fecha.isValid()) fecha = moment(row['Fecha']);
                
                let monto = parseFloat((row['Monto ($)'] || "0").toString().replace(/[$,]/g, '')) || 0;
                let res = (row['Resultado'] || "Pendiente").toLowerCase();

                let estadoSimple = "Otro";
                if (res.includes("venta")) estadoSimple = "Venta";
                else if (res.includes("no show")) estadoSimple = "No Show";
                else if (res.includes("descalificado")) estadoSimple = "Descalificado";
                else if (res.includes("seguimiento")) estadoSimple = "Seguimiento";
                else if (res.includes("re-agendado") || res.includes("reagendado")) estadoSimple = "Re-Agendado";

                let esAsistencia = (res.includes("venta") || res.includes("seguimiento") || res.includes("descalificado") || (res.includes("asisti√≥") && !res.includes("no show")));

                return {
                    fecha: fecha,
                    monto: monto,
                    closer: (row['Closer'] || "Sin Asignar").trim(),
                    email: (row['Email'] || row['Lead Name'] || Math.random()).toString(),
                    estadoSimple: estadoSimple,
                    esAsistencia: esAsistencia
                };
            }).filter(r => r.fecha.isValid());
        }

        function processGastos(csv1, csv2) {
            let allGastos = [];
            const addGasto = (fStr, gStr) => {
                let f = moment(fStr, "DD/MM/YYYY");
                if (!f.isValid()) f = moment(fStr);
                let g = parseFloat((gStr || "0").toString().replace(/[$,]/g, '')) || 0;
                if (f.isValid()) allGastos.push({ fecha: f, gasto: g });
            };

            Papa.parse(csv1, { header: true }).data.forEach(r => addGasto(r['Fecha'], r['Gasto']));
            Papa.parse(csv2, { header: false }).data.forEach(r => { if(r[0] !== 'Fecha') addGasto(r[0], r[1]); });
            
            rawDataGastos = allGastos.sort((a, b) => a.fecha - b.fecha);
        }

        function populateClosers() {
            const closers = [...new Set(rawDataVentas.map(v => v.closer))].sort();
            const sel = document.getElementById('filtroCloser');
            closers.forEach(c => {
                if (c) {
                    let opt = document.createElement('option');
                    opt.value = c; opt.innerText = c;
                    sel.appendChild(opt);
                }
            });
        }

        // --- 4. C√ÅLCULOS Y RENDER ---
        function updateDashboard() {
            const filtroTiempo = document.getElementById('filtroTiempo').value;
            const filtroCloser = document.getElementById('filtroCloser').value;
            const metaFact = parseFloat(document.getElementById('metaFact').value) || 0;
            const metaAds = parseFloat(document.getElementById('metaAds').value) || 0;

            // Fechas
            const hoy = moment();
            let inicio, fin;
            switch (filtroTiempo) {
                case 'hoy': inicio = moment(); fin = moment(); break;
                case 'ayer': inicio = moment().subtract(1, 'days'); fin = moment().subtract(1, 'days'); break;
                case 'semana': inicio = moment().startOf('isoWeek'); fin = moment(); break;
                case 'mes_anterior': inicio = moment().subtract(1, 'month').startOf('month'); fin = moment().subtract(1, 'month').endOf('month'); break;
                case '30dias': inicio = moment().subtract(30, 'days'); fin = moment(); break;
                case 'historico': inicio = moment('2000-01-01'); fin = moment(); break;
                default: inicio = moment().startOf('month'); fin = moment(); // mes_actual
            }
            document.getElementById('rangoFechasTexto').innerText = `${inicio.format("DD MMM")} - ${fin.format("DD MMM YYYY")}`.toUpperCase();

            // Filtrado
            filteredVentas = rawDataVentas.filter(v => v.fecha.isSameOrAfter(inicio, 'day') && v.fecha.isSameOrBefore(fin, 'day'));
            if (filtroCloser !== "Todos") filteredVentas = filteredVentas.filter(v => v.closer === filtroCloser);
            
            filteredGastos = rawDataGastos.filter(g => g.fecha.isSameOrAfter(inicio, 'day') && g.fecha.isSameOrBefore(fin, 'day'));

            // KPIs
            let totalFact = filteredVentas.reduce((acc, v) => acc + v.monto, 0);
            let totalGasto = (filtroCloser === "Todos") ? filteredGastos.reduce((acc, g) => acc + g.gasto, 0) : 0;
            let profit = totalFact - totalGasto;
            let roas = totalGasto > 0 ? (totalFact / totalGasto) : 0;
            let ventasCount = filteredVentas.filter(v => v.estadoSimple === "Venta").length;

            animateValue(document.getElementById('kpi-facturacion'), 0, totalFact, 800, true);
            animateValue(document.getElementById('kpi-ads'), 0, totalGasto, 800, true);
            animateValue(document.getElementById('kpi-profit'), 0, profit, 800, true);
            document.getElementById('kpi-roas').innerText = roas.toFixed(2) + "x";
            animateValue(document.getElementById('kpi-ventas'), 0, ventasCount, 800);

            // Proyecciones (Solo mes actual)
            renderProjections(filtroTiempo, totalFact, metaFact, metaAds, totalGasto);
            
            // Gr√°ficos
            renderFinancialChart(filteredVentas, filteredGastos, filtroCloser);
            renderStatusChart(filteredVentas); // Nuevo Stacked Bar
            
            // Tablas
            renderDailyTable(filteredVentas); // Nueva tabla diaria
            renderRankingTable(filteredVentas);
        }

        function renderProjections(filtro, fact, meta, budget, gasto) {
            const div = document.getElementById('proyeccionesContainer');
            if (filtro !== 'mes_actual') { div.innerHTML = ''; return; }
            
            const hoy = moment();
            const diasMes = hoy.daysInMonth();
            const diaActual = hoy.date();
            const restante = diasMes - diaActual;
            
            const projected = diaActual > 0 ? (fact / diaActual) * diasMes : 0;
            const pace = restante > 0 ? Math.max(0, budget - gasto) / restante : 0;
            
            div.innerHTML = `
                <div class="col-md-4">
                    <div class="glass-panel py-3">
                        <span class="metric-label">Proyecci√≥n Fin de Mes</span>
                        <h3 class="mb-0 text-white">${fmtMoney(projected)}</h3>
                        <div class="progress mt-2" style="height:4px; background:rgba(255,255,255,0.1)">
                            <div class="progress-bar bg-primary" style="width:${Math.min((fact/meta)*100, 100)}%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-panel py-3">
                        <span class="metric-label">Gap para Meta</span>
                        <h3 class="mb-0 text-warning">${fmtMoney(Math.max(0, meta - fact))}</h3>
                        <small class="text-muted">Faltan ${restante} d√≠as</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-panel py-3">
                        <span class="metric-label">Pace Diario Ads Sugerido</span>
                        <h3 class="mb-0" style="color:var(--neon-blue);">${fmtMoney(pace)}</h3>
                        <small class="text-muted">Para no exceder budget</small>
                    </div>
                </div>
            `;
        }

        // --- GR√ÅFICO 1: FINANZAS (Estilo Curvo + Area) ---
        function renderFinancialChart(ventas, gastos, closer) {
            let dataMap = {};
            
            // Unificar fechas
            ventas.forEach(v => {
                let d = v.fecha.format("YYYY-MM-DD");
                if (!dataMap[d]) dataMap[d] = { rev: 0, ads: 0 };
                dataMap[d].rev += v.monto;
            });
            
            if (closer === "Todos") {
                gastos.forEach(g => {
                    let d = g.fecha.format("YYYY-MM-DD");
                    if (!dataMap[d]) dataMap[d] = { rev: 0, ads: 0 };
                    dataMap[d].ads += g.gasto;
                });
            }

            let dates = Object.keys(dataMap).sort();
            let revs = dates.map(d => dataMap[d].rev);
            let ads = dates.map(d => dataMap[d].ads);
            let profit = dates.map(d => dataMap[d].rev - dataMap[d].ads);

            let traceRev = {
                x: dates, y: revs, name: 'Revenue',
                type: 'scatter', mode: 'lines',
                line: { color: '#00ff9d', width: 3, shape: 'spline' },
                fill: 'tozeroy', fillcolor: 'rgba(0, 255, 157, 0.1)'
            };

            let traceAds = {
                x: dates, y: ads, name: 'Ad Spend',
                type: 'scatter', mode: 'lines',
                line: { color: '#ff2a6d', width: 2, shape: 'spline' },
                fill: 'tozeroy', fillcolor: 'rgba(255, 42, 109, 0.05)'
            };
            
            let traceProfit = {
                x: dates, y: profit, name: 'Profit',
                type: 'scatter', mode: 'lines',
                line: { color: '#ffffff', width: 1, dash: 'dot', shape: 'spline' },
                opacity: 0.5
            };

            const layout = {
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { family: 'Outfit', color: '#94a3b8' },
                margin: { t: 20, l: 40, r: 20, b: 40 },
                xaxis: { showgrid: false, tickformat: '%d %b' },
                yaxis: { gridcolor: 'rgba(255,255,255,0.05)' },
                showlegend: true,
                legend: { orientation: 'h', y: 1.1 },
                hovermode: 'x unified'
            };

            Plotly.newPlot('chart-finance', [traceRev, traceAds, traceProfit], layout, {displayModeBar: false, responsive: true});
        }

        // --- GR√ÅFICO 2: ESTADO DIARIO (STACKED BAR - Soluci√≥n al cruce) ---
        function renderStatusChart(ventas) {
            let dataMap = {};
            // Estados a trackear
            const statuses = ["Venta", "No Show", "Descalificado", "Seguimiento", "Re-Agendado"];
            const colors = { 
                "Venta": "#00ff9d", 
                "No Show": "#ff2a6d", 
                "Descalificado": "#fbbf24", 
                "Seguimiento": "#06b6d4",
                "Re-Agendado": "#8b5cf6" 
            };

            ventas.forEach(v => {
                let d = v.fecha.format("YYYY-MM-DD");
                if (!dataMap[d]) {
                    dataMap[d] = {};
                    statuses.forEach(s => dataMap[d][s] = 0);
                }
                if (statuses.includes(v.estadoSimple)) dataMap[d][v.estadoSimple]++;
            });

            let dates = Object.keys(dataMap).sort();
            
            let traces = statuses.map(status => {
                return {
                    x: dates,
                    y: dates.map(d => dataMap[d][status]),
                    name: status,
                    type: 'bar',
                    marker: { color: colors[status] }
                };
            });

            const layout = {
                barmode: 'stack', // ESTO EVITA QUE SE CRUCEN, LOS APILA
                paper_bgcolor: 'transparent',
                plot_bgcolor: 'transparent',
                font: { family: 'Outfit', color: '#94a3b8' },
                margin: { t: 20, l: 30, r: 20, b: 40 },
                xaxis: { showgrid: false, tickformat: '%d %b' },
                yaxis: { gridcolor: 'rgba(255,255,255,0.05)' },
                showlegend: true,
                legend: { orientation: 'h', y: 1.1 },
                hovermode: 'x unified'
            };

            Plotly.newPlot('chart-daily-status', traces, layout, {displayModeBar: false, responsive: true});
        }

        // --- TABLA 1: RANKING CLOSERS ---
        function renderRankingTable(ventas) {
            let data = {};
            ventas.forEach(v => {
                let c = v.closer;
                if (!data[c]) data[c] = { rev: 0, sales: 0, asist: 0 };
                data[c].rev += v.monto;
                if (v.estadoSimple === "Venta") data[c].sales++;
                if (v.esAsistencia) data[c].asist++;
            });

            let sorted = Object.keys(data).sort((a,b) => data[b].rev - data[a].rev);
            let html = "";
            sorted.forEach(c => {
                let d = data[c];
                let cr = d.asist > 0 ? (d.sales / d.asist * 100).toFixed(1) : "0.0";
                html += `
                    <tr>
                        <td class="fw-bold text-white">${c}</td>
                        <td class="text-end" style="color:var(--neon-green)">${fmtMoney(d.rev)}</td>
                        <td class="text-center text-white">${d.sales}</td>
                        <td class="text-end text-muted">${cr}%</td>
                    </tr>
                `;
            });
            document.querySelector("#tabla-ranking tbody").innerHTML = html;
        }

        // --- TABLA 2: DESGLOSE DIARIO (NUEVA) ---
        function renderDailyTable(ventas) {
            let data = {};
            ventas.forEach(v => {
                let d = v.fecha.format("YYYY-MM-DD");
                if (!data[d]) data[d] = { leads: 0, asist: 0, noshow: 0, ventas: 0 };
                
                // Asumimos 1 lead √∫nico por email/fecha en esta vista simplificada
                data[d].leads++; 
                if (v.esAsistencia) data[d].asist++;
                if (v.estadoSimple === "No Show") data[d].noshow++;
                if (v.estadoSimple === "Venta") data[d].ventas++;
            });

            // Ordenar fecha descendente (m√°s reciente arriba)
            let sortedDates = Object.keys(data).sort().reverse();
            let html = "";

            sortedDates.forEach(d => {
                let stats = data[d];
                let cr = stats.asist > 0 ? (stats.ventas / stats.asist * 100).toFixed(1) : "0.0";
                let fechaFmt = moment(d).format("DD MMM, ddd");
                
                html += `
                    <tr>
                        <td class="text-white">${fechaFmt}</td>
                        <td class="text-center text-muted">${stats.leads}</td>
                        <td class="text-center text-white">${stats.asist}</td>
                        <td class="text-center" style="color:var(--neon-red)">${stats.noshow}</td>
                        <td class="text-center" style="color:var(--neon-green)">${stats.ventas}</td>
                        <td class="text-end fw-bold">${cr}%</td>
                    </tr>
                `;
            });
            document.querySelector("#tabla-diaria tbody").innerHTML = html;
        }

        // Listeners
        document.getElementById('filtroTiempo').addEventListener('change', updateDashboard);
        document.getElementById('filtroCloser').addEventListener('change', updateDashboard);

        // Start
        init();

    </script>
</body>
</html>
