<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Inteligente - Creamos Negocios</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --accent: #3b82f6;
            --alert-red: #ef4444;
            --alert-yellow: #eab308;
            --success: #22c55e;
            --border: #334155;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
        }

        .header-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        /* Contenedor de Filtros */
        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
            align-items: center;
        }

        .filters select, .filters input {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--border);
            background: var(--bg-color);
            color: var(--text-main);
            box-sizing: border-box;
            color-scheme: dark; /* Para que el calendario nativo sea oscuro */
        }

        .rango-fechas-container {
            display: none; /* Se oculta por defecto, se activa con JS */
            gap: 10px;
            grid-column: span 1;
        }

        /* Tarjetas KPI */
        .kpi-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            text-align: center;
        }

        .kpi-value { font-size: 32px; font-weight: bold; margin: 10px 0; }
        .kpi-title { color: var(--text-muted); font-size: 14px; text-transform: uppercase; }

        /* Contenedor Principal de Clientes */
        #clientes-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .cliente-card {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid var(--border);
            position: relative;
        }

        .cliente-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 10px;
        }

        .cliente-nombre { font-size: 18px; font-weight: bold; margin: 0; }
        .cliente-trafficker { 
            font-size: 12px; 
            color: var(--accent); 
            background: rgba(59, 130, 246, 0.1); 
            padding: 4px 8px; 
            border-radius: 4px; 
            margin-top: 5px;
            display: inline-block;
        }

        .status-badge {
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 12px;
            font-weight: bold;
        }
        
        .bg-red { background: rgba(239, 68, 68, 0.2); color: var(--alert-red); border: 1px solid var(--alert-red);}
        .bg-yellow { background: rgba(234, 179, 8, 0.2); color: var(--alert-yellow); border: 1px solid var(--alert-yellow);}
        .bg-green { background: rgba(34, 197, 94, 0.2); color: var(--success); border: 1px solid var(--success);}

        /* LÃ­nea de Tiempo */
        .timeline {
            border-left: 2px solid var(--border);
            padding-left: 15px;
            margin-top: 15px;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 15px;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -21px;
            top: 5px;
            width: 10px;
            height: 10px;
            background: var(--accent);
            border-radius: 50%;
        }

        .timeline-date { font-size: 12px; color: var(--text-muted); }
        .timeline-estado { font-weight: bold; font-size: 14px; margin: 2px 0; }
        
        .empty-state {
            font-size: 13px;
            color: var(--text-muted);
            font-style: italic;
        }
    </style>
</head>
<body>

    <div class="header-title">Creamos Negocios - Inteligencia de TrÃ¡fico</div>

    <div class="filters">
        <select id="filtro-tiempo">
            <option value="todos">Todo el Historial</option>
            <option value="hoy">Hoy</option>
            <option value="ayer">Ayer</option>
            <option value="7dias">Ãšltimos 7 dÃ­as</option>
            <option value="esteMes">Este Mes</option>
            <option value="mesPasado">Mes Pasado</option>
            <option value="personalizado">Personalizado...</option>
        </select>

        <div class="rango-fechas-container" id="contenedor-fechas">
            <input type="date" id="fecha-inicio" title="Fecha Inicio">
            <input type="date" id="fecha-fin" title="Fecha Fin">
        </div>

        <select id="filtro-trafficker">
            <option value="todos">Todos los Traffickers</option>
        </select>

        <input type="text" id="buscador-cliente" placeholder="Buscar cliente por nombre...">
    </div>

    <div class="kpi-container">
        <div class="kpi-card">
            <div class="kpi-title">Clientes Activos (Filtro)</div>
            <div class="kpi-value" id="kpi-total">0</div>
        </div>
        <div class="kpi-card" style="border-bottom: 3px solid var(--alert-yellow);">
            <div class="kpi-title">Alerta Estancamiento (>5d Testing)</div>
            <div class="kpi-value" id="kpi-yellow" style="color: var(--alert-yellow);">0</div>
        </div>
        <div class="kpi-card" style="border-bottom: 3px solid var(--alert-red);">
            <div class="kpi-title">Alerta CrÃ­tica (>3d Apagado)</div>
            <div class="kpi-value" id="kpi-red" style="color: var(--alert-red);">0</div>
        </div>
    </div>

    <div id="clientes-container">
        </div>

    <script>
        const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vRci7-x8FSCzNeyzd7tm4PRVTVuHU-FFnmbAS6ECChvV-K0dEBxYGmv6IhJxhOdmBIviCxcNh7sFq7I/pub?gid=310336411&single=true&output=csv";
        let datosGlobales = [];

        document.addEventListener('DOMContentLoaded', () => {
            Papa.parse(CSV_URL, {
                download: true,
                header: true,
                complete: function(results) {
                    datosGlobales = results.data.filter(row => row.Cliente && row.Fecha_Hora);
                    inicializarFiltros();
                    renderizarDashboard();
                }
            });

            // Listeners
            document.getElementById('filtro-tiempo').addEventListener('change', (e) => {
                const contenedorFechas = document.getElementById('contenedor-fechas');
                if(e.target.value === 'personalizado') {
                    contenedorFechas.style.display = 'flex';
                } else {
                    contenedorFechas.style.display = 'none';
                    renderizarDashboard();
                }
            });
            document.getElementById('fecha-inicio').addEventListener('change', renderizarDashboard);
            document.getElementById('fecha-fin').addEventListener('change', renderizarDashboard);
            document.getElementById('filtro-trafficker').addEventListener('change', renderizarDashboard);
            document.getElementById('buscador-cliente').addEventListener('input', renderizarDashboard);
        });

        function inicializarFiltros() {
            const traffickers = [...new Set(datosGlobales.map(d => d.Trafficker))].filter(Boolean);
            const select = document.getElementById('filtro-trafficker');
            traffickers.forEach(t => {
                select.innerHTML += `<option value="${t}">${t}</option>`;
            });
        }

        function parsearFecha(fechaStr) {
            let parts = fechaStr.split(/[\/\-\s:]/);
            if(parts.length >= 3) {
                return new Date(parts[2], parts[1] - 1, parts[0]); 
            }
            return new Date(fechaStr);
        }

        function obtenerRangoFechas() {
            const tipo = document.getElementById('filtro-tiempo').value;
            const hoy = new Date();
            hoy.setHours(23, 59, 59, 999);
            
            let inicio = new Date('2000-01-01');
            let fin = new Date('2100-01-01');

            if (tipo === 'hoy') {
                inicio = new Date(hoy); inicio.setHours(0,0,0,0);
                fin = hoy;
            } else if (tipo === 'ayer') {
                inicio = new Date(hoy); inicio.setDate(inicio.getDate() - 1); inicio.setHours(0,0,0,0);
                fin = new Date(inicio); fin.setHours(23,59,59,999);
            } else if (tipo === '7dias') {
                inicio = new Date(hoy); inicio.setDate(inicio.getDate() - 7); inicio.setHours(0,0,0,0);
                fin = hoy;
            } else if (tipo === 'esteMes') {
                inicio = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
                fin = hoy;
            } else if (tipo === 'mesPasado') {
                inicio = new Date(hoy.getFullYear(), hoy.getMonth() - 1, 1);
                fin = new Date(hoy.getFullYear(), hoy.getMonth(), 0, 23, 59, 59);
            } else if (tipo === 'personalizado') {
                const inputInicio = document.getElementById('fecha-inicio').value;
                const inputFin = document.getElementById('fecha-fin').value;
                
                if(inputInicio) {
                    let p = inputInicio.split('-');
                    inicio = new Date(p[0], p[1]-1, p[2]);
                    inicio.setHours(0,0,0,0);
                }
                if(inputFin) {
                    let p = inputFin.split('-');
                    fin = new Date(p[0], p[1]-1, p[2]);
                    fin.setHours(23,59,59,999);
                }
            }
            return { inicio, fin };
        }

        function renderizarDashboard() {
            const filtroTrafficker = document.getElementById('filtro-trafficker').value;
            const busqueda = document.getElementById('buscador-cliente').value.toLowerCase();
            const rango = obtenerRangoFechas();

            // 1. Agrupar
            let clientesMap = {};
            datosGlobales.forEach(row => {
                const nombre = row.Cliente;
                if(!clientesMap[nombre]) {
                    clientesMap[nombre] = { nombre: nombre, trafficker: row.Trafficker, historial: [] };
                }
                clientesMap[nombre].historial.push({
                    fechaObj: parsearFecha(row.Fecha_Hora),
                    fechaStr: row.Fecha_Hora,
                    estado: row.Estado
                });
            });

            // Ordenar
            Object.values(clientesMap).forEach(c => {
                c.historial.sort((a, b) => b.fechaObj - a.fechaObj);
            });

            const hoy = new Date();
            let html = "";
            let kpiTotal = 0, kpiYellow = 0, kpiRed = 0;

            // 2. Filtrar y Renderizar
            Object.values(clientesMap).forEach(cliente => {
                if(filtroTrafficker !== 'todos' && cliente.trafficker !== filtroTrafficker) return;
                if(busqueda && !cliente.nombre.toLowerCase().includes(busqueda)) return;

                // Extraemos el historial que cae estrictamente dentro del rango de fechas
                const historialFiltrado = cliente.historial.filter(h => h.fechaObj >= rango.inicio && h.fechaObj <= rango.fin);
                
                // Si el cliente no tuvo NINGÃšN movimiento en esas fechas, no lo mostramos para mantener el panel limpio
                if(historialFiltrado.length === 0) return;

                // Las alertas siempre se basan en el ÃšLTIMO registro absoluto del cliente (el estado actual real)
                const ultimoRegistroAbsoluto = cliente.historial[0];
                const diasDesdeUltimo = Math.floor((hoy - ultimoRegistroAbsoluto.fechaObj) / (1000 * 60 * 60 * 24));
                
                let estadoBadge = "bg-green";
                let textoAlerta = "Estable";

                if (ultimoRegistroAbsoluto.estado.toLowerCase().includes("apagado") && diasDesdeUltimo >= 3) {
                    estadoBadge = "bg-red"; textoAlerta = "Â¡Alerta CrÃ­tica! >3 dÃ­as apagado"; kpiRed++;
                } else if (ultimoRegistroAbsoluto.estado.toLowerCase().includes("testing") && diasDesdeUltimo >= 5) {
                    estadoBadge = "bg-yellow"; textoAlerta = "Cuello de botella en Testing"; kpiYellow++;
                } else if (ultimoRegistroAbsoluto.estado.toLowerCase().includes("apagado")) {
                    estadoBadge = "bg-red"; textoAlerta = "Apagado Recientemente";
                }

                kpiTotal++;

                // Construir la lÃ­nea de tiempo SOLO con los eventos del rango de fechas seleccionado
                let timelineHTML = "";
                historialFiltrado.forEach(h => {
                    timelineHTML += `
                        <div class="timeline-item">
                            <div class="timeline-date">${h.fechaStr}</div>
                            <div class="timeline-estado">${h.estado}</div>
                        </div>
                    `;
                });

                html += `
                    <div class="cliente-card">
                        <div class="cliente-header">
                            <div>
                                <div class="cliente-nombre">${cliente.nombre}</div>
                                <div class="cliente-trafficker">ðŸ‘¤ Trafficker: ${cliente.trafficker}</div>
                            </div>
                            <div class="status-badge ${estadoBadge}">${textoAlerta}</div>
                        </div>
                        <div class="timeline">
                            ${timelineHTML}
                        </div>
                    </div>
                `;
            });

            // Actualizar DOM
            document.getElementById('clientes-container').innerHTML = html || `<div class="empty-state">No se encontraron movimientos en este rango de fechas.</div>`;
            document.getElementById('kpi-total').innerText = kpiTotal;
            document.getElementById('kpi-yellow').innerText = kpiYellow;
            document.getElementById('kpi-red').innerText = kpiRed;
        }
    </script>
</body>
</html>
