<!DOCTYPE html>
<html lang="es" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creamos Negocios | Command Center ü¶Å</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M20 60 L50 20 L80 60 L55 55 L50 80 L45 55 Z' fill='none' stroke='%2300CC96' stroke-width='12' stroke-linejoin='round' stroke-linecap='round'/></svg>">

    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&family=Space+Grotesk:wght@700&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://npmcdn.com/flatpickr/dist/themes/dark.css" id="flatpickr-theme">

    <style>
        /* --- THEME VARIABLES --- */
        :root[data-theme="dark"] {
            --bg-body: #050b14;
            --bg-panel: rgba(17, 24, 39, 0.6);
            --bg-sidebar: rgba(11, 17, 33, 0.95);
            --glass-border: rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.05);
            --shadow-3d: 0 10px 30px -10px rgba(0,0,0,0.8), inset 0 1px 0 rgba(255,255,255,0.1);
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --text-heading: #ffffff;
            --input-bg: rgba(0,0,0,0.3);
        }

        :root[data-theme="light"] {
            --bg-body: #f1f5f9;
            --bg-panel: rgba(255, 255, 255, 0.8);
            --bg-sidebar: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(0, 0, 0, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.8);
            --shadow-3d: 0 15px 35px -5px rgba(15, 23, 42, 0.1), inset 0 2px 0 rgba(255,255,255,0.9);
            
            --text-main: #334155;
            --text-muted: #64748b;
            --text-heading: #0f172a;
            --input-bg: #f8fafc;
        }

        :root {
            --neon-primary: #3b82f6;
            --neon-success: #00CC96;
            --neon-danger: #ef4444;
            --neon-warning: #f59e0b;
            --sidebar-width: 300px;
            --sidebar-width-collapsed: 85px;
            --transition: 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        body {
            background-color: var(--bg-body);
            color: var(--text-main);
            font-family: 'Plus Jakarta Sans', sans-serif;
            margin: 0;
            overflow-x: hidden;
            transition: background-color var(--transition), color var(--transition);
        }

        /* Ambient Background Glow */
        body::before {
            content: ''; position: fixed; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle at 50% 50%, rgba(0, 204, 150, 0.03), transparent 60%),
                        radial-gradient(circle at 80% 20%, rgba(59, 130, 246, 0.03), transparent 50%);
            z-index: -1; pointer-events: none;
        }

        /* --- LAYOUT --- */
        .wrapper { display: flex; width: 100%; transition: var(--transition); }
        
        .sidebar {
            width: var(--sidebar-width); height: 100vh; background: var(--bg-sidebar);
            border-right: 1px solid var(--glass-border); position: fixed; z-index: 1000;
            padding: 30px 25px; overflow-y: auto; display: flex; flex-direction: column;
            transition: width var(--transition); backdrop-filter: blur(20px);
        }
        
        .main-content {
            margin-left: var(--sidebar-width); width: calc(100% - var(--sidebar-width));
            padding: 40px 50px; transition: margin-left var(--transition), width var(--transition);
        }

        /* Collapsed State */
        body.collapsed .sidebar { width: var(--sidebar-width-collapsed); padding: 30px 15px; }
        body.collapsed .sidebar .hide-on-collapse { display: none !important; }
        body.collapsed .main-content { margin-left: var(--sidebar-width-collapsed); width: calc(100% - var(--sidebar-width-collapsed)); }

        /* --- UI COMPONENTS --- */
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: 1px solid var(--glass-border);
            border-radius: 24px; padding: 30px; margin-bottom: 25px;
            box-shadow: var(--shadow-3d);
            position: relative; overflow: hidden; transition: transform 0.3s, box-shadow 0.3s;
        }
        .glass-panel:hover { transform: translateY(-3px); }
        
        /* 3D Inner Highlight */
        .glass-panel::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
            background: linear-gradient(90deg, transparent, var(--glass-highlight), transparent);
        }

        /* Typography */
        h1, h2, h3, h4, h5 { color: var(--text-heading); font-family: 'Space Grotesk', sans-serif; font-weight: 700; }
        .metric-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); font-weight: 800; display: block; margin-bottom: 8px; }
        .metric-value { font-size: 2.5rem; font-family: 'Space Grotesk', sans-serif; font-weight: 700; color: var(--text-heading); line-height: 1.1; margin-bottom: 5px;}
        .metric-delta { font-size: 0.9rem; font-weight: 600; display: flex; align-items: center; gap: 5px;}
        
        .text-success-neon { color: var(--neon-success) !important; text-shadow: 0 0 15px rgba(0, 204, 150, 0.4); }
        .text-danger-neon { color: var(--neon-danger) !important; }

        /* Inputs & Controls */
        select, input.form-control {
            background: var(--input-bg) !important; border: 1px solid var(--glass-border) !important;
            color: var(--text-main) !important; border-radius: 12px !important; padding: 14px !important; 
            font-size: 0.95rem; font-weight: 600; transition: var(--transition);
        }
        select:focus, input.form-control:focus { border-color: var(--neon-success) !important; box-shadow: 0 0 0 4px rgba(0, 204, 150, 0.1) !important; }

        /* 3D Button */
        .btn-glow {
            background: linear-gradient(135deg, #00CC96, #00a378);
            color: #000; border: none; padding: 16px; border-radius: 14px; font-weight: 800; width: 100%;
            text-transform: uppercase; letter-spacing: 1px; transition: all 0.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 20px -5px rgba(0, 204, 150, 0.5), inset 0 2px 0 rgba(255,255,255,0.4);
            cursor: pointer; position: relative; overflow: hidden;
        }
        .btn-glow:active { transform: translateY(2px); box-shadow: 0 4px 10px -5px rgba(0, 204, 150, 0.5), inset 0 0px 0 rgba(255,255,255,0.4); }

        /* TABS NAVIGATION */
        .nav-tabs-custom {
            display: flex; gap: 12px; margin-bottom: 35px; border-bottom: 2px solid var(--glass-border); padding-bottom: 15px;
            overflow-x: auto;
        }
        .tab-btn {
            background: transparent; border: 1px solid transparent; color: var(--text-muted); padding: 12px 24px; 
            font-size: 0.95rem; font-weight: 700; border-radius: 12px; cursor: pointer; transition: all 0.3s; 
            white-space: nowrap; display: flex; align-items: center; gap: 8px;
        }
        .tab-btn:hover { background: var(--glass-border); color: var(--text-heading); }
        .tab-btn.active { 
            background: rgba(0, 204, 150, 0.1); color: var(--neon-success); 
            border: 1px solid rgba(0, 204, 150, 0.3); box-shadow: 0 4px 15px rgba(0, 204, 150, 0.1);
        }

        /* TABLES */
        .table-custom { width: 100%; border-collapse: separate; border-spacing: 0 10px; }
        .table-custom th { text-align: left; padding: 15px; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; font-weight: 800; letter-spacing: 1px;}
        .table-custom td { background: var(--glass-border); padding: 18px 15px; border-top: 1px solid transparent; border-bottom: 1px solid transparent; color: var(--text-main); font-weight: 600;}
        .table-custom tr:hover td { background: rgba(0, 204, 150, 0.05); }
        .table-custom tr td:first-child { border-top-left-radius: 16px; border-bottom-left-radius: 16px; }
        .table-custom tr td:last-child { border-top-right-radius: 16px; border-bottom-right-radius: 16px; }

        /* Theme Switcher */
        .theme-switch {
            position: fixed; bottom: 30px; right: 30px; width: 50px; height: 50px; border-radius: 50%;
            background: var(--bg-panel); border: 1px solid var(--glass-border); color: var(--text-heading);
            display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer;
            box-shadow: var(--shadow-3d); z-index: 9999; backdrop-filter: blur(10px); transition: transform 0.3s;
        }
        .theme-switch:hover { transform: scale(1.1) rotate(15deg); }

        /* Alerts (Bottlenecks) */
        .alert-card {
            padding: 15px 20px; border-radius: 16px; display: flex; align-items: center; gap: 15px; margin-bottom: 15px;
            font-weight: 600; font-size: 0.9rem; border-left: 4px solid;
        }
        .alert-danger { background: rgba(239, 68, 68, 0.1); border-left-color: var(--neon-danger); color: var(--neon-danger); }
        .alert-success { background: rgba(0, 204, 150, 0.1); border-left-color: var(--neon-success); color: var(--neon-success); }

        /* LOADER */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #050b14; z-index: 99999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader-logo { font-size: 4rem; font-weight: 900; font-family: 'Space Grotesk'; background: linear-gradient(45deg, var(--neon-success), #3b82f6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(0.95); filter: brightness(0.8); } 50% { transform: scale(1.05); filter: brightness(1.2); } 100% { transform: scale(0.95); filter: brightness(0.8); } }

        .fade-in { animation: fadeIn 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }
        .d-none { display: none !important; }
    </style>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
</head>

<body>

    <div id="loader">
        <div class="loader-logo">CN</div>
        <p class="mt-3" style="color: #00CC96; letter-spacing: 3px; font-size: 0.85rem; font-weight: 700;">INICIANDO SISTEMA 100/10...</p>
    </div>

    <button class="theme-switch" onclick="toggleTheme()" id="themeBtn">
        <i class="fas fa-sun"></i>
    </button>

    <div class="wrapper d-none" id="main-app">
        
        <nav class="sidebar">
            <div class="d-flex justify-content-between align-items-center mb-5 logo-area">
                <div class="d-flex align-items-center hide-on-collapse">
                    <div style="width: 42px; height: 42px; background: linear-gradient(135deg,#00CC96,#007a5a); border-radius: 12px; display:flex; align-items:center; justify-content:center; margin-right: 15px; box-shadow: 0 4px 15px rgba(0,204,150,0.4); color: white; font-size: 1.2rem;">
                        ü¶Å
                    </div>
                    <div>
                        <span style="font-family: 'Space Grotesk'; font-weight: 800; font-size: 1.2rem; display: block; line-height: 1; color: var(--text-heading);">AGENCY</span>
                        <span style="font-size: 0.65rem; color: var(--neon-success); font-weight: 800; letter-spacing: 2px;">CREAMOS NEGOCIOS</span>
                    </div>
                </div>
                <button style="background:transparent; border:none; color:var(--text-muted); font-size: 1.2rem; cursor:pointer;" onclick="toggleSidebar()"><i class="fas fa-bars-staggered"></i></button>
            </div>

            <div class="hide-on-collapse d-flex flex-column flex-grow-1">
                <label class="metric-label">Control de Datos</label>
                <button class="btn btn-outline-secondary w-100 mb-4" style="border-radius:12px; font-weight:700; color: var(--text-main); border-color: var(--glass-border);" onclick="location.reload()">
                    <i class="fas fa-bolt me-2 text-warning"></i> Sincronizar Ahora
                </button>

                <label class="metric-label">Motor de Filtros</label>
                <select id="filtroTiempo" class="form-select mb-3">
                    <option value="mes_actual">üìÖ Este Mes</option>
                    <option value="hoy">üî• Hoy</option>
                    <option value="ayer">‚è™ Ayer</option>
                    <option value="semana">üìÜ Esta Semana</option>
                    <option value="mes_anterior">‚èÆÔ∏è Mes Anterior</option>
                    <option value="30dias">üóìÔ∏è √öltimos 30 d√≠as</option>
                    <option value="custom">‚öôÔ∏è Rango Personalizado...</option>
                </select>
                
                <div id="customDateContainer" class="d-none mb-3">
                    <input type="text" id="customDateRange" class="form-control" placeholder="Selecciona fechas...">
                </div>

                <select id="filtroCloser" class="form-select mb-4">
                    <option value="Todos">üë§ Todos los Closers</option>
                </select>

                <div class="mt-4 p-4 rounded-4" style="background: rgba(0,0,0,0.1); border: 1px solid var(--glass-border);">
                    <label class="metric-label"><i class="fas fa-bullseye me-1"></i> Metas del Ciclo ($)</label>
                    <input type="number" id="metaFact" class="form-control mb-3" value="30000" placeholder="Meta Fact.">
                    <input type="number" id="metaAds" class="form-control mb-3" value="5000" placeholder="Budget Ads">
                    <button class="btn-glow mt-2" onclick="updateDashboard()">APLICAR</button>
                </div>
                
                <div class="mt-auto pt-4 text-center text-muted" style="font-size: 0.75rem; font-weight: 600;">
                    V2.5 PRO EDITION <br> By Alvaro MV
                </div>
            </div>
        </nav>

        <main class="main-content">
            
            <div class="d-flex justify-content-between align-items-end mb-5 fade-in" style="animation-delay: 0.1s;">
                <div>
                    <h1 class="display-5 mb-2">Visi√≥n General</h1>
                    <p class="mb-0 fw-bold" style="color: var(--neon-success); font-family: 'Space Grotesk';" id="rangoFechasTexto">Cargando...</p>
                </div>
                <div class="text-end">
                    <span class="badge" style="background: rgba(0, 204, 150, 0.1); color: var(--neon-success); border: 1px solid rgba(0, 204, 150, 0.3); padding: 10px 20px; border-radius: 50px; font-weight: 800; font-size: 0.85rem; box-shadow: 0 0 20px rgba(0,204,150,0.2);">
                        <i class="fas fa-circle me-2 fa-fade" style="font-size: 8px;"></i> SISTEMA ONLINE
                    </span>
                </div>
            </div>

            <div class="row g-4 mb-5 fade-in" style="animation-delay: 0.2s;">
                <div class="col-xl-3 col-md-6">
                    <div class="glass-panel h-100 p-4">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="metric-label">CASH COLLECTED</span>
                            <div style="width:40px;height:40px;border-radius:10px;background:rgba(0,204,150,0.1);color:var(--neon-success);display:flex;align-items:center;justify-content:center;font-size:1.2rem;"><i class="fas fa-dollar-sign"></i></div>
                        </div>
                        <div class="metric-value mt-3" id="kpi-facturacion">$0</div>
                        <span class="metric-delta" id="delta-facturacion" style="color: var(--text-muted);">--% Meta</span>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="glass-panel h-100 p-4">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="metric-label">AD SPEND VSL</span>
                            <div style="width:40px;height:40px;border-radius:10px;background:rgba(239,68,68,0.1);color:var(--neon-danger);display:flex;align-items:center;justify-content:center;font-size:1.2rem;"><i class="fas fa-fire"></i></div>
                        </div>
                        <div class="metric-value text-danger-neon mt-3" id="kpi-ads">$0</div>
                        <span class="metric-delta" style="color: var(--text-muted);" id="delta-ads">Restante: $0</span>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="glass-panel h-100 p-4" style="border: 1px solid rgba(0,204,150,0.3);">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="metric-label">PROFIT L√çQUIDO</span>
                            <div style="width:40px;height:40px;border-radius:10px;background:var(--neon-success);color:#000;display:flex;align-items:center;justify-content:center;font-size:1.2rem;"><i class="fas fa-wallet"></i></div>
                        </div>
                        <div class="metric-value text-success-neon mt-3" id="kpi-profit">$0</div>
                        <span class="metric-delta" style="color: var(--text-muted);">Dinero en el Banco</span>
                    </div>
                </div>
                <div class="col-xl-3 col-md-6">
                    <div class="glass-panel h-100 p-4">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="metric-label">ROAS GLOBAL</span>
                            <div style="width:40px;height:40px;border-radius:10px;background:rgba(59,130,246,0.1);color:var(--neon-primary);display:flex;align-items:center;justify-content:center;font-size:1.2rem;"><i class="fas fa-rocket"></i></div>
                        </div>
                        <div class="metric-value mt-3" id="kpi-roas">0.00x</div>
                        <span class="metric-delta" id="delta-roas">-- vs KPI</span>
                    </div>
                </div>
            </div>

            <div class="nav-tabs-custom fade-in" style="animation-delay: 0.3s;">
                <button class="tab-btn active" onclick="switchTab('tab-ceo')"><i class="fas fa-chess-king"></i> Visi√≥n CEO</button>
                <button class="tab-btn" onclick="switchTab('tab-funnel')"><i class="fas fa-filter"></i> Embudo VSL</button>
                <button class="tab-btn" onclick="switchTab('tab-closer')"><i class="fas fa-headset"></i> Performance Closer</button>
                <button class="tab-btn" onclick="switchTab('tab-math')"><i class="fas fa-calculator"></i> Calculadora √âxito</button>
            </div>

            <div id="tab-ceo" class="tab-content fade-in" style="animation-delay: 0.4s;">
                <div class="row">
                    <div class="col-12 mb-4" id="bottleneck-container">
                        </div>

                    <div class="col-12">
                        <div class="glass-panel">
                            <h4 class="mb-4">üìà Curva de Crecimiento Diario</h4>
                            <div class="row mb-4">
                                <div class="col-md-4">
                                    <div class="p-3 rounded-4" style="background: var(--glass-border);">
                                        <small class="metric-label">Falta para Meta</small>
                                        <h3 class="mb-0" id="ceo-falta">$0</h3>
                                        <div class="progress mt-3" style="height: 8px; background: rgba(0,0,0,0.2); border-radius:10px;">
                                            <div class="progress-bar" id="ceo-progress" style="width: 0%; background: linear-gradient(90deg, #007a5a, #00CC96); border-radius:10px;"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 rounded-4" style="background: var(--glass-border);">
                                        <small class="metric-label">Proyecci√≥n Fin de Mes</small>
                                        <h3 class="mb-0" id="ceo-proyeccion">$0</h3>
                                        <small class="text-muted">Basado en Run Rate</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="p-3 rounded-4" style="background: var(--glass-border);">
                                        <small class="metric-label">Pacing de Inversi√≥n</small>
                                        <h3 class="mb-0" id="ceo-diario">$0 <span style="font-size:1rem;color:var(--text-muted)">/d√≠a</span></h3>
                                        <small class="text-muted" id="ceo-sugerido">Sugerida: $0/d√≠a</small>
                                    </div>
                                </div>
                            </div>
                            <div id="chart-activity" style="height: 400px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-funnel" class="tab-content d-none fade-in">
                <div class="row g-4">
                    <div class="col-xl-8">
                        <div class="glass-panel h-100">
                            <h4 class="mb-4">üå™Ô∏è Pipeline VSL Strict</h4>
                            <div id="chart-funnel" style="height: 450px;"></div>
                        </div>
                    </div>
                    <div class="col-xl-4">
                        <div class="glass-panel h-100 d-flex flex-column justify-content-between">
                            <h4 class="mb-4">üí∏ Costos de Adquisici√≥n</h4>
                            
                            <div class="p-4 rounded-4 mb-3" style="background: var(--glass-border);">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="metric-label mb-0">CPL (Costo x Lead)</span>
                                    <i class="fas fa-users text-muted"></i>
                                </div>
                                <div class="h2 mb-0" id="kpi-cpl">$0.00</div>
                            </div>

                            <div class="p-4 rounded-4 mb-3" style="background: var(--glass-border);">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="metric-label mb-0">CPAg (Costo x Agenda)</span>
                                    <i class="fas fa-calendar-check text-muted"></i>
                                </div>
                                <div class="h2 mb-0" id="kpi-cpag">$0.00</div>
                            </div>

                            <div class="p-4 rounded-4" style="background: rgba(0,204,150,0.1); border: 1px solid rgba(0,204,150,0.2);">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="metric-label mb-0 text-success-neon">CAC (Costo de Adquisici√≥n)</span>
                                    <i class="fas fa-handshake text-success-neon"></i>
                                </div>
                                <div class="h1 mb-0 text-success-neon" id="kpi-cpa">$0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="tab-closer" class="tab-content d-none fade-in">
                <div class="glass-panel">
                    <h4 class="mb-4">üèÜ Leaderboard de Cierres</h4>
                    <div class="table-responsive">
                        <table class="table-custom" id="table-closers">
                            <thead>
                                <tr>
                                    <th>Closer</th>
                                    <th>Cash Collected</th>
                                    <th>Cierres</th>
                                    <th>Toma Llamadas (Shows)</th>
                                    <th>Show Rate</th>
                                    <th>Close Rate (Sobre Shows)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-math" class="tab-content d-none fade-in">
                <div class="glass-panel">
                    <h4 class="mb-4">üßÆ Simulador de Escenarios (Run Rate)</h4>
                    <div class="row g-4 mt-2">
                        <div class="col-md-4">
                            <div class="p-5 rounded-4 text-center" style="background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.3); box-shadow: inset 0 0 20px rgba(239,68,68,0.05);">
                                <div style="width:60px;height:60px;margin:0 auto 15px;background:rgba(239,68,68,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--neon-danger)"><i class="fas fa-arrow-trend-down"></i></div>
                                <h6 class="text-danger-neon fw-bold mb-3">PESIMISTA (-15%)</h6>
                                <h2 class="mb-2" id="math-pessimistic">$0</h2>
                                <p class="text-muted small mb-0">Si el sistema pierde tracci√≥n</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-5 rounded-4 text-center" style="background: rgba(59, 130, 246, 0.05); border: 1px solid rgba(59, 130, 246, 0.3); box-shadow: inset 0 0 20px rgba(59,130,246,0.05); transform: scale(1.05); z-index: 10;">
                                <div style="width:60px;height:60px;margin:0 auto 15px;background:rgba(59,130,246,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--neon-primary)"><i class="fas fa-crosshairs"></i></div>
                                <h6 class="text-primary fw-bold mb-3" style="color:var(--neon-primary)">REALISTA (Actual)</h6>
                                <h2 class="mb-2" id="math-realistic">$0</h2>
                                <p class="text-muted small mb-0">Proyecci√≥n matem√°tica actual</p>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-5 rounded-4 text-center" style="background: rgba(0, 204, 150, 0.05); border: 1px solid rgba(0, 204, 150, 0.3); box-shadow: inset 0 0 20px rgba(0,204,150,0.05);">
                                <div style="width:60px;height:60px;margin:0 auto 15px;background:rgba(0,204,150,0.1);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;color:var(--neon-success)"><i class="fas fa-rocket"></i></div>
                                <h6 class="text-success-neon fw-bold mb-3">OPTIMISTA (+15%)</h6>
                                <h2 class="mb-2" id="math-optimistic">$0</h2>
                                <p class="text-muted small mb-0">Si optimizamos cuellos de botella</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <script>
        // CONFIG URls
        const URL_BUDGET_DIC = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQGOLgPTDLie5gEbkViCbpebWfN9S_eb2h2GGlpWLjmfVgzfnwR_ncVTs4IqmKgmAFfxZTQHJlMBrIi/pub?output=csv";
        const URL_BUDGET_2026 = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQKTt_taqoH2qNwWbs3t4doLsi0SuGavgdUNvpCKrqtlp5U9GaTqkTt9q-c1eWBnvPN88Qg5t0vXzK/pub?gid=692917105&single=true&output=csv";
        const URL_LEADS_ALL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjCMjoi7DXiCeBRQdzAQZlx_L6SfpmbLlqmeRgZDHmCEdmN5_grVD_Yqa-5tzNprDS02o98ms80j1x/pub?gid=0&single=true&output=csv";
        const URL_LEADS_QUAL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTjCMjoi7DXiCeBRQdzAQZlx_L6SfpmbLlqmeRgZDHmCEdmN5_grVD_Yqa-5tzNprDS02o98ms80j1x/pub?gid=1272057128&single=true&output=csv";
        const URL_VENTAS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQuXaPCen61slzpr1TElxXoCROIxAgmgWT7pyWvel1dxq_Z_U1yZPrVrTbJfx9MwaL8_cluY3v2ywoB/pub?gid=0&single=true&output=csv";

        // STATE
        let rawData = { budget: [], leadsAll: [], leadsQual: [], ventas: [] };
        let filtered = {};
        let datePicker;

        // --- UTILS ---
        const fmtMoney = v => "$" + v.toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0});
        const parseMoney = v => parseFloat((v || "0").toString().replace(/[$,]/g, '')) || 0;
        
        // Theme Toggle Logic
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            
            const icon = document.querySelector('#themeBtn i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            
            // Switch Flatpickr theme dynamically
            document.getElementById('flatpickr-theme').href = newTheme === 'dark' ? 
                'https://npmcdn.com/flatpickr/dist/themes/dark.css' : 'https://npmcdn.com/flatpickr/dist/themes/light.css';

            // Redraw charts to match theme
            setTimeout(updateDashboard, 50);
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('d-none'));
            document.getElementById(tabId).classList.remove('d-none');
            
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            window.dispatchEvent(new Event('resize'));
        }

        function toggleSidebar() {
            document.body.classList.toggle('collapsed');
            setTimeout(() => window.dispatchEvent(new Event('resize')), 400);
        }

        // --- INIT FLATPCIKR ---
        function initDatePicker() {
            datePicker = flatpickr("#customDateRange", {
                mode: "range",
                dateFormat: "Y-m-d",
                locale: "es",
                onChange: function(selectedDates) {
                    if(selectedDates.length === 2) updateDashboard();
                }
            });

            document.getElementById('filtroTiempo').addEventListener('change', function(e) {
                const customContainer = document.getElementById('customDateContainer');
                if(e.target.value === 'custom') {
                    customContainer.classList.remove('d-none');
                    datePicker.open();
                } else {
                    customContainer.classList.add('d-none');
                    updateDashboard();
                }
            });
        }

        // --- DATA PROCESSING ---
        async function init() {
            initDatePicker();
            const ts = Date.now();
            try {
                const [resB1, resB2, resLA, resLQ, resV] = await Promise.all([
                    fetch(URL_BUDGET_DIC + "&t=" + ts).then(r => r.text()),
                    fetch(URL_BUDGET_2026 + "&t=" + ts).then(r => r.text()),
                    fetch(URL_LEADS_ALL + "&t=" + ts).then(r => r.text()),
                    fetch(URL_LEADS_QUAL + "&t=" + ts).then(r => r.text()),
                    fetch(URL_VENTAS + "&t=" + ts).then(r => r.text())
                ]);

                // Parser Logic (Manteniendo tu core intacto)
                const b1 = Papa.parse(resB1, {header:true, skipEmptyLines:true}).data;
                const b2 = Papa.parse(resB2, {header:true, skipEmptyLines:true}).data;
                
                let budgetClean = [];
                b1.forEach(r => {
                    let date = moment(r['Fecha'], "DD/MM/YYYY");
                    if(date.isValid()) budgetClean.push({ fecha: date, gasto: parseMoney(r['Gasto']), clics: parseMoney(r['Clics'] || 0), visitas: parseMoney(r['Visitas'] || 0) });
                });
                b2.forEach(r => {
                    let date = moment(r['Day']); 
                    if(!date.isValid()) date = moment(r['Day'], "DD/MM/YYYY");
                    if(date.isValid()) budgetClean.push({ fecha: date, gasto: parseMoney(r['Amount spent'] || r['Gasto']), clics: parseMoney(r['Link clicks'] || r['Clics']), visitas: parseMoney(r['Landing page views'] || r['Visitas']) });
                });
                rawData.budget = budgetClean.sort((a,b) => a.fecha - b.fecha);

                const processLeads = (csv) => Papa.parse(csv, {header:true, skipEmptyLines:true}).data.map(r => {
                    let d = moment(r['Fecha Creaci√≥n'] || r['Fecha'], "DD/MM/YYYY");
                    return d.isValid() ? { fecha: d, ...r } : null;
                }).filter(x => x);
                rawData.leadsAll = processLeads(resLA);
                rawData.leadsQual = processLeads(resLQ);

                rawData.ventas = Papa.parse(resV, {header:true, skipEmptyLines:true}).data.map(r => {
                    let d = moment(r['Fecha'], "DD/MM/YYYY");
                    if(!d.isValid()) return null;
                    
                    let res = (r['Resultado'] || "").toLowerCase();
                    let estado = "Otro";
                    if(res.includes("venta")) estado = "‚úÖ Venta";
                    else if(res.includes("no show")) estado = "‚ùå No Show";
                    else if(res.includes("descalificado")) estado = "üö´ Descalificado";
                    else if(res.includes("seguimiento")) estado = "üëÄ Seguimiento";
                    else if(res.includes("re-agendado")) estado = "üìÖ Re-Agendado";

                    let asistio = 1;
                    if(res.includes("no show") || res.includes("re-agendado")) asistio = 0;

                    return { fecha: d, monto: parseMoney(r['Monto ($)']), closer: (r['Closer'] || "Sin Asignar").trim(), estadoSimple: estado, asistio: asistio };
                }).filter(x => x);

                populateClosers();
                updateDashboard();

                // UI Transition
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loader').classList.add('d-none');
                    document.getElementById('main-app').classList.remove('d-none');
                }, 500);

            } catch (e) { console.error(e); alert("Error cargando datos master. Revisa la consola."); }
        }

        function populateClosers() {
            const closers = [...new Set(rawData.ventas.map(v => v.closer))].sort();
            const sel = document.getElementById('filtroCloser');
            closers.forEach(c => {
                if(c) { let opt = document.createElement('option'); opt.value = c; opt.innerText = c; sel.appendChild(opt); }
            });
        }

        function getDates(filter) {
            if(filter === 'custom') {
                const dates = datePicker.selectedDates;
                if(dates.length === 2) return { ini: moment(dates[0]), fin: moment(dates[1]) };
                return { ini: moment().startOf('month'), fin: moment() }; // fallback
            }
            
            const hoy = moment();
            let ini, fin;
            switch(filter) {
                case 'hoy': ini = moment(); fin = moment(); break;
                case 'ayer': ini = moment().subtract(1,'d'); fin = moment().subtract(1,'d'); break;
                case 'semana': ini = moment().startOf('isoWeek'); fin = moment(); break;
                case 'mes_actual': ini = moment().startOf('month'); fin = moment(); break;
                case 'mes_anterior': ini = moment().subtract(1,'month').startOf('month'); fin = moment().subtract(1,'month').endOf('month'); break;
                case '30dias': ini = moment().subtract(30,'d'); fin = moment(); break;
                default: ini = moment().startOf('month'); fin = moment();
            }
            return { ini, fin };
        }

        // --- CORE LOGIC ---
        function updateDashboard() {
            const filterTime = document.getElementById('filtroTiempo').value;
            const filterCloser = document.getElementById('filtroCloser').value;
            const metaFact = parseFloat(document.getElementById('metaFact').value) || 30000;
            const metaAds = parseFloat(document.getElementById('metaAds').value) || 5000;

            const { ini, fin } = getDates(filterTime);
            document.getElementById('rangoFechasTexto').innerText = `${ini.format("DD MMM YYYY")} ‚ûî ${fin.format("DD MMM YYYY")}`;

            const checkDate = (d) => d.isSameOrAfter(ini, 'day') && d.isSameOrBefore(fin, 'day');
            
            filtered.budget = rawData.budget.filter(x => checkDate(x.fecha));
            filtered.leadsAll = rawData.leadsAll.filter(x => checkDate(x.fecha));
            filtered.leadsQual = rawData.leadsQual.filter(x => checkDate(x.fecha));
            filtered.ventas = rawData.ventas.filter(x => checkDate(x.fecha));
            
            if(filterCloser !== "Todos") {
                filtered.ventas = filtered.ventas.filter(x => x.closer === filterCloser);
                filtered.budget = []; 
            }

            // Calc KPIs
            const facturacion = filtered.ventas.reduce((sum, v) => sum + v.monto, 0);
            const gastoAds = (filterCloser === "Todos") ? filtered.budget.reduce((sum, b) => sum + b.gasto, 0) : 0;
            const profit = facturacion - gastoAds;
            const roas = gastoAds > 0 ? facturacion / gastoAds : 0;

            const leadsTotal = filtered.leadsAll.length;
            const leadsQual = filtered.leadsQual.length;
            const agendas = filtered.ventas.length;
            const ventas = filtered.ventas.filter(v => v.estadoSimple === "‚úÖ Venta").length;
            
            // Calc Metrics VSL
            const cpl = leadsTotal > 0 ? gastoAds / leadsTotal : 0;
            const cpag = agendas > 0 ? gastoAds / agendas : 0;
            const cac = ventas > 0 ? gastoAds / ventas : 0;

            // DOM Updates Main
            document.getElementById('kpi-facturacion').innerText = fmtMoney(facturacion);
            document.getElementById('delta-facturacion').innerHTML = `<i class="fas fa-chart-line me-1"></i> ${((facturacion/metaFact)*100).toFixed(1)}% Alcanzado`;
            document.getElementById('kpi-ads').innerText = fmtMoney(gastoAds);
            document.getElementById('delta-ads').innerHTML = `<i class="fas fa-wallet me-1"></i> Restante: ${fmtMoney(metaAds - gastoAds)}`;
            document.getElementById('kpi-profit').innerText = fmtMoney(profit);
            document.getElementById('kpi-roas').innerHTML = `${roas.toFixed(2)}x`;
            
            const roasColor = roas >= 3 ? 'text-success-neon' : 'text-danger-neon';
            const roasIcon = roas >= 3 ? 'fa-arrow-up' : 'fa-arrow-down';
            document.getElementById('delta-roas').innerHTML = `<span class="${roasColor}"><i class="fas ${roasIcon} me-1"></i> ${(roas-3).toFixed(1)} vs KPI Base(3x)</span>`;

            // Tab CEO
            document.getElementById('ceo-falta').innerText = fmtMoney(Math.max(metaFact - facturacion, 0));
            document.getElementById('ceo-progress').style.width = Math.min((facturacion/metaFact)*100, 100) + "%";
            
            const daysInMonth = moment().daysInMonth();
            const dayOfMonth = moment().date();
            const runRate = (dayOfMonth > 0 && filterTime === 'mes_actual') ? (facturacion / dayOfMonth) * daysInMonth : facturacion;
            document.getElementById('ceo-proyeccion').innerText = fmtMoney(runRate);

            const daysRange = fin.diff(ini, 'days') + 1;
            const dailySpend = daysRange > 0 ? gastoAds / daysRange : 0;
            const remainingDays = Math.max(daysInMonth - dayOfMonth, 0);
            const suggestedSpend = remainingDays > 0 ? Math.max(metaAds - gastoAds, 0) / remainingDays : 0;
            document.getElementById('ceo-diario').innerHTML = `${fmtMoney(dailySpend)} <span style="font-size:1rem;color:var(--text-muted)">/d√≠a</span>`;
            document.getElementById('ceo-sugerido').innerText = `Sugerido: ${fmtMoney(suggestedSpend)}/d√≠a`;

            // Bottleneck Alerts System
            let alertsHTML = '';
            if(cpl > 15) alertsHTML += `<div class="alert-card alert-danger"><i class="fas fa-exclamation-triangle"></i> CPL ALTO: El Costo por Lead (${fmtMoney(cpl)}) est√° por encima del KPI ($15). Revisa los creativos.</div>`;
            else if (cpl > 0) alertsHTML += `<div class="alert-card alert-success"><i class="fas fa-check-circle"></i> CPL SALUDABLE: Lead a buen costo (${fmtMoney(cpl)}). Considera escalar.</div>`;
            
            if(cpag > 150) alertsHTML += `<div class="alert-card alert-danger"><i class="fas fa-phone-slash"></i> PROBLEMA EN VSL: Las agendas est√°n saliendo caras (${fmtMoney(cpag)}). Revisa la Tasa de Conversi√≥n de Lead a Agenda.</div>`;
            document.getElementById('bottleneck-container').innerHTML = alertsHTML;

            // Tab Funnel Costs
            document.getElementById('kpi-cpl').innerText = fmtMoney(cpl);
            document.getElementById('kpi-cpag').innerText = fmtMoney(cpag);
            document.getElementById('kpi-cpa').innerText = fmtMoney(cac);

            // Tab Math
            document.getElementById('math-pessimistic').innerText = fmtMoney(runRate * 0.85);
            document.getElementById('math-realistic').innerText = fmtMoney(runRate);
            document.getElementById('math-optimistic').innerText = fmtMoney(runRate * 1.15);

            // --- RENDER CHARTS ---
            const themeColors = document.documentElement.getAttribute('data-theme') === 'light' ? 
                { font: '#334155', grid: 'rgba(0,0,0,0.05)' } : { font: '#94a3b8', grid: 'rgba(255,255,255,0.05)' };

            renderActivityChart(filtered.ventas, filtered.leadsAll, themeColors);
            renderVSLFunnel(gastoAds, leadsTotal, agendas, ventas, themeColors);
            renderClosers(filtered.ventas);
        }

        // --- PRO CHARTS ---
        function getChartLayoutBase(themeColors) {
            return {
                paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Plus Jakarta Sans', color: themeColors.font },
                margin: { t: 20, l: 50, r: 50, b: 40 }, hovermode: 'x unified'
            };
        }

        function renderActivityChart(ventas, leads, theme) {
            let dataMap = {};
            leads.forEach(l => { let d = l.fecha.format("YYYY-MM-DD"); if(!dataMap[d]) dataMap[d]={fact:0, leads:0}; dataMap[d].leads++; });
            ventas.forEach(v => { let d = v.fecha.format("YYYY-MM-DD"); if(!dataMap[d]) dataMap[d]={fact:0, leads:0}; dataMap[d].fact+=v.monto; });

            let dates = Object.keys(dataMap).sort();
            let yFact = dates.map(d => dataMap[d].fact);
            let yLeads = dates.map(d => dataMap[d].leads);

            let trace1 = { x: dates, y: yLeads, name: 'Leads In', type: 'scatter', mode: 'lines', line: { color: '#3b82f6', width: 3, shape: 'spline' }, fill: 'tozeroy', fillcolor: 'rgba(59, 130, 246, 0.1)', yaxis: 'y2' };
            let trace2 = { x: dates, y: yFact, name: 'Cash ($)', type: 'scatter', mode: 'lines+markers', line: { color: '#00CC96', width: 4, shape: 'spline' }, marker: { size: 8, color: '#00CC96', line: {color:'#fff', width:2} } };

            let layout = getChartLayoutBase(theme);
            layout.legend = { orientation: 'h', y: 1.15, x:0.5, xanchor:'center' };
            layout.xaxis = { showgrid: false, tickformat: '%d %b' };
            layout.yaxis = { showgrid: true, gridcolor: theme.grid, title: 'Cash ($)', zeroline: false };
            layout.yaxis2 = { overlaying: 'y', side: 'right', showgrid: false, title: 'Volumen Leads', zeroline: false };

            Plotly.newPlot('chart-activity', [trace1, trace2], layout, { responsive: true, displayModeBar: false });
        }

        function renderVSLFunnel(spend, leads, agendas, ventas, theme) {
            // Embudos de Plotly son perfectos para VSL
            let data = [{
                type: 'funnel',
                y: ["Inversi√≥n", "Opt-ins (Leads)", "Agendas (Calls)", "Cierres (Won)"],
                x: [spend, leads, agendas, ventas],
                textinfo: "value+percent initial",
                hoverinfo: "x+percent previous+percent initial",
                marker: {
                    color: ["#1e293b", "#3b82f6", "#f59e0b", "#00CC96"],
                    line: { width: [0, 0, 0, 0] }
                },
                connector: {line: {color: theme.grid, dash: "dot", width: 2}}
            }];

            let layout = getChartLayoutBase(theme);
            layout.margin = { t: 20, l: 150, r: 20, b: 20 };

            Plotly.newPlot('chart-funnel', data, layout, { responsive: true, displayModeBar: false });
        }

        function renderClosers(ventas) {
            let rank = {};
            ventas.forEach(v => {
                let c = v.closer;
                if(!rank[c]) rank[c] = {fact:0, ventas:0, agendas:0, shows:0};
                rank[c].fact += v.monto;
                rank[c].agendas++;
                rank[c].shows += v.asistio;
                if(v.estadoSimple === "‚úÖ Venta") rank[c].ventas++;
            });

            let tbody = document.querySelector("#table-closers tbody");
            tbody.innerHTML = "";
            
            Object.keys(rank).sort((a,b) => rank[b].fact - rank[a].fact).forEach(k => {
                let r = rank[k];
                let showRate = r.agendas > 0 ? (r.shows/r.agendas)*100 : 0;
                let closeRate = r.shows > 0 ? (r.ventas/r.shows)*100 : 0;
                
                tbody.innerHTML += `
                    <tr>
                        <td class="fw-bold"><i class="fas fa-user-tie me-2 text-muted"></i> ${k}</td>
                        <td class="text-success-neon fw-bold" style="font-family:'Space Grotesk'; font-size:1.1rem;">${fmtMoney(r.fact)}</td>
                        <td>${r.ventas}</td>
                        <td>${r.shows} <span class="text-muted small">/ ${r.agendas}</span></td>
                        <td>
                            <div class="d-flex align-items-center"><span style="width: 40px; font-weight:700;">${showRate.toFixed(0)}%</span>
                            <div class="progress w-100 ms-2" style="height:6px; background:var(--glass-border)"><div class="progress-bar bg-warning" style="width:${showRate}%"></div></div></div>
                        </td>
                        <td>
                            <div class="d-flex align-items-center"><span style="width: 40px; font-weight:700;">${closeRate.toFixed(0)}%</span>
                            <div class="progress w-100 ms-2" style="height:6px; background:var(--glass-border)"><div class="progress-bar" style="width:${closeRate}%; background:#00CC96;"></div></div></div>
                        </td>
                    </tr>
                `;
            });
        }

        // Start
        document.getElementById('filtroCloser').addEventListener('change', updateDashboard);
        init();

    </script>
</body>
</html>
