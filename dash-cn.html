<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agency Command Center üöÄ</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        :root {
            /* --- PALETA DE COLORES --- */
            --bg-body: #050b14;
            --bg-panel: rgba(17, 24, 39, 0.7);
            --bg-sidebar: #0b1121;
            --glass-border: rgba(255, 255, 255, 0.05);

            --neon-blue: #3b82f6;
            --neon-purple: #8b5cf6;
            --neon-green: #10b981;
            --neon-red: #ef4444;
            --neon-orange: #f59e0b;

            --text-main: #f1f5f9;
            --text-muted: #64748b;

            /* --- DIMENSIONES --- */
            --sidebar-width: 280px;
            --sidebar-width-collapsed: 80px;
            --transition-speed: 0.4s;
        }

        body {
            background-color: var(--bg-body);
            background-image:
                radial-gradient(circle at 0% 0%, rgba(59, 130, 246, 0.15), transparent 40%),
                radial-gradient(circle at 100% 0%, rgba(139, 92, 246, 0.1), transparent 40%),
                radial-gradient(circle at 100% 100%, rgba(16, 185, 129, 0.05), transparent 40%);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            margin: 0;
            overflow-x: hidden;
        }

        /* --- LAYOUT & TRANSITIONS --- */
        .wrapper {
            display: flex;
            width: 100%;
            transition: all var(--transition-speed) ease;
        }

        /* SIDEBAR ESTILOS */
        .sidebar {
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--glass-border);
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            padding: 20px;
            overflow-y: auto;
            transition: width var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
        }

        .main-content {
            margin-left: var(--sidebar-width);
            width: calc(100% - var(--sidebar-width));
            padding: 40px;
            transition: margin-left var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1), width var(--transition-speed) cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ESTADO CONTRA√çDO (COLLAPSED) */
        body.collapsed .sidebar {
            width: var(--sidebar-width-collapsed);
            padding: 20px 10px;
        }

        body.collapsed .sidebar .hide-on-collapse {
            display: none !important;
            opacity: 0;
        }

        body.collapsed .sidebar .sidebar-header {
            justify-content: center;
        }

        body.collapsed .main-content {
            margin-left: var(--sidebar-width-collapsed);
            width: calc(100% - var(--sidebar-width-collapsed));
        }

        /* --- PANELES DE CRISTAL (GLASSMORPHISM) --- */
        .glass-panel {
            background: var(--bg-panel);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
            position: relative;
            overflow: hidden;
        }

        /* L√≠nea superior degradada en paneles */
        .glass-panel::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        }

        /* --- TIPOGRAF√çA Y ELEMENTOS --- */
        h1, h2, h3, h4, h5 {
            color: white;
            font-weight: 800;
            letter-spacing: -0.02em;
        }

        .text-muted {
            color: var(--text-muted) !important;
        }

        .metric-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 8px;
            display: block;
        }

        .metric-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: white;
            line-height: 1;
            background: -webkit-linear-gradient(90deg, #fff, #94a3b8);
            -webkit-background-clip: text;
        }

        /* INPUTS Y SELECTS */
        select, input {
            background: rgba(255, 255, 255, 0.03) !important;
            border: 1px solid var(--glass-border) !important;
            color: white !important;
            border-radius: 12px !important;
            padding: 12px !important;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        select:focus, input:focus {
            border-color: var(--neon-blue) !important;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.3) !important;
            outline: none;
            background: rgba(255, 255, 255, 0.05) !important;
        }

        /* BOTONES */
        .btn-toggle {
            background: transparent;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            margin-bottom: 20px;
            transition: 0.3s;
        }

        .btn-toggle:hover {
            color: var(--neon-blue);
            transform: scale(1.1);
        }

        .btn-glow {
            background: linear-gradient(135deg, var(--neon-blue), #2563eb);
            border: none;
            color: white;
            padding: 14px;
            border-radius: 12px;
            font-weight: 700;
            width: 100%;
            letter-spacing: 0.5px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(59, 130, 246, 0.4);
            transition: all 0.3s;
        }

        .btn-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(59, 130, 246, 0.6);
        }

        .btn-outline {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--glass-border);
            color: var(--text-muted);
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .btn-outline:hover {
            border-color: var(--text-main);
            color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        /* TABLA PERSONALIZADA */
        .table-custom {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0 10px;
        }

        .table-custom th {
            text-align: left;
            padding: 15px;
            color: var(--text-muted);
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--glass-border);
        }

        .table-custom td {
            background: rgba(255, 255, 255, 0.02);
            padding: 20px 15px;
            font-weight: 500;
            border-top: 1px solid rgba(255, 255, 255, 0.02);
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }

        .table-custom tr td:first-child {
            border-top-left-radius: 12px;
            border-bottom-left-radius: 12px;
            border-left: 1px solid rgba(255, 255, 255, 0.02);
        }

        .table-custom tr td:last-child {
            border-top-right-radius: 12px;
            border-bottom-right-radius: 12px;
            border-right: 1px solid rgba(255, 255, 255, 0.02);
        }

        .table-custom tr:hover td {
            background: rgba(255, 255, 255, 0.06);
            transform: translateY(-2px);
            transition: 0.3s;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* LOADER (ANIMACI√ìN DE CARGA) */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-body);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .loader-ring {
            width: 60px;
            height: 60px;
            border: 4px solid rgba(59, 130, 246, 0.2);
            border-top: 4px solid var(--neon-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg-body); }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* ANIMACIONES DE ENTRADA */
        .fade-up {
            animation: fadeUp 0.6s ease forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        @keyframes fadeUp {
            to { opacity: 1; transform: translateY(0); }
        }
    </style>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
</head>

<body>

    <div id="loader">
        <div class="loader-ring"></div>
        <h4 style="letter-spacing: 4px; font-weight: 300;">AGENCY Creamos Negocios</h4>
    </div>

    <div class="wrapper d-none" id="main-app">

        <nav class="sidebar">
            <div class="d-flex justify-content-between align-items-center mb-4 sidebar-header">
                <div class="d-flex align-items-center hide-on-collapse">
                    <div style="width: 32px; height: 32px; background: var(--neon-blue); border-radius: 8px; display:flex; align-items:center; justify-content:center; margin-right: 12px; box-shadow: 0 0 15px var(--neon-blue);">
                        <i class="fas fa-rocket text-white" style="font-size: 14px;"></i>
                    </div>
                    <span style="font-weight: 700; letter-spacing: 1px;">CN</span>
                </div>
                <button class="btn-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            </div>

            <div class="hide-on-collapse">
                <label class="metric-label">Panel de Control</label>
                <button class="btn-outline mb-4" onclick="location.reload()">
                    <i class="fas fa-sync-alt me-2"></i> Refrescar Data
                </button>

                <label class="metric-label">Filtros de Tiempo</label>
                <select id="filtroTiempo" class="form-select mb-4">
                    <option value="mes_actual">üìÖ Este Mes</option>
                    <option value="mes_anterior">‚èÆÔ∏è Mes Anterior</option>
                    <option value="hoy">üî• Hoy</option>
                    <option value="ayer">‚è™ Ayer</option>
                    <option value="semana">üìÜ Esta Semana</option>
                    <option value="30dias">üóìÔ∏è √öltimos 30 d√≠as</option>
                    <option value="historico">üíæ Todo el Hist√≥rico</option>
                </select>

                <label class="metric-label">Equipo</label>
                <select id="filtroCloser" class="form-select mb-4">
                    <option value="Todos">üë§ Todos los Closers</option>
                </select>

                <hr style="border-color: var(--glass-border); margin: 20px 0;">

                <label class="metric-label">Metas ($)</label>
                <div class="mb-2">
                    <input type="number" id="metaFact" class="form-control" value="30000" placeholder="Meta Facturaci√≥n">
                </div>
                <div class="mb-4">
                    <input type="number" id="metaAds" class="form-control" value="3500" placeholder="Budget Ads">
                </div>
                <button class="btn-glow" onclick="updateDashboard()">
                    APLICAR METAS
                </button>

                <div class="mt-auto pt-5 text-center text-muted" style="font-size: 0.7rem;">
                    v2.0.4 PRO
                </div>
            </div>
        </nav>

        <main class="main-content">

            <div class="d-flex justify-content-between align-items-end mb-5 fade-up" style="animation-delay: 0.1s;">
                <div>
                    <h1 class="display-5 mb-1">Dashboard Creamos Negocios</h1>
                    <p class="text-muted mb-0" style="font-family: monospace;" id="rangoFechasTexto">Iniciando sistema...</p>
                </div>
                <div>
                    <span class="badge" style="background: rgba(16, 185, 129, 0.1); color: var(--neon-green); border: 1px solid rgba(16, 185, 129, 0.2); padding: 8px 16px; border-radius: 20px;">
                        <i class="fas fa-dot-circle me-2 fa-beat-fade"></i> LIVE FEED
                    </span>
                </div>
            </div>

            <div id="proyeccionesContainer" class="row mb-4 fade-up" style="animation-delay: 0.2s;"></div>

            <div class="glass-panel fade-up" style="animation-delay: 0.3s; padding: 40px;">
                <h4 class="mb-4"><i class="fas fa-chart-line me-2" style="color: var(--neon-blue);"></i>Performance Financiero</h4>
                <div class="row g-4">
                    <div class="col-md-2" style="width: 20%;">
                        <span class="metric-label">Facturaci√≥n</span>
                        <div class="metric-value" id="kpi-facturacion">$0</div>
                        <small class="text-muted"><i class="fas fa-arrow-up text-success"></i> Buen Revenue</small>
                    </div>
                    <div class="col-md-2" style="width: 20%;">
                        <span class="metric-label">Profit (Neto)</span>
                        <div class="metric-value" style="background: -webkit-linear-gradient(90deg, #4ade80, #22c55e); -webkit-background-clip: text;" id="kpi-profit">$0</div>
                        <small class="text-muted">Liquid Cash</small>
                    </div>
                    <div class="col-md-2" style="width: 20%;">
                        <span class="metric-label">ROAS</span>
                        <div class="metric-value" id="kpi-roas">0.00x</div>
                        <small class="text-muted">META: 5x</small>
                    </div>
                    <div class="col-md-2" style="width: 20%;">
                        <span class="metric-label">Clientes</span>
                        <div class="metric-value" id="kpi-ventas">0</div>
                        <small class="text-muted">Ventas cerradas</small>
                    </div>
                    <div class="col-md-2" style="width: 20%;">
                        <span class="metric-label">Inversi√≥n</span>
                        <div class="metric-value" style="background: -webkit-linear-gradient(90deg, #f87171, #ef4444); -webkit-background-clip: text;" id="kpi-ads">$0</div>
                        <small class="text-muted">Ad spend</small>
                    </div>
                </div>
            </div>

            <div class="row mb-4 fade-up" style="animation-delay: 0.4s;">
                <div class="col-md-3">
                    <div class="glass-panel d-flex justify-content-between align-items-center h-100">
                        <div>
                            <span class="metric-label">Leads √önicos</span>
                            <div class="h2 text-white mb-0" id="kpi-leads">0</div>
                        </div>
                        <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.05); border-radius: 50%; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-users text-muted"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-panel d-flex justify-content-between align-items-center h-100">
                        <div>
                            <span class="metric-label">Asistencias</span>
                            <div class="h2 text-white mb-0" id="kpi-asistencias">0</div>
                        </div>
                        <div style="width: 50px; height: 50px; background: rgba(255,255,255,0.05); border-radius: 50%; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-handshake text-muted"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-panel d-flex justify-content-between align-items-center h-100">
                        <div>
                            <span class="metric-label">Tasa Asistencia</span>
                            <div class="h2 text-white mb-0" id="kpi-tasa-asistencia">0%</div>
                        </div>
                        <div style="width: 50px; height: 50px; background: rgba(59, 130, 246, 0.1); border-radius: 50%; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-percent" style="color: var(--neon-blue);"></i>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="glass-panel d-flex justify-content-between align-items-center h-100">
                        <div>
                            <span class="metric-label">Tasa Cierre</span>
                            <div class="h2 text-white mb-0" id="kpi-tasa-cierre">0%</div>
                        </div>
                        <div style="width: 50px; height: 50px; background: rgba(16, 185, 129, 0.1); border-radius: 50%; display:flex; align-items:center; justify-content:center;">
                            <i class="fas fa-check" style="color: var(--neon-green);"></i>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel fade-up" style="animation-delay: 0.5s;">
                <div class="d-flex justify-content-between mb-4">
                    <h5 class="mb-0">üåä Flujo Diario de Leads</h5>
                    <button class="btn btn-sm btn-outline-secondary" style="border:1px solid var(--glass-border); color: var(--text-muted);"><i class="fas fa-expand"></i></button>
                </div>
                <div id="chart-daily-status" style="height: 400px; width: 100%;"></div>
            </div>

            <div class="glass-panel fade-up" style="animation-delay: 0.6s;">
                <div class="d-flex justify-content-between mb-4">
                    <h5 class="mb-0">üí∏ Din√°mica Financiera (Ingreso vs Gasto)</h5>
                    <span class="badge bg-dark border border-secondary text-muted">Estado Financiero</span>
                </div>
                <div id="chart-finance" style="height: 400px; width: 100%;"></div>
            </div>

            <div class="glass-panel fade-up" style="animation-delay: 0.7s;">
                <h5 class="mb-4">üèÜ Top Closers</h5>
                <div class="table-responsive">
                    <table class="table-custom" id="tabla-ranking">
                        <thead>
                            <tr>
                                <th>Closer</th>
                                <th>Facturaci√≥n</th>
                                <th>Asistencias</th>
                                <th>Ventas</th>
                                <th>Closed rate</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <footer class="text-center text-muted mt-5 mb-3 fade-up" style="animation-delay: 0.8s; opacity: 0.5; font-size: 0.8rem;">
                Agency Creamos Negocios ‚Ä¢ By Alvaro MV
            </footer>

        </main>
    </div>

    <script>
        // --- A. CONFIGURACI√ìN DE URLS (EDITAR AQU√ç LOS LINKS) ---
        const URL_VENTAS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQuXaPCen61slzpr1TElxXoCROIxAgmgWT7pyWvel1dxq_Z_U1yZPrVrTbJfx9MwaL8_cluY3v2ywoB/pub?gid=0&single=true&output=csv";
        const URL_GASTOS_DIC = "https://docs.google.com/spreadsheets/d/e/2PACX-1vGOLgPTDLie5gEbkViCbpebWfN9S_eb2h2GGlpWLjmfVgzfnwR_ncVTs4IqmKgmAFfxZTQHJlMBrIi/pub?gid=0&single=true&output=csv";
        const URL_GASTOS_ANUAL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTQKTt_taqoH2qNwWbs3t4doLsi0SuGavgdUNvpCKrqtlp5U9GaTqkTt9q-c1eWBnvPN88Qg5t0vXzK/pub?output=csv";

        // --- B. VARIABLES DE ESTADO ---
        let rawDataVentas = [], rawDataGastos = [], filteredVentas = [], filteredGastos = [];

        // --- C. FUNCIONES DE INTERFAZ (UI) ---
        
        // Colapsar Sidebar
        function toggleSidebar() {
            document.body.classList.toggle('collapsed');
            // Redimensionar gr√°ficos de Plotly al cambiar el ancho
            setTimeout(() => {
                window.dispatchEvent(new Event('resize'));
            }, 450);
        }

        // Animaci√≥n de n√∫meros
        function animateValue(obj, start, end, duration, isMoney = false, isPercent = false) {
            let startTimestamp = null;
            const step = (timestamp) => {
                if (!startTimestamp) startTimestamp = timestamp;
                const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                let currentVal = Math.floor(progress * (end - start) + start);

                if (isMoney) obj.innerHTML = fmtMoney(currentVal);
                else if (isPercent) obj.innerHTML = (progress * (end - start) + start).toFixed(1) + "%";
                else obj.innerHTML = currentVal.toLocaleString();

                if (progress < 1) window.requestAnimationFrame(step);
                else {
                    if (isMoney) obj.innerHTML = fmtMoney(end);
                    else if (isPercent) obj.innerHTML = end.toFixed(1) + "%";
                    else obj.innerHTML = end.toLocaleString();
                }
            };
            window.requestAnimationFrame(step);
        }

        // --- D. INICIALIZACI√ìN Y CARGA DE DATOS ---
        async function init() {
            try {
                const ts = Date.now(); // Cache busting para obligar actualizaci√≥n
                const [resVentas, resG1, resG2] = await Promise.all([
                    fetch(URL_VENTAS + "&t=" + ts).then(r => r.text()),
                    fetch(URL_GASTOS_DIC + "&t=" + ts).then(r => r.text()),
                    fetch(URL_GASTOS_ANUAL + "&t=" + ts).then(r => r.text())
                ]);

                processVentas(resVentas);
                processGastos(resG1, resG2);
                populateClosers();
                updateDashboard();

                // Ocultar Loader
                const loader = document.getElementById('loader');
                loader.style.opacity = '0';
                loader.style.transition = 'opacity 0.5s ease';
                setTimeout(() => {
                    loader.classList.add('d-none');
                    document.getElementById('main-app').classList.remove('d-none');
                }, 500);

            } catch (error) {
                console.error(error);
                alert("Error cr√≠tico conectando a la base de datos.");
            }
        }

        // --- E. PROCESAMIENTO DE DATOS ---

        function processVentas(csvText) {
            const results = Papa.parse(csvText, { header: true, skipEmptyLines: true });
            let data = results.data;
            const keys = results.meta.fields;

            // Reparaci√≥n de filas desplazadas (Bug GHL)
            data = data.map(row => {
                const primerCol = row[keys[0]];
                if (!primerCol || primerCol.trim() === "") {
                    let values = keys.map(k => row[k]);
                    let fixedValues = values.slice(8).concat(new Array(8).fill(""));
                    let newRow = {};
                    keys.forEach((k, i) => newRow[k] = fixedValues[i]);
                    return newRow;
                }
                return row;
            });

            rawDataVentas = data.map(row => {
                let fecha = moment(row['Fecha'], "DD/MM/YYYY");
                if (!fecha.isValid()) fecha = moment(row['Fecha']);
                let monto = parseFloat((row['Monto ($)'] || "0").toString().replace(/[$,]/g, '')) || 0;
                let res = (row['Resultado'] || "Pendiente").toLowerCase();

                let estadoSimple = "Otro/Pendiente";
                if (res.includes("venta")) estadoSimple = "‚úÖ Venta";
                else if (res.includes("no show")) estadoSimple = "‚ùå No Show";
                else if (res.includes("descalificado")) estadoSimple = "üö´ Descalificado";
                else if (res.includes("seguimiento")) estadoSimple = "üëÄ Seguimiento";
                else if (res.includes("re-agendado") || res.includes("reagendado")) estadoSimple = "üìÖ Re-Agendado";

                let esAsistencia = false;
                if (res.includes("venta") || res.includes("seguimiento") || res.includes("descalificado") || (res.includes("asisti√≥") && !res.includes("no show"))) esAsistencia = true;

                return {
                    fecha: fecha,
                    monto: monto,
                    closer: (row['Closer'] || "Sin Asignar").trim(),
                    email: (row['Email'] || row['Lead Name'] || Math.random()).toString().trim().toLowerCase(),
                    estadoSimple: estadoSimple,
                    esAsistencia: esAsistencia
                };
            }).filter(r => r.fecha.isValid());
        }

        function processGastos(csv1, csv2) {
            const p1 = Papa.parse(csv1, { header: true, skipEmptyLines: true }).data;
            const p2 = Papa.parse(csv2, { header: false, skipEmptyLines: true }).data;
            let allGastos = [];

            p1.forEach(r => {
                let f = moment(r['Fecha'], "DD/MM/YYYY");
                let g = parseFloat((r['Gasto'] || "0").toString().replace(/[$,]/g, '')) || 0;
                if (f.isValid()) allGastos.push({ fecha: f, gasto: g });
            });
            p2.forEach(r => {
                if (r[0] === 'Fecha') return;
                let f = moment(r[0]);
                if (!f.isValid()) f = moment(r[0], "DD/MM/YYYY");
                let g = parseFloat((r[1] || "0").toString().replace(/[$,]/g, '')) || 0;
                if (f.isValid()) allGastos.push({ fecha: f, gasto: g });
            });
            rawDataGastos = allGastos.sort((a, b) => a.fecha - b.fecha);
        }

        // Llenar select de Closers
        function populateClosers() {
            const closers = [...new Set(rawDataVentas.map(v => v.closer))].sort();
            const sel = document.getElementById('filtroCloser');
            closers.forEach(c => {
                if (c) {
                    let opt = document.createElement('option');
                    opt.value = c;
                    opt.innerText = c;
                    sel.appendChild(opt);
                }
            });
        }

        // Obtener rango de fechas seg√∫n filtro
        function getDates(filterVal) {
            const hoy = moment();
            let inicio, fin;
            switch (filterVal) {
                case 'hoy': inicio = moment(); fin = moment(); break;
                case 'ayer': inicio = moment().subtract(1, 'days'); fin = moment().subtract(1, 'days'); break;
                case 'semana': inicio = moment().startOf('isoWeek'); fin = moment(); break;
                case 'mes_actual': inicio = moment().startOf('month'); fin = moment(); break;
                case 'mes_anterior': inicio = moment().subtract(1, 'month').startOf('month'); fin = moment().subtract(1, 'month').endOf('month'); break;
                case '30dias': inicio = moment().subtract(30, 'days'); fin = moment(); break;
                case 'historico': inicio = moment('2000-01-01'); fin = moment(); break;
                default: inicio = moment().startOf('month'); fin = moment();
            }
            return { inicio, fin };
        }

        // --- F. ACTUALIZACI√ìN DEL DASHBOARD (C√ÅLCULOS) ---
        function updateDashboard() {
            const filtroTiempo = document.getElementById('filtroTiempo').value;
            const filtroCloser = document.getElementById('filtroCloser').value;
            const metaFact = parseFloat(document.getElementById('metaFact').value) || 0;
            const presAds = parseFloat(document.getElementById('metaAds').value) || 0;

            const { inicio, fin } = getDates(filtroTiempo);
            document.getElementById('rangoFechasTexto').innerText = `DATA RANGE: ${inicio.format("MMM DD").toUpperCase()} - ${fin.format("MMM DD").toUpperCase()}`;

            // Filtrado
            filteredVentas = rawDataVentas.filter(v => v.fecha.isSameOrAfter(inicio, 'day') && v.fecha.isSameOrBefore(fin, 'day'));
            if (filtroCloser !== "Todos") filteredVentas = filteredVentas.filter(v => v.closer === filtroCloser);
            filteredGastos = rawDataGastos.filter(g => g.fecha.isSameOrAfter(inicio, 'day') && g.fecha.isSameOrBefore(fin, 'day'));

            let totalGasto = (filtroCloser === "Todos") ? filteredGastos.reduce((sum, g) => sum + g.gasto, 0) : 0;
            let totalFacturacion = filteredVentas.reduce((sum, v) => sum + v.monto, 0);

            // C√°lculos de KPIs
            const uniqueEmails = [...new Set(filteredVentas.map(v => v.email))];
            const asistenciasSet = new Set(filteredVentas.filter(v => v.esAsistencia).map(v => v.email));
            const ventasSet = new Set(filteredVentas.filter(v => v.estadoSimple === "‚úÖ Venta").map(v => v.email));

            const profit = totalFacturacion - totalGasto;
            const roas = totalGasto > 0 ? (totalFacturacion / totalGasto) : 0;

            // Renderizar N√∫meros
            animateValue(document.getElementById('kpi-facturacion'), 0, totalFacturacion, 1000, true);
            animateValue(document.getElementById('kpi-profit'), 0, profit, 1000, true);
            document.getElementById('kpi-roas').innerHTML = `${roas.toFixed(2)}x`;
            animateValue(document.getElementById('kpi-ventas'), 0, ventasSet.size, 1000);
            animateValue(document.getElementById('kpi-ads'), 0, totalGasto, 1000, true);

            animateValue(document.getElementById('kpi-leads'), 0, uniqueEmails.length, 800);
            animateValue(document.getElementById('kpi-asistencias'), 0, asistenciasSet.size, 800);
            const tasaAsist = uniqueEmails.length > 0 ? (asistenciasSet.size / uniqueEmails.length * 100) : 0;
            const tasaCierre = asistenciasSet.size > 0 ? (ventasSet.size / asistenciasSet.size * 100) : 0;
            animateValue(document.getElementById('kpi-tasa-asistencia'), 0, tasaAsist, 800, false, true);
            animateValue(document.getElementById('kpi-tasa-cierre'), 0, tasaCierre, 800, false, true);

            // Llamar a renderizadores visuales
            renderProjections(filtroTiempo, totalFacturacion, metaFact, presAds, totalGasto);
            renderCharts(filteredVentas, filteredGastos, filtroCloser);
            renderTable(filteredVentas);
        }

        // --- G. RENDERIZADORES DE GR√ÅFICOS Y TABLAS ---

        // Renderizar Proyecciones
        function renderProjections(filtro, fact, meta, presAds, gasto) {
            const div = document.getElementById('proyeccionesContainer');
            if (filtro !== "mes_actual") { div.innerHTML = ""; return; }

            const hoy = moment();
            const diasMes = hoy.daysInMonth();
            const diaHoy = hoy.date();
            const restante = diasMes - diaHoy;

            const proy = (diaHoy > 0) ? (fact / diaHoy) * diasMes : 0;
            const budgetRest = Math.max(presAds - gasto, 0);
            const pace = restante > 0 ? budgetRest / restante : 0;

            div.innerHTML = `
                <div class="col-md-4">
                    <div class="glass-panel" style="background: rgba(59, 130, 246, 0.05); border-color: rgba(59, 130, 246, 0.2);">
                        <h6 class="text-white">PROJECTED REVENUE</h6>
                        <div class="d-flex justify-content-between align-items-end">
                            <h2 class="mb-0 text-white">${fmtMoney(proy)}</h2>
                            <small class="text-muted">Meta: ${fmtMoney(meta)}</small>
                        </div>
                        <div class="progress mt-3" style="height: 6px; background: rgba(0,0,0,0.3);">
                            <div class="progress-bar bg-primary" style="width: ${Math.min((fact/meta)*100, 100)}%"></div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-panel">
                        <h6 class="text-white">POR FACTURAR</h6>
                        <h2 class="mb-0 text-warning">${fmtMoney(Math.max(meta - fact, 0))}</h2>
                        <small class="text-muted">Push required for last ${restante} days</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="glass-panel">
                        <h6 class="text-white">Inversi√≥n ADS(DAILY)</h6>
                        <h2 class="mb-0 text-info">${fmtMoney(pace)}</h2>
                        <small class="text-muted">Por Invertir: ${fmtMoney(budgetRest)}</small>
                    </div>
                </div>
            `;
        }

        // Renderizar Gr√°ficos (Plotly)
        function renderCharts(ventas, gastos, closerSel) {
            // GR√ÅFICO 1: FLUJO LEADS (VERSI√ìN PRO)
            let statusData = {};
            ventas.forEach(v => {
                let d = v.fecha.format("YYYY-MM-DD");
                if (!statusData[d]) statusData[d] = {};
                if (!statusData[d][v.estadoSimple]) statusData[d][v.estadoSimple] = 0;
                statusData[d][v.estadoSimple]++;
            });

            let sortedDates = Object.keys(statusData).sort();
            let datasets = [];
            
            // Colores ajustados (Opcional: puedes mantener los tuyos, estos tienen un poco m√°s de vibrancia)
            const colors = {
                "‚úÖ Venta": "#10b981", 
                "‚ùå No Show": "#ef4444", 
                "üö´ Descalificado": "#f59e0b",
                "üëÄ Seguimiento": "#3b82f6", 
                "üìÖ Re-Agendado": "#8b5cf6", 
                "Otro/Pendiente": "#94a3b8"
            };

            // Orden espec√≠fico para que las Ventas queden visualmente en la base o tope (seg√∫n prefieras)
            // Aqu√≠ iteramos normal, pero el 'stackgroup' se encarga de apilar
            Object.keys(colors).forEach(status => {
                let y = sortedDates.map(d => statusData[d][status] || 0);
                
                datasets.push({
                    x: sortedDates,
                    y: y,
                    name: status,
                    mode: 'lines', // Cambiado de 'none' a 'lines' para pintar el borde suave
                    line: { 
                        width: 0.5, // Borde muy fino
                        color: 'rgba(255,255,255,0.5)', // Borde semitransparente para separar capas
                        shape: 'spline', // <--- ESTO ES LA CLAVE: Curvas suaves
                        smoothing: 1.3
                    },
                    stackgroup: 'one',
                    fillcolor: colors[status], // El color de relleno
                    type: 'scatter',
                    // Tooltip personalizado HTML
                    hovertemplate: `<b>${status}</b>: %{y}<extra></extra>` 
                });
            });

            const layoutFluido = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Inter', color: '#94a3b8', size: 11 },
                margin: { t: 20, l: 30, r: 20, b: 40 }, // M√°rgenes ajustados
                showlegend: true,
                legend: { 
                    orientation: 'h', 
                    y: 1.1, x: 0.5, 
                    xanchor: 'center',
                    font: { size: 10 }
                },
                // Eje X limpio
                xaxis: { 
                    gridcolor: 'rgba(255,255,255,0.03)', 
                    showgrid: false,
                    zeroline: false,
                    tickformat: '%d %b' // Formato "20 Ene"
                },
                // Eje Y limpio
                yaxis: { 
                    gridcolor: 'rgba(255,255,255,0.05)', 
                    showgrid: true,
                    zeroline: false
                },
                // LA MAGIA DEL HOVER:
                hovermode: 'x unified', // L√≠nea vertical que cruza todo
                hoverlabel: {
                    bgcolor: '#1e293b', // Fondo oscuro para el tooltip
                    bordercolor: 'rgba(255,255,255,0.1)',
                    font: { color: '#fff', family: 'Inter' }
                }
            };

            Plotly.newPlot('chart-daily-status', datasets, layoutFluido, { 
                responsive: true, 
                displayModeBar: false // Oculta la barra de herramientas de Plotly para que se vea limpio
            });

            // GR√ÅFICO 2: FINANZAS
            let finData = {};
            ventas.forEach(v => {
                let d = v.fecha.format("YYYY-MM-DD");
                if (!finData[d]) finData[d] = { fact: 0, ads: 0 };
                finData[d].fact += v.monto;
            });
            if (closerSel === "Todos") {
                gastos.forEach(g => {
                    let d = g.fecha.format("YYYY-MM-DD");
                    if (!finData[d]) finData[d] = { fact: 0, ads: 0 };
                    finData[d].ads += g.gasto;
                });
            }

            let datesF = Object.keys(finData).sort();
            let traceFact = {
                x: datesF,
                y: datesF.map(d => finData[d].fact),
                name: 'Facturaci√≥n',
                mode: 'lines',
                line: { color: '#10b981', width: 3, shape: 'spline' },
                fill: 'tozeroy',
                fillcolor: 'rgba(16, 185, 129, 0.1)'
            };
            let traceAds = {
                x: datesF,
                y: datesF.map(d => finData[d].ads),
                name: 'Ads',
                mode: 'lines',
                line: { color: '#ef4444', width: 2, shape: 'spline' },
                fill: 'tozeroy',
                fillcolor: 'rgba(239, 68, 68, 0.05)'
            };

            Plotly.newPlot('chart-finance', [traceFact, traceAds], {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                font: { family: 'Inter', color: '#64748b' },
                margin: { t: 10, l: 40, r: 10, b: 30 },
                hovermode: 'x unified',
                legend: { orientation: 'h', y: 1.1 },
                xaxis: { showgrid: false },
                yaxis: { gridcolor: 'rgba(255,255,255,0.05)' }
            }, { responsive: true, displayModeBar: false });
        }

        // Renderizar Tabla
        function renderTable(ventas) {
            let ranking = {};
            ventas.forEach(v => {
                let c = v.closer;
                if (!ranking[c]) ranking[c] = { fact: 0, asist: new Set(), ventas: new Set() };
                ranking[c].fact += v.monto;
                if (v.esAsistencia) ranking[c].asist.add(v.email);
                if (v.estadoSimple === "‚úÖ Venta") ranking[c].ventas.add(v.email);
            });

            let rows = Object.keys(ranking).map(k => {
                let r = ranking[k];
                let pct = r.asist.size > 0 ? (r.ventas.size / r.asist.size * 100) : 0;
                return { name: k, fact: r.fact, asist: r.asist.size, ventas: r.ventas.size, pct };
            }).sort((a, b) => b.fact - a.fact);

            let tbody = document.querySelector("#tabla-ranking tbody");
            tbody.innerHTML = "";
            rows.forEach(r => {
                let color = r.pct > 20 ? 'bg-success' : 'bg-warning';
                tbody.innerHTML += `
                    <tr>
                        <td class="text-white fw-bold">${r.name}</td>
                        <td style="color: #4ade80;">${fmtMoney(r.fact)}</td>
                        <td class="text-white">${r.asist}</td>
                        <td class="text-white">${r.ventas}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="me-2 text-white">${r.pct.toFixed(1)}%</span>
                                <div class="progress flex-grow-1" style="height: 4px; background: rgba(255,255,255,0.1);">
                                    <div class="progress-bar ${color}" style="width: ${Math.min(r.pct, 100)}%"></div>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            });
        }

        const fmtMoney = (val) => "$" + val.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });

        // --- H. EVENT LISTENERS (ESCUCHA DE EVENTOS) ---
        document.getElementById('filtroTiempo').addEventListener('change', updateDashboard);
        document.getElementById('filtroCloser').addEventListener('change', updateDashboard);
        
        // Iniciar App
        init();

    </script>
</body>

</html>
