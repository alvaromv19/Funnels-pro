<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EVO LAUNCH | AI Ad Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .neon-text { text-shadow: 0 0 10px rgba(56, 189, 248, 0.5); }
        .template-card.selected { border-color: #38bdf8; background-color: rgba(56, 189, 248, 0.1); }
        /* Efecto drag and drop */
        .drag-over { border-color: #38bdf8 !important; background-color: rgba(56, 189, 248, 0.05) !important; }
    </style>
</head>
<body class="flex h-screen overflow-hidden selection:bg-sky-500 selection:text-white" onload="cargarBoveda()">

    <aside class="w-64 bg-slate-900 border-r border-slate-800 flex flex-col justify-between z-10">
        <div>
            <div class="p-6 border-b border-slate-800">
                <h1 class="text-2xl font-bold text-sky-400 tracking-wider neon-text">EVO LAUNCH</h1>
                <p class="text-xs text-slate-400 mt-1 uppercase tracking-widest">By Alvaro MV</p>
            </div>
            
            <nav class="p-4 space-y-2 overflow-y-auto">
                <button onclick="switchTab('ingesta')" id="btn-ingesta" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all">
                    <i class="fa-solid fa-brain w-5"></i><span class="font-semibold">1. Estrategia IA</span>
                </button>
                <button onclick="switchTab('laboratorio')" id="btn-laboratorio" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all">
                    <i class="fa-solid fa-flask w-5"></i><span class="font-semibold">2. Lab Creativo</span>
                </button>
                <button onclick="switchTab('setup')" id="btn-setup" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all">
                    <i class="fa-solid fa-sliders w-5"></i><span class="font-semibold">3. Setup Trafficker</span>
                </button>
                <button onclick="switchTab('lanzamiento')" id="btn-lanzamiento" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all">
                    <i class="fa-solid fa-rocket w-5"></i><span class="font-semibold">4. Lanzamiento</span>
                </button>
                <button onclick="switchTab('analitica')" id="btn-analitica" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-slate-400 hover:bg-slate-800 hover:text-white transition-all">
                    <i class="fa-solid fa-chart-line w-5"></i><span class="font-semibold">5. Anal√≠tica & Reglas</span>
                </button>
                
                <button onclick="switchTab('boveda')" id="btn-boveda" class="nav-btn w-full flex items-center space-x-3 px-4 py-3 rounded-lg text-amber-400 hover:bg-slate-800 transition-all mt-4 border-t border-slate-700/50 pt-4">
                    <i class="fa-solid fa-vault w-5"></i><span class="font-semibold">6. Mi B√≥veda</span>
                </button>
            </nav>
        </div>
        <div class="p-4 border-t border-slate-800 flex items-center space-x-3">
            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-sky-500 to-indigo-500 flex items-center justify-center font-bold shadow-lg shadow-sky-500/20">AM</div>
            <div>
                <p class="text-sm font-semibold text-white">Alvaro Maza</p>
                <p class="text-xs text-emerald-400"><i class="fa-solid fa-circle text-[8px] mr-1 blink"></i>API Conectada</p>
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto bg-slate-950 p-8 relative">
        
        <section id="ingesta" class="tab-content">
            <h2 class="text-3xl font-bold mb-2 text-white">1. Ingesta y Estrategia</h2>
            <p class="text-slate-400 mb-6">Sube tu investigaci√≥n de mercado. El Cerebro IA (GPT-4o) extraer√° los √°ngulos de venta, dolores y deseos del avatar.</p>
            
            <div class="bg-slate-900 p-10 rounded-xl border border-slate-800 shadow-lg border-dashed text-center max-w-3xl">
                <i class="fa-solid fa-file-pdf text-5xl text-rose-500 mb-4 drop-shadow-lg"></i>
                <h3 class="text-xl font-bold text-white mb-2">Sube el documento de la Oferta</h3>
                <p class="text-slate-400 text-sm mb-6">Archivos soportados: PDF, TXT, DOCX. La IA procesar√° el contexto al instante.</p>
                <button class="bg-slate-800 hover:bg-slate-700 text-white font-semibold py-3 px-8 rounded-lg border border-slate-700 transition-all">
                    <i class="fa-solid fa-cloud-arrow-up mr-2"></i> Explorar Archivos
                </button>
            </div>
        </section>

        <section id="laboratorio" class="tab-content active">
            <h2 class="text-3xl font-bold mb-2 text-white">2. Laboratorio Creativo</h2>
            <p class="text-slate-400 mb-6">Generaci√≥n masiva de copys y fondos visuales. Arrastra referencias, define el estilo y genera.</p>
            
            <div class="mb-8 bg-slate-900 p-6 rounded-xl border border-slate-800 shadow-lg flex flex-col space-y-5">
                
                <div class="w-full">
                    <label class="block text-xs font-semibold text-sky-400 mb-2 uppercase tracking-wider"><i class="fa-solid fa-terminal mr-2"></i>Director Creativo (Instrucciones IA)</label>
                    
                    <div class="flex flex-col bg-slate-800 border border-slate-700 rounded-lg overflow-hidden focus-within:border-sky-500 transition-colors shadow-inner">
                        
                        <div id="drop-zone" class="border-b border-slate-700 p-4 relative flex flex-col items-center justify-center transition-all min-h-[80px]" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                            <input type="file" id="ref-image-upload" multiple accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer" onchange="handleFileSelect(event)">
                            
                            <div id="drop-instruction" class="text-slate-400 text-sm flex items-center pointer-events-none">
                                <i class="fa-solid fa-images mr-2 text-xl"></i> Arrastra hasta 5 referencias aqu√≠ o haz clic
                            </div>
                            
                            <div id="thumbnails-container" class="flex flex-wrap gap-3 mt-3 w-full justify-center relative z-10"></div>
                        </div>
                        
                        <textarea id="prompt-instruccion" class="w-full bg-transparent text-white p-4 min-h-[90px] focus:outline-none resize-y text-sm leading-relaxed" placeholder="Ej: Escenario de oficina moderna, iluminaci√≥n de ne√≥n sutil. Estilo hiperrealista. Usa los colores de las referencias..."></textarea>
                    </div>
                </div>

                <div class="flex flex-wrap justify-between items-end w-full border-t border-slate-800 pt-5 mt-2">
                    <div class="flex space-x-6">
                        <div>
                            <label class="block text-xs font-semibold text-slate-400 mb-2">Cant. de Anuncios</label>
                            <input type="number" id="volumen-tanda" min="1" max="100" value="2" class="bg-slate-800 border border-slate-700 text-white rounded-lg p-2.5 focus:outline-none focus:border-sky-500 min-w-[150px]">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-400 mb-2">Formato Visual</label>
                            <select id="formato-tanda" class="bg-slate-800 border border-slate-700 text-white rounded-lg p-2.5 focus:outline-none focus:border-sky-500 min-w-[150px]">
                                <option value="1080">1080x1080 (Feed)</option>
                                <option value="1920">1080x1920 (Reels/Stories)</option>
                            </select>
                        </div>
                    </div>
                    <button id="btn-generar" onclick="generarCreativos()" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg shadow-sky-500/30 transition-all flex items-center text-md mt-4 sm:mt-0">
                        <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Generar Tanda con IA
                    </button>
                </div>
            </div>

            <div id="grilla-resultados" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                <div class="bg-slate-900 rounded-xl border border-slate-800 overflow-hidden shadow-lg opacity-50 flex items-center justify-center p-10 col-span-full">
                    <p class="text-slate-500 text-sm"><i class="fa-solid fa-robot mr-2"></i>Esperando instrucciones para generar creativos...</p>
                </div>
            </div>
        </section>

        <section id="boveda" class="tab-content">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-3xl font-bold mb-2 text-amber-400"><i class="fa-solid fa-vault mr-3"></i>Mi B√≥veda Creativa</h2>
                    <p class="text-slate-400">Historial de anuncios aprobados. √ösalos para iterar o escalar campa√±as ganadoras.</p>
                </div>
                <button onclick="limpiarBoveda()" class="bg-rose-900/30 text-rose-500 hover:bg-rose-600 hover:text-white border border-rose-800 py-2 px-4 rounded text-sm transition font-bold">Limpiar B√≥veda</button>
            </div>
            
            <div id="grilla-boveda" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                </div>
        </section>

        <section id="setup" class="tab-content">
            <h2 class="text-3xl font-bold mb-2 text-white">3. Setup Estrat√©gico</h2>
            <p class="text-slate-400 mb-6">Selecciona el objetivo de tu funnel para adaptar las reglas y la estructura de Meta.</p>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
                <div onclick="selectTemplate(this, 'low_ticket')" class="template-card cursor-pointer bg-slate-900 border border-slate-700 p-5 rounded-xl hover:border-sky-500 transition-all shadow-lg">
                    <i class="fa-solid fa-cart-shopping text-2xl text-sky-400 mb-3"></i>
                    <h3 class="font-bold text-white mb-1">Venta Low Ticket</h3>
                    <p class="text-xs text-slate-400">Estructura 1-1-3. CPA objetivo bajo.</p>
                </div>
                <div onclick="selectTemplate(this, 'high_ticket')" class="template-card cursor-pointer bg-slate-900 border border-slate-700 p-5 rounded-xl hover:border-sky-500 transition-all shadow-lg">
                    <i class="fa-solid fa-gem text-2xl text-purple-400 mb-3"></i>
                    <h3 class="font-bold text-white mb-1">Venta High Ticket</h3>
                    <p class="text-xs text-slate-400">Estructura 1-1-3. Optimiza por CPL.</p>
                </div>
                <div onclick="selectTemplate(this, 'whatsapp')" class="template-card cursor-pointer bg-slate-900 border border-slate-700 p-5 rounded-xl hover:border-sky-500 transition-all shadow-lg">
                    <i class="fa-brands fa-whatsapp text-2xl text-emerald-400 mb-3"></i>
                    <h3 class="font-bold text-white mb-1">Mensajes WhatsApp</h3>
                    <p class="text-xs text-slate-400">Estructura 1-1-3. Cierre manual.</p>
                </div>
                <div onclick="selectTemplate(this, 'visitas_perfil')" class="template-card cursor-pointer bg-slate-900 border border-slate-700 p-5 rounded-xl hover:border-sky-500 transition-all shadow-lg">
                    <i class="fa-brands fa-instagram text-2xl text-pink-500 mb-3"></i>
                    <h3 class="font-bold text-white mb-1">Visitas al Perfil</h3>
                    <p class="text-xs text-slate-400">Estructura 1-1-3. Escalar seguidores.</p>
                </div>
            </div>

            <div id="injection-params" class="hidden bg-slate-900 p-8 rounded-xl border border-slate-800 max-w-4xl opacity-0 transition-opacity duration-500 shadow-xl">
                <h3 class="text-lg font-bold text-white mb-6 border-b border-slate-800 pb-3"><i class="fa-solid fa-gears text-sky-400 mr-2"></i>Par√°metros de Campa√±a</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-semibold text-slate-300 mb-1">Cuenta Publicitaria</label>
                            <select class="w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3 focus:outline-none focus:border-sky-500">
                                <option>Act Ad Account 1 (ACT_123456789)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-300 mb-1">P√°gina de Facebook / IG</label>
                            <input type="text" placeholder="Ej: Evo Launch Oficial" class="w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3 focus:outline-none focus:border-sky-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-300 mb-1">URL de Destino</label>
                            <input type="url" placeholder="https://tusitio.com/oferta" class="w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3 focus:outline-none focus:border-sky-500">
                        </div>
                    </div>
                    <div class="space-y-5">
                        <div>
                            <label class="block text-sm font-semibold text-slate-300 mb-1">Presupuesto Diario Total (USD)</label>
                            <input type="number" value="40" class="w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3 focus:outline-none focus:border-sky-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-300 mb-1">Pa√≠s / Ubicaci√≥n</label>
                            <input type="text" placeholder="Ej: Per√∫, Colombia, Global" class="w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3 focus:outline-none focus:border-sky-500">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-300 mb-1">Pixel ID</label>
                            <input type="text" placeholder="Ej: 9876543210" class="w-full bg-slate-800 border border-slate-700 text-white rounded-lg p-3 focus:outline-none focus:border-sky-500">
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <section id="lanzamiento" class="tab-content">
            <h2 class="text-3xl font-bold mb-2 text-white">4. Lanzamiento y Preview</h2>
            <p class="text-slate-400 mb-6">Verifica el Payload estructural antes de conectarte a la Graph API de Meta.</p>
            
            <div class="bg-slate-900 border border-slate-700 p-6 rounded-xl mb-6 shadow-lg">
                <h3 class="text-lg font-bold text-white mb-4"><i class="fa-solid fa-eye text-sky-400 mr-2"></i>Preview de Inyecci√≥n (Estructura 1-1-3)</h3>
                <div class="bg-slate-950 p-5 rounded-lg border border-slate-800 font-mono text-sm text-slate-300 overflow-x-auto">
                    <p class="text-sky-400 font-bold mb-3">üì¶ CAMPA√ëA: [Venta Low Ticket] CBO - IA Auto (USD $40/d√≠a)</p>
                    <div class="ml-6 border-l-2 border-slate-800 pl-4 space-y-4">
                        <div>
                            <p class="text-emerald-400 font-bold">‚Ü≥ üéØ AD SET 1: Broad / Open Targeting (Aprendizaje IA)</p>
                            <p class="ml-6 text-slate-400">‚Ü≥ üñºÔ∏è AD 1: [B√≥veda] T1-SC1-Hook_A</p>
                            <p class="ml-6 text-slate-400">‚Ü≥ üñºÔ∏è AD 2: [B√≥veda] T1-SC2-Hook_B</p>
                            <p class="ml-6 text-slate-400">‚Ü≥ üñºÔ∏è AD 3: [B√≥veda] T1-SC3-Hook_C</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex space-x-4">
                <button class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-8 rounded-lg shadow-lg shadow-sky-500/30 transition-all flex items-center text-lg">
                    <i class="fa-solid fa-rocket mr-3"></i> Lanzar ENCENDIDA
                </button>
                <button class="bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-8 rounded-lg transition-all flex items-center text-lg shadow-lg">
                    <i class="fa-solid fa-pause mr-3"></i> Lanzar PAUSADA
                </button>
            </div>
        </section>

        <section id="analitica" class="tab-content">
            <h2 class="text-3xl font-bold mb-2 text-white">5. Anal√≠tica & Reglas</h2>
            <p class="text-slate-400 mb-6">En construcci√≥n...</p>
        </section>

    </main>

    <div id="image-modal" class="fixed inset-0 z-[100] hidden bg-slate-950/95 backdrop-blur-md flex items-center justify-center p-6 opacity-0 transition-opacity duration-300">
        <button onclick="cerrarModal()" class="absolute top-6 right-8 text-slate-400 hover:text-white text-4xl transition transform hover:scale-110"><i class="fa-solid fa-xmark"></i></button>
        <img id="modal-img" src="" class="max-w-full max-h-[90vh] rounded-xl shadow-[0_0_50px_rgba(56,189,248,0.3)] border border-slate-700 object-contain">
    </div>

    <script>
        // --- NAVEGACI√ìN ---
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('bg-sky-600', 'bg-amber-600', 'text-white');
                if(btn.id !== 'btn-boveda') btn.classList.add('text-slate-400');
            });
            document.getElementById(tabId).classList.add('active');
            
            const activeBtn = document.getElementById('btn-' + tabId);
            activeBtn.classList.remove('text-slate-400');
            if(tabId === 'boveda') {
                activeBtn.classList.add('bg-amber-600', 'text-white');
                cargarBoveda(); // Cargar base de datos al abrir
            } else {
                activeBtn.classList.add('bg-sky-600', 'text-white');
            }
        }

        // --- SISTEMA DE DRAG & DROP MULTIPLE ---
        let referenciasArray = []; // Hasta 5 im√°genes

        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('drop-zone').classList.add('drag-over');
        }
        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('drop-zone').classList.remove('drag-over');
        }
        function handleDrop(e) {
            e.preventDefault();
            document.getElementById('drop-zone').classList.remove('drag-over');
            procesarArchivos(e.dataTransfer.files);
        }
        function handleFileSelect(e) {
            procesarArchivos(e.target.files);
        }

        function procesarArchivos(files) {
            if (!files || files.length === 0) return;
            
            // L√≠mite de 5 im√°genes totales
            const archivosDisponibles = 5 - referenciasArray.length;
            const archivosAProcesar = Array.from(files).slice(0, archivosDisponibles);

            archivosAProcesar.forEach(file => {
                if (!file.type.match('image.*')) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    referenciasArray.push(e.target.result);
                    renderizarMiniaturas();
                };
                reader.readAsDataURL(file);
            });
        }

        function renderizarMiniaturas() {
            const container = document.getElementById('thumbnails-container');
            const instruction = document.getElementById('drop-instruction');
            
            container.innerHTML = '';
            if (referenciasArray.length > 0) {
                instruction.classList.add('hidden');
                referenciasArray.forEach((b64, index) => {
                    container.innerHTML += `
                        <div class="relative w-16 h-16 rounded border border-slate-600 overflow-hidden group">
                            <img src="${b64}" class="w-full h-full object-cover">
                            <div class="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 flex items-center justify-center transition cursor-pointer" onclick="eliminarReferencia(event, ${index})">
                                <i class="fa-solid fa-trash text-rose-500"></i>
                            </div>
                        </div>
                    `;
                });
            } else {
                instruction.classList.remove('hidden');
            }
        }

        function eliminarReferencia(e, index) {
            e.stopPropagation(); // Evita que se abra el selector de archivos
            referenciasArray.splice(index, 1);
            renderizarMiniaturas();
            document.getElementById('ref-image-upload').value = '';
        }

        // --- MODAL Y DESCARGAS ---
        function abrirModal(imgSrc) {
            const modal = document.getElementById('image-modal');
            document.getElementById('modal-img').src = imgSrc;
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); }, 10);
        }

        function cerrarModal() {
            const modal = document.getElementById('image-modal');
            modal.classList.add('opacity-0');
            setTimeout(() => { modal.classList.add('hidden'); }, 300);
        }

        function descargarImagen(imgSrc, hook) {
            const a = document.createElement('a');
            a.href = imgSrc;
            const safeName = hook.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.download = `EVO_${safeName}.jpg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- BASE DE DATOS LOCAL (LOCALSTORAGE) ---
        function guardarEnBoveda(b64Image, copyText, hook) {
            const item = {
                id: Date.now(),
                imagen: b64Image,
                texto: copyText,
                titulo: hook,
                fecha: new Date().toLocaleDateString()
            };
            
            let boveda = JSON.parse(localStorage.getItem('evo_boveda') || '[]');
            boveda.unshift(item); // Agrega al principio
            localStorage.setItem('evo_boveda', JSON.stringify(boveda));
            
            alert("‚úÖ ¬°Aprobado y guardado en tu B√≥veda!");
        }

        function cargarBoveda() {
            const grilla = document.getElementById('grilla-boveda');
            let boveda = JSON.parse(localStorage.getItem('evo_boveda') || '[]');
            
            grilla.innerHTML = '';
            if(boveda.length === 0) {
                grilla.innerHTML = '<p class="text-slate-500 col-span-full">Tu b√≥veda est√° vac√≠a. Genera y aprueba creativos en el Laboratorio.</p>';
                return;
            }

            boveda.forEach(item => {
                grilla.innerHTML += `
                    <div class="bg-slate-900 rounded-xl border border-amber-500/30 overflow-hidden shadow-lg">
                        <div class="h-40 relative group">
                            <img src="${item.imagen}" class="w-full h-full object-cover cursor-pointer" onclick="abrirModal('${item.imagen}')">
                            <button onclick="descargarImagen('${item.imagen}', '${item.titulo}')" class="absolute top-2 right-2 bg-slate-900/80 hover:bg-sky-600 text-white p-2 rounded text-xs transition backdrop-blur-sm shadow"><i class="fa-solid fa-download"></i></button>
                        </div>
                        <div class="p-4">
                            <div class="flex justify-between text-xs text-slate-500 mb-1">
                                <span>${item.fecha}</span>
                            </div>
                            <h4 class="text-sm font-bold text-amber-400 line-clamp-1 mb-1">${item.titulo}</h4>
                            <p class="text-xs text-slate-400 line-clamp-3">${item.texto}</p>
                        </div>
                    </div>
                `;
            });
        }

        function limpiarBoveda() {
            if(confirm("¬øSeguro que quieres borrar todo el historial? Esto no se puede deshacer.")) {
                localStorage.removeItem('evo_boveda');
                cargarBoveda();
            }
        }


        // --- CONEXI√ìN CON PYTHON ---
        async function generarCreativos() {
            const btn = document.getElementById('btn-generar');
            const promptInput = document.getElementById('prompt-instruccion').value;
            const volumenInput = document.getElementById('volumen-tanda').value;
            const formatoInput = document.getElementById('formato-tanda').value;

            if (!promptInput.trim()) {
                alert("‚ö†Ô∏è Escribe las instrucciones para el Director Creativo.");
                return;
            }

            let cantidad = parseInt(volumenInput);
            if (isNaN(cantidad) || cantidad < 1) {
                alert("‚ö†Ô∏è Ingresa un n√∫mero v√°lido de variaciones.");
                return;
            }
            
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Generando con IA... (10-20s)';
            btn.disabled = true;

            try {
                // Preparamos el payload. Mandamos el array completo de referencias,
                // PERO tambi√©n la primera por separado por si tu Python actual solo lee una.
                const payload = {
                    prompt: promptInput,
                    volumen: cantidad,
                    formato: formatoInput,
                    imagen_referencia: referenciasArray.length > 0 ? referenciasArray[0] : null,
                    referencias_multiples: referenciasArray // Para la futura mejora del backend
                };

                const response = await fetch('http://127.0.0.1:8000/api/laboratorio/generar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if(data.status === "success") {
                    const grilla = document.getElementById('grilla-resultados');
                    grilla.innerHTML = ''; 
                    
                    data.resultados.forEach((res, index) => {
                        const copy = res.copy_data;
                        const imgRenderizada = res.imagen_renderizada;
                        const tituloHook = copy.hook || copy.headline;
                        const num = index + 1;
                        
                        // NOTA: Limpiamos las comillas dobles para que no rompan el HTML del onclick
                        const textoSeguro = copy.primary_text.replace(/"/g, '&quot;');
                        const tituloSeguro = tituloHook.replace(/"/g, '&quot;');
                        
                        const cardHTML = `
                            <div class="bg-slate-900 rounded-xl border border-sky-500/30 overflow-hidden shadow-lg flex flex-col group">
                                <div class="h-56 bg-slate-800 relative border-b border-slate-800 overflow-hidden">
                                    <img src="${imgRenderizada}" alt="Ad Creative" class="w-full h-full object-cover">
                                    
                                    <div class="absolute inset-0 bg-slate-950/70 opacity-0 group-hover:opacity-100 transition duration-300 flex items-center justify-center space-x-4 backdrop-blur-sm">
                                        <button onclick="abrirModal('${imgRenderizada}')" class="bg-sky-600 hover:bg-sky-500 text-white w-12 h-12 rounded-full shadow-lg transform scale-75 group-hover:scale-100 transition duration-300 flex items-center justify-center text-lg" title="Ver Ampliado">
                                            <i class="fa-solid fa-expand"></i>
                                        </button>
                                        <button onclick="descargarImagen('${imgRenderizada}', '${tituloSeguro}')" class="bg-emerald-600 hover:bg-emerald-500 text-white w-12 h-12 rounded-full shadow-lg transform scale-75 group-hover:scale-100 transition duration-300 flex items-center justify-center text-lg" title="Descargar">
                                            <i class="fa-solid fa-download"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="p-5 flex-1 flex flex-col">
                                    <div class="flex justify-between items-start mb-2">
                                        <p class="text-xs text-sky-400 font-mono font-bold">T1-SC${num}-IA</p>
                                    </div>
                                    <h4 class="text-sm font-bold text-white mb-2 line-clamp-2"><i class="fa-solid fa-quote-left text-sky-500 text-xs mr-1"></i> ${tituloHook}</h4>
                                    <p class="text-sm text-slate-400 line-clamp-3 mb-4 leading-relaxed">${copy.primary_text}</p>
                                    
                                    <div class="flex space-x-2 mt-auto">
                                        <button onclick="guardarEnBoveda('${imgRenderizada}', '${textoSeguro}', '${tituloSeguro}')" class="flex-1 bg-emerald-600/20 text-emerald-400 hover:bg-emerald-600 hover:text-white border border-emerald-500/30 py-2 rounded text-sm font-bold transition">Aprobar (Guardar)</button>
                                        
                                        <button onclick="this.closest('div.bg-slate-900').remove()" class="bg-rose-600/20 text-rose-400 hover:bg-rose-600 hover:text-white border border-rose-500/30 px-4 py-2 rounded text-sm font-bold transition" title="Descartar"><i class="fa-solid fa-trash-can"></i></button>
                                    </div>
                                </div>
                            </div>
                        `;
                        grilla.innerHTML += cardHTML;
                    });
                    
                } else {
                    alert("Error: " + JSON.stringify(data));
                }
                
            } catch (error) {
                console.error(error);
                alert("Error de red. Verifica la terminal F12.");
            } finally {
                btn.innerHTML = '<i class="fa-solid fa-wand-magic-sparkles mr-2"></i>Generar Tanda con IA';
                btn.disabled = false;
            }
        }
    </script>
</body>
</html>
