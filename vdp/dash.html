<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agus Q - VDP Dashboard v2</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        dark: '#0f172a',
                        card: '#1e293b',
                        accent: '#3b82f6',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        vsl: '#8b5cf6',
                        social: '#ec4899',
                        webinar: '#f59e0b',
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Inter', sans-serif; }
        .kpi-card { transition: all 0.3s ease; }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); }
        .loader { border-top-color: #3b82f6; -webkit-animation: spinner 1.5s linear infinite; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Input sin flechas */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
    </style>
</head>
<body class="p-4 md:p-8">

    <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
        <div>
            <h1 class="text-3xl font-bold text-white tracking-tight">Agus Q | VDP <span class="text-accent text-sm font-normal">| Vision Dashboard Panel</span></h1>
            <p class="text-gray-400 text-sm">Status: <span id="status-text" class="text-yellow-500">Conectando...</span></p>
        </div>
        <button onclick="openSettings()" class="bg-card hover:bg-gray-700 text-white px-4 py-2 rounded-lg border border-gray-600 flex items-center gap-2 transition">
            <i class="fa-solid fa-gear"></i> Configuración
        </button>
    </header>

    <div id="loading" class="flex flex-col justify-center items-center h-64">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
        <p class="text-gray-400 animate-pulse">Procesando CSVs de Google Sheets...</p>
    </div>

    <main id="dashboard" class="hidden space-y-8">

        <section>
            <h2 class="text-xl font-semibold mb-4 text-white border-l-4 border-accent pl-2">Global Performance</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="kpi-card bg-card p-4 rounded-xl border border-gray-700">
                    <p class="text-gray-400 text-xs uppercase font-bold">Inversión Total</p>
                    <h3 class="text-2xl font-bold text-white mt-1" id="total-spend">$0.00</h3>
                    <div class="mt-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Total: <span id="lbl-budget-total"></span></span>
                            <span class="text-accent font-bold" id="lbl-spend-perc">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="bar-spend" class="bg-accent h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="kpi-card bg-card p-4 rounded-xl border border-gray-700">
                    <p class="text-gray-400 text-xs uppercase font-bold">Revenue (Recolectado)</p>
                    <h3 class="text-2xl font-bold text-success mt-1" id="total-revenue">$0.00</h3>
                    <div class="mt-3">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="text-gray-400">Meta: <span id="lbl-goal-total"></span></span>
                            <span class="text-success font-bold" id="lbl-revenue-perc">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2">
                            <div id="bar-revenue" class="bg-success h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="kpi-card bg-card p-4 rounded-xl border border-gray-700">
                    <p class="text-gray-400 text-xs uppercase font-bold">Profit</p>
                    <h3 class="text-2xl font-bold text-white mt-1" id="total-profit">$0.00</h3>
                    <p class="text-xs text-gray-500 mt-2">Neto tras adspend</p>
                </div>

                <div class="kpi-card bg-card p-4 rounded-xl border border-gray-700">
                    <p class="text-gray-400 text-xs uppercase font-bold">ROAS Global</p>
                    <h3 class="text-2xl font-bold text-yellow-400 mt-1" id="total-roas">0.00x</h3>
                    <p class="text-xs text-gray-500 mt-2">Retorno de inversión</p>
                </div>

                <div class="kpi-card bg-card p-4 rounded-xl border border-gray-700">
                    <p class="text-gray-400 text-xs uppercase font-bold">Ventas Totales</p>
                    <h3 class="text-2xl font-bold text-white mt-1" id="total-sales">0</h3>
                    <p class="text-xs text-gray-500 mt-2">Unidades vendidas</p>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-xl font-semibold mb-4 text-white border-l-4 border-vsl pl-2">Performance por Funnel</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-card rounded-xl border-t-4 border-vsl p-4 relative overflow-hidden group">
                    <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-video text-6xl text-vsl"></i></div>
                    <h3 class="text-lg font-bold text-vsl mb-4">VSL Funnel</h3>
                    <div class="space-y-2 relative z-10">
                        <div class="flex justify-between"><span class="text-gray-400">Inversión:</span> <span class="text-white font-mono font-bold" id="vsl-spend">$0</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Revenue:</span> <span class="text-white font-mono" id="vsl-rev">$0</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">ROAS:</span> <span class="text-yellow-400 font-bold font-mono" id="vsl-roas">0x</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Profit:</span> <span class="text-success font-mono" id="vsl-profit">$0</span></div>
                    </div>
                </div>
                <div class="bg-card rounded-xl border-t-4 border-social p-4 relative overflow-hidden group">
                     <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-users text-6xl text-social"></i></div>
                    <h3 class="text-lg font-bold text-social mb-4">Social Funnel</h3>
                    <div class="space-y-2 relative z-10">
                        <div class="flex justify-between"><span class="text-gray-400">Inversión:</span> <span class="text-white font-mono font-bold" id="social-spend">$0</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Revenue:</span> <span class="text-white font-mono" id="social-rev">$0</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">ROAS:</span> <span class="text-yellow-400 font-bold font-mono" id="social-roas">0x</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Profit:</span> <span class="text-success font-mono" id="social-profit">$0</span></div>
                    </div>
                </div>
                <div class="bg-card rounded-xl border-t-4 border-webinar p-4 relative overflow-hidden group">
                     <div class="absolute top-0 right-0 p-4 opacity-5 group-hover:opacity-20 transition-opacity"><i class="fa-solid fa-laptop text-6xl text-webinar"></i></div>
                    <h3 class="text-lg font-bold text-webinar mb-4">Webinar Funnel</h3>
                    <div class="space-y-2 relative z-10">
                        <div class="flex justify-between"><span class="text-gray-400">Inversión:</span> <span class="text-white font-mono font-bold" id="web-spend">$0</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Revenue:</span> <span class="text-white font-mono" id="web-rev">$0</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">ROAS:</span> <span class="text-yellow-400 font-bold font-mono" id="web-roas">0x</span></div>
                        <div class="flex justify-between"><span class="text-gray-400">Profit:</span> <span class="text-success font-mono" id="web-profit">$0</span></div>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-xl font-semibold mb-4 text-white border-l-4 border-gray-500 pl-2">Métricas de Embudo</h2>
            <div class="overflow-x-auto rounded-xl border border-gray-700 shadow-lg">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-gray-200 uppercase bg-gray-800">
                        <tr>
                            <th class="px-6 py-3">Funnel</th>
                            <th class="px-6 py-3">Clicks</th>
                            <th class="px-6 py-3">Leads</th>
                            <th class="px-6 py-3">Agendas Creadas</th>
                            <th class="px-6 py-3">Agendas Calif.</th>
                            <th class="px-6 py-3">Shows</th>
                            <th class="px-6 py-3 text-right text-white">Ventas</th>
                        </tr>
                    </thead>
                    <tbody id="funnel-table-body"></tbody>
                </table>
            </div>
        </section>

        <section>
            <h2 class="text-xl font-semibold mb-4 text-white border-l-4 border-indigo-500 pl-2">Tendencia Diaria (Electrocardiograma)</h2>
            <div class="bg-card p-4 rounded-xl border border-gray-700 h-[400px] shadow-lg">
                <canvas id="trendsChart"></canvas>
            </div>
        </section>

        <section>
            <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                <h2 class="text-xl font-semibold text-white border-l-4 border-green-500 pl-2">Control de Presupuesto</h2>
                <div class="text-right">
                    <p class="text-xs text-gray-400">Meta Facturación: <span id="lbl-goal-bottom" class="text-white font-bold"></span></p>
                    <p class="text-xs text-gray-400">Días restantes: <span id="days-remaining" class="text-accent font-bold text-lg">0</span></p>
                </div>
            </div>

            <div id="budget-alert" class="hidden mb-4 p-3 rounded-lg bg-danger/20 border border-danger text-danger text-sm font-bold text-center flex items-center justify-center gap-2">
                <i class="fa-solid fa-triangle-exclamation"></i>
                <span id="budget-alert-text">La distribución suma X%, debe ser 100%</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-card rounded-xl p-5 border border-gray-700">
                    <h3 class="font-bold text-white mb-2 flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-vsl"></div> VSL Allocation</h3>
                    <div class="flex items-center gap-2 mb-4 bg-gray-800 p-2 rounded-lg border border-gray-700">
                        <input type="number" id="input-vsl-perc" oninput="updateBudgetCalc()" value="33" class="bg-transparent text-white text-lg font-bold w-16 text-right outline-none" placeholder="0">
                        <span class="text-gray-400 text-sm font-bold">%</span>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between border-b border-gray-700 pb-1"><span>Asignado:</span> <span class="text-white" id="vsl-alloc-total">$0</span></div>
                        <div class="flex justify-between border-b border-gray-700 pb-1"><span>Gastado:</span> <span class="text-gray-400" id="vsl-alloc-spent">$0</span></div>
                        <div class="flex justify-between border-b border-gray-700 pb-1"><span>Restante:</span> <span class="text-success" id="vsl-alloc-rem">$0</span></div>
                        <div class="flex justify-between pt-1"><span class="font-bold text-accent">Diario Sugerido:</span> <span class="font-bold text-white text-lg" id="vsl-alloc-daily">$0</span></div>
                    </div>
                </div>

                <div class="bg-card rounded-xl p-5 border border-gray-700">
                    <h3 class="font-bold text-white mb-2 flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-social"></div> Social Allocation</h3>
                    <div class="flex items-center gap-2 mb-4 bg-gray-800 p-2 rounded-lg border border-gray-700">
                        <input type="number" id="input-social-perc" oninput="updateBudgetCalc()" value="33" class="bg-transparent text-white text-lg font-bold w-16 text-right outline-none" placeholder="0">
                        <span class="text-gray-400 text-sm font-bold">%</span>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between border-b border-gray-700 pb-1"><span>Asignado:</span> <span class="text-white" id="social-alloc-total">$0</span></div>
                        <div class="flex justify-between border-b border-gray-700 pb-1"><span>Gastado:</span> <span class="text-gray-400" id="social-alloc-spent">$0</span></div>
                        <div class="flex justify-between border-b border-gray-700 pb-1"><span>Restante:</span> <span class="text-success" id="social-alloc-rem">$0</span></div>
                        <div class="flex justify-between pt-1"><span class="font-bold text-accent">Diario Sugerido:</span> <span class="font-bold text-white text-lg" id="social-alloc-daily">$0</span></div>
                    </div>
                </div>

                <div class="bg-card rounded-xl p-5 border border-gray-700">
                    <h3 class="font-bold text-white mb-2 flex items-center gap-2"><div class="w-3 h-3 rounded-full bg-webinar"></div> Webinar Allocation</h3>
                    <div class="flex items-center gap-2 mb-4 bg-gray-800 p-2 rounded-lg border border-gray-700">
                        <input type="number" id="input-web-perc" oninput="updateBudgetCalc()" value="34" class="bg-transparent text-white text-lg font-bold w-16 text-right outline-none" placeholder="0">
                        <span class="text-gray-400 text-sm font-bold">%</span>
                    </div>
                    <div class="space-y-2 text-sm">
                        <div class="flex justify-between border-b border-gray-700 pb-1"><span>Asignado:</span> <span class="text-white" id="web-alloc-total">$0</span></div>
                        <div class="flex justify-between border-b border-gray-700 pb-1"><span>Gastado:</span> <span class="text-gray-400" id="web-alloc-spent">$0</span></div>
                        <div class="flex justify-between border-b border-gray-700 pb-1"><span>Restante:</span> <span class="text-success" id="web-alloc-rem">$0</span></div>
                        <div class="flex justify-between pt-1"><span class="font-bold text-accent">Diario Sugerido:</span> <span class="font-bold text-white text-lg" id="web-alloc-daily">$0</span></div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex justify-center items-center backdrop-blur-sm">
        <div class="bg-card p-6 rounded-xl border border-gray-600 w-96 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-4">Configuración General</h3>
            
            <div class="mb-4">
                <label class="block text-gray-400 text-sm mb-2">Inversión Total Asignada (Mes)</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><span class="text-gray-500">$</span></div>
                    <input type="number" id="setting-total-budget" class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg focus:ring-accent focus:border-accent block w-full pl-8 p-2.5" value="5000">
                </div>
            </div>

            <div class="mb-6">
                <label class="block text-gray-400 text-sm mb-2">Meta de Facturación (Mes)</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><span class="text-gray-500">$</span></div>
                    <input type="number" id="setting-revenue-goal" class="bg-gray-800 border border-gray-600 text-white text-sm rounded-lg focus:ring-accent focus:border-accent block w-full pl-8 p-2.5" value="15000">
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white text-sm px-4 py-2">Cancelar</button>
                <button onclick="saveSettings()" class="bg-accent hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">Guardar y Recalcular</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURACIÓN Y ESTADO ---
        const URLS = {
            vsl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9RFOkjUIr2ffG-X6rHf2SlRH70HgeKaCZYZshyCx4i9IntsZC_tziV5FS5BntZFPrtDAa8MrXhOmU/pub?gid=1309284543&single=true&output=csv',
            social: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9RFOkjUIr2ffG-X6rHf2SlRH70HgeKaCZYZshyCx4i9IntsZC_tziV5FS5BntZFPrtDAa8MrXhOmU/pub?gid=1789645537&single=true&output=csv',
            webinar: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9RFOkjUIr2ffG-X6rHf2SlRH70HgeKaCZYZshyCx4i9IntsZC_tziV5FS5BntZFPrtDAa8MrXhOmU/pub?gid=846184228&single=true&output=csv'
        };

        let DATA = { vsl: [], social: [], webinar: [] };
        let SETTINGS = { budget: 5000, goal: 15000 };
        
        // Utils de formato
        const currency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
        const formatNum = (num) => new Intl.NumberFormat('en-US').format(num);

        // --- 2. MOTOR DE DATOS (ROBUST PARSER) ---
        // Esta función limpia los headers del CSV para encontrar la columna correcta incluso si el nombre varía un poco
        function findColumn(row, possibleKeywords) {
            const normalizedKeys = Object.keys(row).map(k => ({ original: k, norm: k.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") }));
            
            for (let keyword of possibleKeywords) {
                const normKeyword = keyword.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                // Buscamos coincidencia parcial
                const match = normalizedKeys.find(k => k.norm.includes(normKeyword));
                if (match) return row[match.original];
            }
            return 0; // Si no encuentra, retorna 0
        }

        const parseVal = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            return parseFloat(val.toString().replace(/[$,\s%]/g, '')) || 0;
        };

        // --- 3. INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchAllData();
        });

        async function fetchAllData() {
            const fetchCsv = (url) => new Promise((resolve) => {
                Papa.parse(url, {
                    download: true,
                    header: true,
                    skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: (err) => { console.error("Error CSV", err); resolve([]); }
                });
            });

            try {
                const [vslData, socialData, webinarData] = await Promise.all([
                    fetchCsv(URLS.vsl),
                    fetchCsv(URLS.social),
                    fetchCsv(URLS.webinar)
                ]);

                // Validación básica
                if(vslData.length === 0 && socialData.length === 0) {
                    document.getElementById('status-text').innerText = "Error de Datos";
                    document.getElementById('status-text').className = "text-danger";
                    alert("No se pudieron cargar los datos. Verifica que los links de Google Sheets sean 'Públicos en la web' en Archivo > Compartir > Publicar en la web.");
                    return;
                }

                DATA.vsl = vslData;
                DATA.social = socialData;
                DATA.webinar = webinarData;

                document.getElementById('status-text').innerText = "En Línea";
                document.getElementById('status-text').className = "text-success";
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                
                renderDashboard();

            } catch (error) {
                console.error(error);
                alert("Error crítico cargando datos.");
            }
        }

        function renderDashboard() {
            const metrics = calculateMetrics();
            updateMainKPIs(metrics);
            updateFunnelCards(metrics);
            updateFunnelTable(metrics);
            renderChart(DATA); // Gráfico con fechas
            updateBudgetCalc();
        }

        // --- 4. CÁLCULO DE MÉTRICAS ---
        function calculateMetrics() {
            const processSheet = (data) => {
                let spend = 0, rev = 0, sales = 0;
                let clicks = 0, leads = 0, calls = 0, qual = 0, shows = 0;

                data.forEach(row => {
                    // Usamos el buscador inteligente de columnas
                    // Keywords priorizadas según tu prompt
                    spend += parseVal(findColumn(row, ['inversion', 'spend', 'amount']));
                    rev += parseVal(findColumn(row, ['recolectado', 'revenue', 'valor total']));
                    sales += parseVal(findColumn(row, ['ventas', 'sales', 'purchases']));
                    
                    clicks += parseVal(findColumn(row, ['clicks', 'visitas']));
                    leads += parseVal(findColumn(row, ['leads', 'prospectos']));
                    calls += parseVal(findColumn(row, ['agendas creadas', 'llamadas']));
                    qual += parseVal(findColumn(row, ['calificadas', 'qualified']));
                    shows += parseVal(findColumn(row, ['asistidas', 'shows']));
                });

                return { spend, rev, sales, clicks, leads, calls, qual, shows };
            };

            const vsl = processSheet(DATA.vsl);
            const social = processSheet(DATA.social);
            const web = processSheet(DATA.webinar);

            return {
                vsl, social, web,
                total: {
                    spend: vsl.spend + social.spend + web.spend,
                    rev: vsl.rev + social.rev + web.rev,
                    sales: vsl.sales + social.sales + web.sales,
                    profit: (vsl.rev + social.rev + web.rev) - (vsl.spend + social.spend + web.spend)
                }
            };
        }

        function updateMainKPIs(metrics) {
            const t = metrics.total;
            const roas = t.spend > 0 ? (t.rev / t.spend) : 0;

            document.getElementById('total-spend').innerText = currency(t.spend);
            document.getElementById('total-revenue').innerText = currency(t.rev);
            document.getElementById('total-profit').innerText = currency(t.profit);
            document.getElementById('total-profit').className = `text-2xl font-bold mt-1 ${t.profit >= 0 ? 'text-success' : 'text-danger'}`;
            document.getElementById('total-roas').innerText = roas.toFixed(2) + 'x';
            document.getElementById('total-sales').innerText = formatNum(t.sales);

            // Barras de Progreso
            const budgetPerc = Math.min((t.spend / SETTINGS.budget) * 100, 100);
            const goalPerc = Math.min((t.rev / SETTINGS.goal) * 100, 100);

            document.getElementById('lbl-budget-total').innerText = currency(SETTINGS.budget);
            document.getElementById('lbl-spend-perc').innerText = budgetPerc.toFixed(1) + '%';
            document.getElementById('bar-spend').style.width = budgetPerc + '%';
            
            document.getElementById('lbl-goal-total').innerText = currency(SETTINGS.goal);
            document.getElementById('lbl-revenue-perc').innerText = goalPerc.toFixed(1) + '%';
            document.getElementById('bar-revenue').style.width = goalPerc + '%';
            
            document.getElementById('lbl-goal-bottom').innerText = currency(SETTINGS.goal);
        }

        function updateFunnelCards(metrics) {
            const updateCard = (prefix, data) => {
                const roas = data.spend > 0 ? (data.rev / data.spend) : 0;
                const profit = data.rev - data.spend;
                document.getElementById(`${prefix}-spend`).innerText = currency(data.spend);
                document.getElementById(`${prefix}-rev`).innerText = currency(data.rev);
                document.getElementById(`${prefix}-roas`).innerText = roas.toFixed(2) + 'x';
                document.getElementById(`${prefix}-profit`).innerText = currency(profit);
            };
            updateCard('vsl', metrics.vsl);
            updateCard('social', metrics.social);
            updateCard('web', metrics.web);
        }

        function updateFunnelTable(metrics) {
            const tbody = document.getElementById('funnel-table-body');
            tbody.innerHTML = '';
            const createRow = (name, data, colorClass) => `
                <tr class="bg-card border-b border-gray-700 hover:bg-gray-700 transition">
                    <td class="px-6 py-4 font-bold ${colorClass}">${name}</td>
                    <td class="px-6 py-4">${formatNum(data.clicks)}</td>
                    <td class="px-6 py-4">${formatNum(data.leads)}</td>
                    <td class="px-6 py-4">${formatNum(data.calls)}</td>
                    <td class="px-6 py-4">${formatNum(data.qual)}</td>
                    <td class="px-6 py-4">${formatNum(data.shows)}</td>
                    <td class="px-6 py-4 text-right font-bold text-white bg-white/5">${formatNum(data.sales)}</td>
                </tr>`;
            tbody.innerHTML += createRow('VSL', metrics.vsl, 'text-vsl');
            tbody.innerHTML += createRow('Social Funnel', metrics.social, 'text-social');
            tbody.innerHTML += createRow('Webinar', metrics.web, 'text-webinar');
        }

        // --- 5. GRÁFICO AVANZADO ---
        let chartInstance = null;
        function renderChart(data) {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            // Extraer fechas de la columna "Fecha"
            // Asumimos que la columna Fecha existe en el primer dataset válido
            const validData = data.vsl.length ? data.vsl : (data.social.length ? data.social : data.webinar);
            const dates = validData.map(row => findColumn(row, ['fecha', 'date']) || 'Día X');

            const getSeries = (dataset) => dataset.map(row => parseVal(findColumn(row, ['inversion', 'spend', 'amount'])));

            const vslSeries = getSeries(data.vsl);
            const socialSeries = getSeries(data.social);
            const webSeries = getSeries(data.webinar);
            
            // Sumar total solo si los arrays tienen el mismo largo, sino proteger
            const maxLength = Math.max(vslSeries.length, socialSeries.length, webSeries.length);
            const totalSeries = [];
            for(let i=0; i<maxLength; i++) {
                totalSeries.push((vslSeries[i]||0) + (socialSeries[i]||0) + (webSeries[i]||0));
            }

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        { label: 'VSL', data: vslSeries, borderColor: '#8b5cf6', tension: 0.3, pointRadius: 3, pointHoverRadius: 6 },
                        { label: 'Social', data: socialSeries, borderColor: '#ec4899', tension: 0.3, pointRadius: 3, pointHoverRadius: 6 },
                        { label: 'Webinar', data: webSeries, borderColor: '#f59e0b', tension: 0.3, pointRadius: 3, pointHoverRadius: 6 },
                        { label: 'TOTAL', data: totalSeries, borderColor: '#3b82f6', borderWidth: 3, tension: 0.3, pointRadius: 4, pointHoverRadius: 8 },
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: '#e2e8f0', usePointStyle: true } },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.95)',
                            titleColor: '#3b82f6',
                            bodyColor: '#e2e8f0',
                            borderColor: '#334155',
                            borderWidth: 1,
                            padding: 12,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += currency(context.parsed.y);
                                    return label;
                                },
                                footer: function(tooltipItems) {
                                    let total = 0;
                                    tooltipItems.forEach(function(tooltipItem) {
                                        // Sumar solo los componentes, no el total ya calculado para no duplicar visualmente en lógica rara,
                                        // pero aquí simplemente mostramos un mensaje extra si queremos.
                                    });
                                    return '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: { 
                            grid: { color: '#334155' }, 
                            ticks: { color: '#94a3b8', callback: (val) => '$' + val } 
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#94a3b8', maxTicksLimit: 10 } // Limitar etiquetas para que no se amontonen
                        }
                    }
                }
            });
        }

        // --- 6. PRESUPUESTO & ALERTAS ---
        function updateBudgetCalc() {
            // Inputs
            const pVsl = parseFloat(document.getElementById('input-vsl-perc').value) || 0;
            const pSocial = parseFloat(document.getElementById('input-social-perc').value) || 0;
            const pWeb = parseFloat(document.getElementById('input-web-perc').value) || 0;

            const totalPerc = pVsl + pSocial + pWeb;

            // Alerta de Distribución
            const alertBox = document.getElementById('budget-alert');
            const alertText = document.getElementById('budget-alert-text');
            
            alertBox.classList.remove('hidden', 'bg-danger/20', 'border-danger', 'text-danger', 'bg-success/20', 'border-success', 'text-success');
            
            if (Math.abs(totalPerc - 100) > 0.1) {
                // Error
                alertBox.classList.remove('hidden');
                alertBox.classList.add('bg-danger/20', 'border-danger', 'text-danger');
                alertText.innerHTML = `<i class="fa-solid fa-triangle-exclamation"></i> CUIDADO: La distribución suma <strong>${totalPerc}%</strong> (Debe ser 100%)`;
            } else {
                // Correcto (Opcional mostrar check verde)
                alertBox.classList.remove('hidden');
                alertBox.classList.add('bg-success/20', 'border-success', 'text-success');
                alertText.innerHTML = `<i class="fa-solid fa-check-circle"></i> Distribución Correcta (100%)`;
            }

            // Gastado Actual (parseado del DOM)
            const spentVsl = parseVal(document.getElementById('vsl-spend').innerText);
            const spentSocial = parseVal(document.getElementById('social-spend').innerText);
            const spentWeb = parseVal(document.getElementById('web-spend').innerText);

            // Dias restantes (Calculado real en base a fecha actual)
            const today = new Date();
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const daysLeft = Math.max(0, endOfMonth.getDate() - today.getDate()); 
            document.getElementById('days-remaining').innerText = daysLeft;

            const calcCard = (prefix, perc, spent) => {
                const allocated = SETTINGS.budget * (perc / 100);
                const remaining = allocated - spent;
                const daily = daysLeft > 0 ? (remaining / daysLeft) : 0;

                document.getElementById(`${prefix}-alloc-total`).innerText = currency(allocated);
                document.getElementById(`${prefix}-alloc-spent`).innerText = currency(spent);
                document.getElementById(`${prefix}-alloc-rem`).innerText = currency(remaining);
                
                const remEl = document.getElementById(`${prefix}-alloc-rem`);
                remEl.className = remaining >= 0 ? 'text-success font-bold' : 'text-danger font-bold';
                
                document.getElementById(`${prefix}-alloc-daily`).innerText = currency(daily);
            };

            calcCard('vsl', pVsl, spentVsl);
            calcCard('social', pSocial, spentSocial);
            calcCard('web', pWeb, spentWeb);
        }

        // Settings UI
        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
        function saveSettings() {
            SETTINGS.budget = parseFloat(document.getElementById('setting-total-budget').value) || 5000;
            SETTINGS.goal = parseFloat(document.getElementById('setting-revenue-goal').value) || 15000;
            closeSettings();
            renderDashboard(); 
        }

    </script>
</body>
</html>
