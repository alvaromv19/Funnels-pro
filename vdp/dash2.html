<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agus Q | VDP v4 Memory</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: {
                        bg: '#020617', 
                        card: 'rgba(30, 41, 59, 0.7)', 
                        accent: '#06b6d4', 
                        success: '#00ff9d', 
                        danger: '#ff2a6d', 
                        warning: '#fbbf24', 
                        vsl: '#d946ef', 
                        social: '#8b5cf6', 
                        webinar: '#f59e0b', 
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #020617; color: #f8fafc; font-family: 'Outfit', sans-serif; }
        
        .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
        }

        .glass-panel:hover {
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 15px rgba(6, 182, 212, 0.15);
            transform: translateY(-2px);
            transition: all 0.3s ease;
        }

        input { background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); transition: 0.3s; }
        input:focus { border-color: #06b6d4; outline: none; box-shadow: 0 0 10px rgba(6, 182, 212, 0.4); }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        .loader { border-top-color: #00ff9d; filter: drop-shadow(0 0 5px #00ff9d); -webkit-animation: spinner 1s linear infinite; animation: spinner 1s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #020617; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"> 

    <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
        <div>
            <h1 class="text-4xl font-bold text-white tracking-tight drop-shadow-lg">Agus Q <span class="text-accent font-light">| VDP</span></h1>
            <div class="flex items-center gap-2 mt-1">
                <div class="h-2 w-2 rounded-full bg-success animate-pulse"></div>
                <p class="text-gray-400 text-xs font-mono tracking-widest uppercase">System Online • Feb 2026</p>
            </div>
        </div>
        <button onclick="openSettings()" class="glass-panel text-gray-300 hover:text-white px-5 py-2.5 rounded-lg flex items-center gap-2 transition hover:bg-white/5 border border-white/10 hover:border-accent">
            <i class="fa-solid fa-sliders"></i> Ajustes de Mando
        </button>
    </header>

    <div id="loading" class="flex flex-col justify-center items-center h-64">
        <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-800 h-16 w-16 mb-4"></div>
        <p class="text-accent font-mono text-sm animate-pulse">Cargando Preferencias...</p>
    </div>

    <main id="dashboard" class="hidden space-y-8 pb-10">

        <section>
            <h2 class="text-lg font-semibold mb-4 text-white flex items-center gap-2"><i class="fa-solid fa-globe text-accent"></i> KPIS principales</h2>
            <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                <div class="glass-panel p-5 rounded-xl border-l-4 border-l-accent flex flex-col justify-between">
                    <div>
                        <p class="text-gray-400 text-xs uppercase font-bold tracking-wider">Inversión Total</p>
                        <h3 class="text-3xl font-bold text-white mt-1 drop-shadow-md" id="total-spend">$0.00</h3>
                    </div>
                    <div class="mt-4">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-gray-400 text-xs font-medium">Total: <span id="lbl-budget-total" class="text-white font-bold text-sm ml-1"></span></span>
                            <span class="text-accent font-bold text-sm" id="lbl-spend-perc">0%</span>
                        </div>
                        <div class="w-full bg-gray-800 rounded-full h-2 overflow-hidden">
                            <div id="bar-spend" class="bg-accent h-full shadow-[0_0_10px_#06b6d4]" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-5 rounded-xl border-l-4 border-l-success flex flex-col justify-between">
                    <div>
                        <p class="text-gray-400 text-xs uppercase font-bold tracking-wider">Revenue (Recolectado)</p>
                        <h3 class="text-3xl font-bold text-success mt-1 drop-shadow-[0_0_5px_rgba(0,255,157,0.5)]" id="total-revenue">$0.00</h3>
                    </div>
                    <div class="mt-4">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-gray-400 text-xs font-medium">Meta: <span id="lbl-goal-total" class="text-white font-bold text-sm ml-1"></span></span>
                            <span class="text-success font-bold text-sm" id="lbl-revenue-perc">0%</span>
                        </div>
                        <div class="w-full bg-gray-800 rounded-full h-2 overflow-hidden">
                            <div id="bar-revenue" class="bg-success h-full shadow-[0_0_10px_#00ff9d]" style="width: 0%"></div>
                        </div>
                    </div>
                </div>

                <div class="glass-panel p-5 rounded-xl border-t border-white/5 flex flex-col justify-center">
                    <p class="text-gray-400 text-xs uppercase font-bold tracking-wider">Profit Neto</p>
                    <h3 class="text-3xl font-bold text-white mt-1" id="total-profit">$0.00</h3>
                    <p class="text-sm text-gray-400 mt-2 font-medium"><i class="fa-solid fa-calculator text-xs mr-1"></i> Revenue - AdSpend</p>
                </div>

                <div class="glass-panel p-5 rounded-xl border-t border-white/5 flex flex-col justify-center">
                    <p class="text-gray-400 text-xs uppercase font-bold tracking-wider">ROAS Global</p>
                    <h3 class="text-3xl font-bold text-warning mt-1 drop-shadow-[0_0_5px_rgba(251,191,36,0.5)]" id="total-roas">0.00x</h3>
                    <p class="text-sm text-gray-400 mt-2 font-medium"><i class="fa-solid fa-rotate text-xs mr-1"></i> Retorno Eficiente</p>
                </div>

                <div class="glass-panel p-5 rounded-xl border-t border-white/5 flex flex-col justify-center">
                    <p class="text-gray-400 text-xs uppercase font-bold tracking-wider">Ventas Totales</p>
                    <h3 class="text-3xl font-bold text-white mt-1" id="total-sales">0</h3>
                    <p class="text-sm text-gray-400 mt-2 font-medium"><i class="fa-solid fa-check-circle text-xs mr-1"></i> Unidades Cerradas</p>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-lg font-semibold mb-4 text-white flex items-center gap-2"><i class="fa-solid fa-layer-group text-vsl"></i> Performance por Funnel</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-panel rounded-xl p-6 relative overflow-hidden group border-b-2 border-b-vsl">
                    <div class="absolute -right-4 -top-4 text-8xl text-vsl opacity-5 group-hover:opacity-10 transition-all duration-500 rotate-12"><i class="fa-solid fa-video"></i></div>
                    <h3 class="text-xl font-bold text-vsl mb-6 tracking-wide drop-shadow-[0_0_5px_rgba(217,70,239,0.5)]">VSL Cold</h3>
                    <div class="space-y-3 relative z-10 text-sm">
                        <div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-400">Inversión</span> <span class="text-white font-mono font-bold text-lg" id="vsl-spend">$0</span></div>
                        <div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-400">Revenue</span> <span class="text-white font-mono text-lg" id="vsl-rev">$0</span></div>
                        <div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-400">ROAS</span> <span class="text-warning font-bold font-mono text-lg" id="vsl-roas">0x</span></div>
                        <div class="flex justify-between items-center pt-1"><span class="text-gray-400">Profit</span> <span class="text-success font-mono text-lg" id="vsl-profit">$0</span></div>
                    </div>
                </div>

                <div class="glass-panel rounded-xl p-6 relative overflow-hidden group border-b-2 border-b-social">
                    <div class="absolute -right-4 -top-4 text-8xl text-social opacity-5 group-hover:opacity-10 transition-all duration-500 rotate-12"><i class="fa-solid fa-users"></i></div>
                    <h3 class="text-xl font-bold text-social mb-6 tracking-wide drop-shadow-[0_0_5px_rgba(139,92,246,0.5)]">Social Funnel</h3>
                    <div class="space-y-3 relative z-10 text-sm">
                        <div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-400">Inversión</span> <span class="text-white font-mono font-bold text-lg" id="social-spend">$0</span></div>
                        <div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-400">Revenue</span> <span class="text-white font-mono text-lg" id="social-rev">$0</span></div>
                        <div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-400">ROAS</span> <span class="text-warning font-bold font-mono text-lg" id="social-roas">0x</span></div>
                        <div class="flex justify-between items-center pt-1"><span class="text-gray-400">Profit</span> <span class="text-success font-mono text-lg" id="social-profit">$0</span></div>
                    </div>
                </div>

                <div class="glass-panel rounded-xl p-6 relative overflow-hidden group border-b-2 border-b-webinar">
                    <div class="absolute -right-4 -top-4 text-8xl text-webinar opacity-5 group-hover:opacity-10 transition-all duration-500 rotate-12"><i class="fa-solid fa-laptop"></i></div>
                    <h3 class="text-xl font-bold text-webinar mb-6 tracking-wide drop-shadow-[0_0_5px_rgba(245,158,11,0.5)]">Webinar Evergreen</h3>
                    <div class="space-y-3 relative z-10 text-sm">
                        <div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-400">Inversión</span> <span class="text-white font-mono font-bold text-lg" id="web-spend">$0</span></div>
                        <div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-400">Revenue</span> <span class="text-white font-mono text-lg" id="web-rev">$0</span></div>
                        <div class="flex justify-between items-center border-b border-white/5 pb-1"><span class="text-gray-400">ROAS</span> <span class="text-warning font-bold font-mono text-lg" id="web-roas">0x</span></div>
                        <div class="flex justify-between items-center pt-1"><span class="text-gray-400">Profit</span> <span class="text-success font-mono text-lg" id="web-profit">$0</span></div>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <h2 class="text-lg font-semibold mb-4 text-white flex items-center gap-2"><i class="fa-solid fa-chart-line text-indigo-400"></i> Tendencia de Budget</h2>
            <div class="glass-panel p-4 rounded-xl h-[450px]">
                <canvas id="trendsChart"></canvas>
            </div>
        </section>

        <section>
            <h2 class="text-lg font-semibold mb-4 text-white flex items-center gap-2"><i class="fa-solid fa-filter text-gray-400"></i> Métricas de Embudo</h2>
            <div class="overflow-hidden rounded-xl glass-panel">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-white uppercase bg-white/5 tracking-wider">
                        <tr>
                            <th class="px-6 py-4">Funnel</th>
                            <th class="px-6 py-4">Clicks</th>
                            <th class="px-6 py-4">Leads</th>
                            <th class="px-6 py-4">Agendas Creadas</th>
                            <th class="px-6 py-4">Agendas Calif.</th>
                            <th class="px-6 py-4">Shows</th>
                            <th class="px-6 py-4 text-right">Ventas</th>
                        </tr>
                    </thead>
                    <tbody id="funnel-table-body" class="divide-y divide-white/5"></tbody>
                </table>
            </div>
        </section>

        <section>
            <div class="flex flex-col md:flex-row justify-between items-end mb-4 gap-4">
                <h2 class="text-lg font-semibold text-white flex items-center gap-2"><i class="fa-solid fa-coins text-success"></i> Control de Presupuesto (Febrero: 28 días)</h2>
                <div class="text-right glass-panel px-4 py-2 rounded-lg">
                    <p class="text-[10px] text-gray-400 uppercase tracking-wide">Meta Facturación</p>
                    <p class="text-white font-bold font-mono" id="lbl-goal-bottom"></p>
                    <div class="h-px bg-white/10 my-1"></div>
                    <p class="text-[10px] text-gray-400 uppercase tracking-wide">Días Restantes</p>
                    <p id="days-remaining" class="text-accent font-bold text-xl font-mono">0</p>
                </div>
            </div>

            <div id="budget-alert" class="hidden mb-6 p-4 rounded-lg bg-danger/10 border border-danger text-danger text-sm font-bold text-center flex items-center justify-center gap-3 shadow-[0_0_15px_rgba(255,42,109,0.2)]">
                <i class="fa-solid fa-triangle-exclamation text-xl"></i>
                <span id="budget-alert-text">Alerta</span>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="glass-panel rounded-xl p-5 border-t-2 border-t-vsl">
                    <h3 class="font-bold text-white mb-4 flex items-center justify-between">
                        <span>VSL Cold</span>
                        <span class="text-xs text-vsl border border-vsl rounded px-2 py-0.5">33% Rec</span>
                    </h3>
                    <div class="flex items-center gap-2 mb-4">
                        <input type="number" id="input-vsl-perc" oninput="updateBudgetCalc()" value="33" class="w-full p-3 rounded text-center text-xl font-bold bg-gray-900/50 focus:bg-gray-900 focus:border-vsl text-white">
                        <span class="text-gray-400 font-bold">%</span>
                    </div>
                    <div class="space-y-2 text-sm font-mono">
                        <div class="flex justify-between py-1 border-b border-white/5"><span>Asignado</span> <span class="text-white" id="vsl-alloc-total">$0</span></div>
                        <div class="flex justify-between py-1 border-b border-white/5"><span>Gastado</span> <span class="text-gray-400" id="vsl-alloc-spent">$0</span></div>
                        <div class="flex justify-between py-1 border-b border-white/5"><span>Restante</span> <span class="text-success" id="vsl-alloc-rem">$0</span></div>
                        <div class="flex justify-between pt-2"><span class="text-accent font-bold">Diario Sugerido</span> <span class="text-white text-lg font-bold" id="vsl-alloc-daily">$0</span></div>
                    </div>
                </div>

                <div class="glass-panel rounded-xl p-5 border-t-2 border-t-social">
                    <h3 class="font-bold text-white mb-4 flex items-center justify-between">
                        <span>Social Funnel</span>
                        <span class="text-xs text-social border border-social rounded px-2 py-0.5">33% Rec</span>
                    </h3>
                    <div class="flex items-center gap-2 mb-4">
                        <input type="number" id="input-social-perc" oninput="updateBudgetCalc()" value="33" class="w-full p-3 rounded text-center text-xl font-bold bg-gray-900/50 focus:bg-gray-900 focus:border-social text-white">
                        <span class="text-gray-400 font-bold">%</span>
                    </div>
                    <div class="space-y-2 text-sm font-mono">
                        <div class="flex justify-between py-1 border-b border-white/5"><span>Asignado</span> <span class="text-white" id="social-alloc-total">$0</span></div>
                        <div class="flex justify-between py-1 border-b border-white/5"><span>Gastado</span> <span class="text-gray-400" id="social-alloc-spent">$0</span></div>
                        <div class="flex justify-between py-1 border-b border-white/5"><span>Restante</span> <span class="text-success" id="social-alloc-rem">$0</span></div>
                        <div class="flex justify-between pt-2"><span class="text-accent font-bold">Diario Sugerido</span> <span class="text-white text-lg font-bold" id="social-alloc-daily">$0</span></div>
                    </div>
                </div>

                <div class="glass-panel rounded-xl p-5 border-t-2 border-t-webinar">
                    <h3 class="font-bold text-white mb-4 flex items-center justify-between">
                        <span>Webinar Evergreen</span>
                        <span class="text-xs text-webinar border border-webinar rounded px-2 py-0.5">34% Rec</span>
                    </h3>
                    <div class="flex items-center gap-2 mb-4">
                        <input type="number" id="input-web-perc" oninput="updateBudgetCalc()" value="34" class="w-full p-3 rounded text-center text-xl font-bold bg-gray-900/50 focus:bg-gray-900 focus:border-webinar text-white">
                        <span class="text-gray-400 font-bold">%</span>
                    </div>
                    <div class="space-y-2 text-sm font-mono">
                        <div class="flex justify-between py-1 border-b border-white/5"><span>Asignado</span> <span class="text-white" id="web-alloc-total">$0</span></div>
                        <div class="flex justify-between py-1 border-b border-white/5"><span>Gastado</span> <span class="text-gray-400" id="web-alloc-spent">$0</span></div>
                        <div class="flex justify-between py-1 border-b border-white/5"><span>Restante</span> <span class="text-success" id="web-alloc-rem">$0</span></div>
                        <div class="flex justify-between pt-2"><span class="text-accent font-bold">Diario Sugerido</span> <span class="text-white text-lg font-bold" id="web-alloc-daily">$0</span></div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <div id="settings-modal" class="hidden fixed inset-0 bg-black/90 z-50 flex justify-center items-center backdrop-blur-md">
        <div class="glass-panel p-8 rounded-2xl border border-white/10 w-96 shadow-2xl">
            <h3 class="text-2xl font-bold text-white mb-6">Configuración de Mando</h3>
            <p class="text-xs text-gray-500 mb-6">Tus preferencias se guardarán automáticamente.</p>
            
            <div class="mb-5">
                <label class="block text-gray-400 text-sm mb-2 uppercase tracking-wide">Inversión Total Asignada</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><span class="text-gray-500">$</span></div>
                    <input type="number" id="setting-total-budget" class="bg-gray-900/50 border border-gray-700 text-white text-lg rounded-lg focus:border-accent block w-full pl-8 p-3">
                </div>
            </div>

            <div class="mb-8">
                <label class="block text-gray-400 text-sm mb-2 uppercase tracking-wide">Meta de Facturación</label>
                <div class="relative">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none"><span class="text-gray-500">$</span></div>
                    <input type="number" id="setting-revenue-goal" class="bg-gray-900/50 border border-gray-700 text-white text-lg rounded-lg focus:border-accent block w-full pl-8 p-3">
                </div>
            </div>

            <div class="flex justify-end gap-3">
                <button onclick="closeSettings()" class="text-gray-400 hover:text-white text-sm px-6 py-2 transition">Cancelar</button>
                <button onclick="saveSettings()" class="bg-accent hover:bg-cyan-400 text-black font-bold py-2 px-6 rounded-lg shadow-[0_0_15px_#06b6d4] transition">Guardar y Aplicar</button>
            </div>
        </div>
    </div>

    <script>
        const URLS = {
            vsl: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9RFOkjUIr2ffG-X6rHf2SlRH70HgeKaCZYZshyCx4i9IntsZC_tziV5FS5BntZFPrtDAa8MrXhOmU/pub?gid=1309284543&single=true&output=csv',
            social: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9RFOkjUIr2ffG-X6rHf2SlRH70HgeKaCZYZshyCx4i9IntsZC_tziV5FS5BntZFPrtDAa8MrXhOmU/pub?gid=1789645537&single=true&output=csv',
            webinar: 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9RFOkjUIr2ffG-X6rHf2SlRH70HgeKaCZYZshyCx4i9IntsZC_tziV5FS5BntZFPrtDAa8MrXhOmU/pub?gid=846184228&single=true&output=csv'
        };

        const DAYS_IN_MONTH = 28;

        let DATA = { vsl: [], social: [], webinar: [] };
        // Variables iniciales, se sobrescribirán si hay localStorage
        let SETTINGS = { budget: 5000, goal: 15000 };
        
        const currency = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
        const formatNum = (num) => new Intl.NumberFormat('en-US').format(num);
        const parseVal = (val) => {
            if (typeof val === 'number') return val;
            if (!val) return 0;
            return parseFloat(val.toString().replace(/[$,\s%]/g, '')) || 0;
        };

        function findColumn(row, possibleKeywords) {
            const normalizedKeys = Object.keys(row).map(k => ({ original: k, norm: k.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "") }));
            for (let keyword of possibleKeywords) {
                const normKeyword = keyword.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "");
                const match = normalizedKeys.find(k => k.norm.includes(normKeyword));
                if (match) return row[match.original];
            }
            return 0;
        }

        document.addEventListener('DOMContentLoaded', async () => { 
            loadSettings(); // Cargar memoria antes de nada
            await fetchAllData(); 
        });

        // --- FUNCIONES DE MEMORIA (CACHE) ---
        function loadSettings() {
            const savedSettings = localStorage.getItem('vdp_settings');
            if (savedSettings) {
                try {
                    SETTINGS = JSON.parse(savedSettings);
                    console.log("Configuración cargada desde memoria:", SETTINGS);
                } catch (e) {
                    console.error("Error leyendo memoria, usando defaults");
                }
            }
            // Actualizar inputs del modal con los valores (guardados o default)
            document.getElementById('setting-total-budget').value = SETTINGS.budget;
            document.getElementById('setting-revenue-goal').value = SETTINGS.goal;
        }

        function saveSettings() {
            // Obtener valores del input
            const newBudget = parseFloat(document.getElementById('setting-total-budget').value);
            const newGoal = parseFloat(document.getElementById('setting-revenue-goal').value);

            if (newBudget && newGoal) {
                SETTINGS.budget = newBudget;
                SETTINGS.goal = newGoal;
                
                // Guardar en LocalStorage
                localStorage.setItem('vdp_settings', JSON.stringify(SETTINGS));
                
                closeSettings();
                renderDashboard();
                alert("Configuración guardada exitosamente.");
            } else {
                alert("Por favor ingresa valores numéricos válidos.");
            }
        }
        // ------------------------------------

        async function fetchAllData() {
            const fetchCsv = (url) => new Promise((resolve) => {
                Papa.parse(url, {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (results) => resolve(results.data),
                    error: () => resolve([])
                });
            });

            const [vslData, socialData, webinarData] = await Promise.all([
                fetchCsv(URLS.vsl), fetchCsv(URLS.social), fetchCsv(URLS.webinar)
            ]);

            DATA.vsl = vslData; DATA.social = socialData; DATA.webinar = webinarData;

            if(DATA.vsl.length || DATA.social.length) {
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                renderDashboard();
            } else {
                alert("Error: No Data Found");
            }
        }

        function renderDashboard() {
            const metrics = calculateMetrics();
            updateMainKPIs(metrics);
            updateFunnelCards(metrics);
            updateFunnelTable(metrics);
            renderChart(DATA);
            updateBudgetCalc();
        }

        function calculateMetrics() {
            const processSheet = (data) => {
                let spend = 0, rev = 0, sales = 0, clicks = 0, leads = 0, calls = 0, qual = 0, shows = 0;
                data.forEach(row => {
                    spend += parseVal(findColumn(row, ['inversion', 'spend']));
                    rev += parseVal(findColumn(row, ['recolectado', 'revenue']));
                    sales += parseVal(findColumn(row, ['ventas', 'sales']));
                    clicks += parseVal(findColumn(row, ['clicks', 'visitas']));
                    leads += parseVal(findColumn(row, ['leads']));
                    calls += parseVal(findColumn(row, ['agendas creadas']));
                    qual += parseVal(findColumn(row, ['calificadas']));
                    shows += parseVal(findColumn(row, ['asistidas', 'shows']));
                });
                return { spend, rev, sales, clicks, leads, calls, qual, shows };
            };

            const vsl = processSheet(DATA.vsl);
            const social = processSheet(DATA.social);
            const web = processSheet(DATA.webinar);

            return {
                vsl, social, web,
                total: {
                    spend: vsl.spend + social.spend + web.spend,
                    rev: vsl.rev + social.rev + web.rev,
                    sales: vsl.sales + social.sales + web.sales,
                    profit: (vsl.rev + social.rev + web.rev) - (vsl.spend + social.spend + web.spend)
                }
            };
        }

        function updateMainKPIs(metrics) {
            const t = metrics.total;
            const roas = t.spend > 0 ? (t.rev / t.spend) : 0;

            document.getElementById('total-spend').innerText = currency(t.spend);
            document.getElementById('total-revenue').innerText = currency(t.rev);
            document.getElementById('total-profit').innerText = currency(t.profit);
            document.getElementById('total-profit').className = `text-3xl font-bold mt-1 ${t.profit >= 0 ? 'text-success' : 'text-danger'}`;
            document.getElementById('total-roas').innerText = roas.toFixed(2) + 'x';
            document.getElementById('total-sales').innerText = formatNum(t.sales);

            const budgetPerc = Math.min((t.spend / SETTINGS.budget) * 100, 100);
            const goalPerc = Math.min((t.rev / SETTINGS.goal) * 100, 100);

            document.getElementById('lbl-budget-total').innerText = currency(SETTINGS.budget);
            document.getElementById('lbl-spend-perc').innerText = budgetPerc.toFixed(1) + '%';
            document.getElementById('bar-spend').style.width = budgetPerc + '%';
            
            document.getElementById('lbl-goal-total').innerText = currency(SETTINGS.goal);
            document.getElementById('lbl-revenue-perc').innerText = goalPerc.toFixed(1) + '%';
            document.getElementById('bar-revenue').style.width = goalPerc + '%';
            document.getElementById('lbl-goal-bottom').innerText = currency(SETTINGS.goal);
        }

        function updateFunnelCards(metrics) {
            const updateCard = (prefix, data) => {
                const roas = data.spend > 0 ? (data.rev / data.spend) : 0;
                const profit = data.rev - data.spend;
                document.getElementById(`${prefix}-spend`).innerText = currency(data.spend);
                document.getElementById(`${prefix}-rev`).innerText = currency(data.rev);
                document.getElementById(`${prefix}-roas`).innerText = roas.toFixed(2) + 'x';
                document.getElementById(`${prefix}-profit`).innerText = currency(profit);
            };
            updateCard('vsl', metrics.vsl);
            updateCard('social', metrics.social);
            updateCard('web', metrics.web);
        }

        function updateFunnelTable(metrics) {
            const tbody = document.getElementById('funnel-table-body');
            tbody.innerHTML = '';
            const createRow = (name, data, color) => `
                <tr class="hover:bg-white/5 transition duration-200">
                    <td class="px-6 py-4 font-bold text-${color}">${name}</td>
                    <td class="px-6 py-4">${formatNum(data.clicks)}</td>
                    <td class="px-6 py-4">${formatNum(data.leads)}</td>
                    <td class="px-6 py-4">${formatNum(data.calls)}</td>
                    <td class="px-6 py-4">${formatNum(data.qual)}</td>
                    <td class="px-6 py-4">${formatNum(data.shows)}</td>
                    <td class="px-6 py-4 text-right font-bold text-white">${formatNum(data.sales)}</td>
                </tr>`;
            tbody.innerHTML += createRow('VSL', metrics.vsl, 'vsl');
            tbody.innerHTML += createRow('Social Funnel', metrics.social, 'social');
            tbody.innerHTML += createRow('Webinar', metrics.web, 'webinar');
        }

        let chartInstance = null;
        function renderChart(data) {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            const validData = data.vsl.length ? data.vsl : (data.social.length ? data.social : data.webinar);
            const dates = validData.map(row => findColumn(row, ['fecha']) || 'Día X');

            const getSeries = (dataset) => dataset.map(row => parseVal(findColumn(row, ['inversion', 'spend'])));

            const vslS = getSeries(data.vsl);
            const socialS = getSeries(data.social);
            const webS = getSeries(data.webinar);
            
            const totalS = [];
            const suggestedDailyAmount = SETTINGS.budget / DAYS_IN_MONTH; 
            const suggestedS = [];

            const len = Math.max(vslS.length, socialS.length, webS.length);
            for(let i=0; i<len; i++) {
                totalS.push((vslS[i]||0) + (socialS[i]||0) + (webS[i]||0));
                suggestedS.push(suggestedDailyAmount);
            }

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        { label: 'VSL', data: vslS, borderColor: '#d946ef', borderWidth: 2, tension: 0.4, pointRadius: 2, pointBackgroundColor: '#d946ef' },
                        { label: 'Social', data: socialS, borderColor: '#8b5cf6', borderWidth: 2, tension: 0.4, pointRadius: 2, pointBackgroundColor: '#8b5cf6' },
                        { label: 'Webinar', data: webS, borderColor: '#f59e0b', borderWidth: 2, tension: 0.4, pointRadius: 2, pointBackgroundColor: '#f59e0b' },
                        { label: 'TOTAL', data: totalS, borderColor: '#06b6d4', borderWidth: 4, tension: 0.4, pointRadius: 4, pointHoverRadius: 8, pointBackgroundColor: '#06b6d4', shadowColor: '#06b6d4', shadowBlur: 10 },
                        { label: 'Sugerido (Flat)', data: suggestedS, borderColor: '#ffffff', borderWidth: 2, borderDash: [5, 5], pointRadius: 0, tension: 0, alpha: 0.5 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { labels: { color: '#cbd5e1', font: {family: 'Outfit', size: 12} } },
                        tooltip: {
                            backgroundColor: 'rgba(2, 6, 23, 0.95)',
                            titleColor: '#06b6d4',
                            titleFont: { size: 16, family: 'Outfit', weight: 'bold' },
                            bodyColor: '#f8fafc',
                            bodyFont: { size: 13, family: 'Outfit' },
                            padding: 14,
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            boxPadding: 4,
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) label += ': ';
                                    if (context.parsed.y !== null) label += currency(context.parsed.y);
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: {family: 'Outfit'}, callback: (val) => '$' + val } },
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: {family: 'Outfit'}, maxTicksLimit: 10 } }
                    }
                }
            });
        }

        function updateBudgetCalc() {
            const pVsl = parseFloat(document.getElementById('input-vsl-perc').value) || 0;
            const pSocial = parseFloat(document.getElementById('input-social-perc').value) || 0;
            const pWeb = parseFloat(document.getElementById('input-web-perc').value) || 0;
            const totalPerc = pVsl + pSocial + pWeb;

            const alertBox = document.getElementById('budget-alert');
            const alertText = document.getElementById('budget-alert-text');
            alertBox.classList.remove('hidden', 'bg-danger/10', 'border-danger', 'text-danger', 'bg-success/10', 'border-success', 'text-success');
            
            if (Math.abs(totalPerc - 100) > 0.1) {
                alertBox.classList.remove('hidden');
                alertBox.classList.add('bg-danger/10', 'border-danger', 'text-danger');
                alertText.innerHTML = `⚠️ DESBALANCE: La distribución suma <strong>${totalPerc}%</strong> (Debe ser 100%)`;
            } else {
                alertBox.classList.remove('hidden');
                alertBox.classList.add('bg-success/10', 'border-success', 'text-success');
                alertText.innerHTML = `✅ BALANCE PERFECTO: Distribución al 100%`;
            }

            const spentVsl = parseVal(document.getElementById('vsl-spend').innerText);
            const spentSocial = parseVal(document.getElementById('social-spend').innerText);
            const spentWeb = parseVal(document.getElementById('web-spend').innerText);

            const today = new Date();
            const endOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const daysLeft = Math.max(0, endOfMonth.getDate() - today.getDate()); 
            document.getElementById('days-remaining').innerText = daysLeft;

            const calcCard = (prefix, perc, spent) => {
                const allocated = SETTINGS.budget * (perc / 100);
                const remaining = allocated - spent;
                const daily = daysLeft > 0 ? (remaining / daysLeft) : 0;

                document.getElementById(`${prefix}-alloc-total`).innerText = currency(allocated);
                document.getElementById(`${prefix}-alloc-spent`).innerText = currency(spent);
                document.getElementById(`${prefix}-alloc-rem`).innerText = currency(remaining);
                document.getElementById(`${prefix}-alloc-rem`).className = remaining >= 0 ? 'text-success font-bold font-mono' : 'text-danger font-bold font-mono';
                document.getElementById(`${prefix}-alloc-daily`).innerText = currency(daily);
            };

            calcCard('vsl', pVsl, spentVsl);
            calcCard('social', pSocial, spentSocial);
            calcCard('web', pWeb, spentWeb);
        }

        function openSettings() { document.getElementById('settings-modal').classList.remove('hidden'); }
        function closeSettings() { document.getElementById('settings-modal').classList.add('hidden'); }
    </script>
</body>
</html>
